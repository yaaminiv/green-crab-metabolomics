---
title: "04-respirometry-analysis"
author: "Yaamini Venkataraman"
date: '2023-12-18'
output: html_document
---

In this script, I will analyze metabolomics data from the West Coast Metabolomics Center (UC Davis). I will conduct an initial assessment of the data (PLS-DA), understand important metabolites and pathways (VIP analysis and WGCNA), and prepare for additional network analysis through MetaboAnalyst. This workflow and script is modified from [Huffmyer et al. (2023)](https://www.biorxiv.org/content/10.1101/2023.03.20.533475v2.full) and [Trigg et al. (2019)](http://dx.doi.org/10.1038/s41598-019-46947-6).

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../output/05-metabolomics-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, warning = FALSE, message = FALSE}
# if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
# if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
# if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
# if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
# if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
# if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
# if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
# if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
# if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 
# if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages('RColorBrewer') 
# if ("pheatmap" %in% rownames(installed.packages()) == 'FALSE') install.packages('pheatmap') 

require(tidyverse)
require(vegan)
# require(factoextra)
# require(ggfortify)
# require(naniar)
# require(cowplot)
require(mixOmics)
require(RVAideMemoire)
# require(VennDiagram)
require(broom)
require(RColorBrewer)
require(pheatmap)
```

```{r}
source("../../code/biostats.R") #Source multivariate analysis functions
```

```{r}
sessionInfo()
```

# Import data

```{r}
rawMetabolomicsData <- read.csv("../../data/raw_metabolomics_data.csv", header = TRUE) %>% 
  dplyr::rename_with(~stringr::str_replace_all(., "X", "")) #Import data. Remove the "X" prefix for crab IDs
head(rawMetabolomicsData) #Confirm import
```

```{r}
metabolomicsMetadata <- read.csv("../../data/metabolomics_metadata.csv", header = FALSE, strip.white = TRUE) %>% 
  dplyr::rename_with(~stringr::str_replace_all(., "V", "")) %>%
  t(.) %>% as.data.frame(.) %>% 
  purrr::set_names(as.character(dplyr::slice(., 1))) %>%
  dplyr::slice(., -1) %>% 
  mutate(., unite(., "treatment_day", treatment:day, sep = "_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_  3", replacement = "_3")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_ 22", replacement = "_22")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 13_", replacement = "13_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 30_", replacement = "30_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "  5_", replacement = "5_")) #Import metadata. Do not include any header information. Remove "V" from column names. Transform so crab.ID, treatment, and day are all columns. Set the first row in the dataframe as column names, then remove that row.
tail(metabolomicsMetadata) #Confirm import
```

# Format data

Before analyzing the data, I will transform the data and match with treatment metadata. The West Coast Metabolomics Center has already normalized data using the average mTIC (sum of all peak heights for *identified* metabolites) of the samples, and I will not perform any additional normalizations. 

```{r}
transMetabData <- rawMetabolomicsData %>%
  dplyr::select(., -c(2:8)) %>%
  column_to_rownames(., var = "BinBase.name") %>%
  t(.) %>% as.data.frame(.) %>%
  rownames_to_column(., var = "crab.ID") %>% 
  left_join(metabolomicsMetadata, ., by = "crab.ID") #Remove columns with MS information, convert BinBase.name to rownames, and transform dataframe. Convert rownames to crab.ID column
head(transMetabData) #Confirm changes
```

# Initial data investigation with PCA

```{r}
scaled.pca <- prcomp(transMetabData[c(5:601)], scale = TRUE, center = TRUE) #Use prcomp to perform a centered and scaled PCA calculation
summary(scaled.pca) #Standard deviations for each PC
```

```{r PCA interpretation}
pca.eigenval(scaled.pca) #Eigenvalues greater than the broken-stick expectation are considered to explain a statistically significance proportion of the variance in the original dataset. PC3 and PC4 eigenvalue > BSV
ordiMonteRandTest <- ordi.monte(transMetabData[c(5:601)], ord = "pca", dim = 6, plot = FALSE) #Conduct monte carlo randomization test using 1000 random permutations of the input data.
ordiMonteRandTest

#Will move forward with PC1-2
```

## Plot PCA

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Reds")[7],
                brewer.pal(9, "Greys")[7],
                brewer.pal(9, "Blues")[7]) #Create color scheme
```

### All metabolites

```{r}
pcaPlot1 <- autoplot(scaled.pca, data = transMetabData, x = 1, y = 2,
                     size = 3, alpha = 0.8, colour = "treatment", shape = "treatment", 
                     frame = TRUE, frame.colour = "treatment", loadings = FALSE) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)") +
  scale_fill_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                    name = "Temperature (ºC)") +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)") +
  theme_classic(base_size = 15) + theme(legend.position = "right",
                                        plot.background = element_blank()) #Use autoplot to plot the prcomp object. Color points and confidence ellipses by treatment, and have different shapes for each treatment Do not include loadings. Manually define color, fill, and shapes.
pcaPlot1
ggsave("figures/all-data-PCA-treatment.pdf", height = 8.5, width = 11)
```

```{r}
pcaPlot2 <- autoplot(scaled.pca, data = transMetabData, x = 1, y = 2,
                     size = 5, alpha = 0.8, colour = "day", shape = "day",
                     frame = TRUE, frame.colour = "day", loadings = FALSE) +
  scale_color_manual(values = c("black", "purple"),
                     name = "Day") +
  scale_fill_manual(values = c("black", "purple"),
                    name = "Day") +
  scale_shape_manual(values = c(20, 18),
                     name = "Day") +
  theme_classic(base_size = 15) + theme(legend.position = "right",
                                        plot.background = element_blank()) #Same as above but color by day and not treatment
pcaPlot2
ggsave("figures/all-data-PCA-day.pdf", height = 8.5, width = 11)
```

```{r}
pcaPlot3 <- autoplot(scaled.pca, data = transMetabData, x = 1, y = 2,
                     size = 4, alpha = 0.8, colour = "treatment", shape = "day", 
                     frame = TRUE, frame.colour = "treatment", loadings = FALSE) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)") +
  scale_fill_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                    name = "Temperature (ºC)") +
  scale_shape_manual(values = c(20, 18),
                     name = "Day") +
  theme_classic(base_size = 15) + theme(legend.position = "right",
                                        plot.background = element_blank()) #Use autoplot to plot the prcomp object. Color points and confidence ellipses by treatment, and have different shapes for each day. Do not include loadings. Manually define color, fill, and shapes.
pcaPlot3
ggsave("figures/all-data-PCA-day-treatment.pdf", height = 8.5, width = 11)
```

Overall, it seems like metabolite profiles are segregating by treatment, with the 30ºC profiles more segregated from the 5ºC and 13ºC profiles. It also seems like metabolite profiles have higher spread over time, potentially due to the impact of prolonged temperature exposure on physiology.

### Identified metabolites

I'm going to make a very similar PCA to the one above, but only using metabolites identified by the sequencer.

```{r}
scaled.pca.id <- prcomp(transMetabData[c(4:155)], scale = TRUE, center = TRUE) #Use prcomp to perform a centered and scaled PCA calculation
summary(scaled.pca.id) #Standard deviations for each PC
```

```{r}
pcaPlot4 <- autoplot(scaled.pca.id, data = transMetabData, x = 1, y = 2,
                     size = 4, alpha = 0.8, colour = "treatment", shape = "day", 
                     frame = TRUE, frame.colour = "treatment", loadings = FALSE) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                     name = "Temperature (ºC)") +
  scale_fill_manual(values = c(plotColors[3], plotColors[2], plotColors[1]),
                    name = "Temperature (ºC)") +
  scale_shape_manual(values = c(20, 18),
                     name = "Day") +
  theme_classic(base_size = 15) + theme(legend.position = "right",
                                        plot.background = element_blank()) #Use autoplot to plot the prcomp object. Color points and confidence ellipses by treatment, and have different shapes for each day. Do not include loadings. Manually define color, fill, and shapes.
pcaPlot4
ggsave("figures/known-metabolites-PCA-day-treatment.pdf", height = 8.5, width = 11)
```

## Conduct PERMANOVA

I'll use a global permutational multivariate analysis of variance (PERMANOVA) to determine if treatment and day had a significant influence on metabolite profiles. The significant effects from the PCA will be used in the downstream PLS-DA to interrogate trends.

### All metabolites

```{r}
permanova.metab <- adonis2(scale(transMetabData[c(5:601)]) ~ treatment*day, data = transMetabData, method = 'eu') #Conduct global PERMANOVA to assess significance of trends in PCA. Scale metabolomics data and assess influence of treatment, day, and treatment x day on metabolite profiles
permanova.metab #Significant influence of all factors
```

```{r}
broom::tidy(permanova.metab) %>%
  write.csv(., "all-data-PERMANOVA-results.csv", quote = FALSE) #Save PERMANOVA output
```

### Identified metabolites

I'm going to repeat the same analysis, but only look at trends for metabolites identified by the West Coast Metabolomics Center.

```{r}
permanova.metabid <- adonis2(scale(transMetabData[c(5:156)]) ~ treatment*day, data = transMetabData, method = 'eu') #Conduct global PERMANOVA to assess significance of trends in PCA. Scale metabolomics data and assess influence of treatment, day, and treatment x day on metabolite profiles
permanova.metabid #Significant influence of all factors
```

```{r}
broom::tidy(permanova.metab) %>%
  write.csv(., "known-metabolites-PERMANOVA-results.csv", quote = FALSE) #Save PERMANOVA output
```

The fact that all three explanatory variables are significant means that the inclusion of unidentified metabolites doesn't drastically influence the results.

# PLSDA for all metabolites

The next step is for me to conduct a PLS-DA analysis using the `mixOmics` package. This is a more robust way to analyze differences between treatments and is common in many metabolomics studies. Since both temperature and day were significant in the PCA, I'll use both of those factors in the PLSDA.

## Temperature only

I'm still going to run the PLS-DA with temperature only because I suspect the plot will look cleaner this way.

```{r}
X <- log(transMetabData[c(5:601)]) #Assign only metabolite data to the X dataframe after log transformation.
Y <- as.factor(transMetabData$treatment) #Assign treatment data to the Y dataframe
```

```{r}
treatment.plsda <- plsda(X,Y, ncomp = 2) #ncomp = # treatments - 1
plotIndiv(treatment.plsda)
```

```{r}
#pdf("figures/all-data-PLSDA-treatment.pdf", height = 8.5, width = 11)
plotIndiv(treatment.plsda, comp = c(1,2), ind.names = FALSE,
          cex = 3, col = rev(plotColors), pch = c(15, 17, 19), point.lwd = 0.7,
          ellipse = TRUE, star = TRUE, centroid = FALSE, 
          legend = TRUE, legend.title = "Temperature (ºC)", 
          title = "PLS-DA by Temperature", X.label = "Component 1: 14% Explained Variance", size.xlabel = 15, Y.label = "Component 2: 6% Explained Variance", size.ylabel = 15, size.axis = 13,
          style = "ggplot2") #Visualize first two components of PLS-DA with no individual sample names. Alter point size, color, shape, and line width. Include 95% confidence ellipses and use star format to visualize sample distance from centroids. Include a legend and specify the legend title. Specify the plot title and text label sizes. Use ggplot style.
#dev.off()
```

```{r}
pdf("figures/all-data-cimPlot-treatment.pdf", height = 8.5, width = 11)
cim(treatment.plsda, mapping = "Y", row.names = transMetabData$treatment, xlab = "Metabolites", ylab = "Temperature (ºC)", margins = c(8, 5), row.cex = 0.5) #Create CIM plot with metabolites on the x-axis and treatment on the y-axis. 
dev.off()
```

### Extract VIP

The VIP are the metabolites most important for distinguishing between treatments.

```{r}
treatmentVIP <- as.data.frame(PLSDA.VIP(treatment.plsda)[["tab"]]) %>%
  rownames_to_column(., var = "metabolite") #Extract VIP information and save as a dataframe. Convert metabolite rownames to a column. 
head(treatmentVIP) #Confirm changes
```

```{r}
write.csv(treatmentVIP, "all-data-VIP-treatment.csv", quote = FALSE, row.names = FALSE) #Save VIP scores
```

```{r}
treatmentVIP %>%
  filter(VIP >= 1) %>%
  nrow(.) #236 metabolites have VIP > 1
236/596 * 100 #39.6% metabolites VIP > 1
```

```{r}
treatmentVIP %>%
  filter(VIP >= 1) %>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(metabolite, VIP, sum))) +
  geom_point() +
  xlab("VIP Score") + ylab("Metabolite") +
  theme_classic() + theme(axis.text.y = element_text(size = 5)) #Using only metabolites with VIP > 1, arrange by metabolite name and reorder by cumulative VIP score. Plot points and change x and y axis labels.
ggsave("figures/all-data-VIP.pdf", height = 8.5, width = 11)
```
## Temperature x day

```{r}
X <- log(transMetabData[c(5:601)]) #Assign only metabolite data to the X dataframe after log transformation
Y <- as.factor(transMetabData$treatment_day) #Assign treatment data to the Y dataframe
```

```{r}
treatmentday.plsda <- plsda(X,Y, ncomp = 5) #ncomp = # treatments - 1
plotIndiv(treatmentday.plsda)
```
```{r}
#pdf("figures/all-data-PLSDA-day-treatment-comp12.pdf", height = 8.5, width = 11)
plotIndiv(treatmentday.plsda, comp = c(1,2), ind.names = FALSE,
          cex = 3, col = c("lightblue", "#2171B5", "grey80", "#525252", "salmon", "#CB181D"), pch = c(12:17), point.lwd = 0.7,
          ellipse = TRUE, star = TRUE, centroid = FALSE, 
          legend = TRUE, legend.title = "Temperature (ºC) x Day", 
          title = "PLS-DA by Temperature and Day", X.label = "Component 1: 14% Explained Variance", size.xlabel = 15, Y.label = "Component 2: 6% Explained Variance", size.ylabel = 15, size.axis = 13,
          style = "ggplot2") #Visualize first two components of PLS-DA with no individual sample names. Alter point size, color, shape, and line width. Include 95% confidence ellipses and use star format to visualize sample distance from centroids. Include a legend and specify the legend title. Specify the plot title and text label sizes. Use ggplot style.
#dev.off()
```

```{r}
#pdf("figures/all-data-PLSDA-day-treatment-comp13.pdf", height = 8.5, width = 11)
plotIndiv(treatmentday.plsda, comp = c(1,3), ind.names = FALSE,
          cex = 3, col = c("lightblue", "#2171B5", "grey80", "#525252", "salmon", "#CB181D"), pch = c(12:17), point.lwd = 0.7,
          ellipse = TRUE, star = TRUE, centroid = FALSE, 
          legend = TRUE, legend.title = "Temperature (ºC) x Day", 
          title = "PLS-DA by Temperature and Day", X.label = "Component 1: 14% Explained Variance", size.xlabel = 15, Y.label = "Component 3: 11% Explained Variance", size.ylabel = 15, size.axis = 13,
          style = "ggplot2") #Visualize first two components of PLS-DA with no individual sample names. Alter point size, color, shape, and line width. Include 95% confidence ellipses and use star format to visualize sample distance from centroids. Include a legend and specify the legend title. Specify the plot title and text label sizes. Use ggplot style.
#dev.off()
```

```{r}
pdf("figures/all-data-cimPlot-day-treatment.pdf", height = 8.5, width = 11)
cim(treatment.plsda, mapping = "Y", row.names = transMetabData$treatment_day, xlab = "Metabolites", ylab = "Temperature (ºC) x Day", margins = c(8, 5), row.cex = 0.5) #Create CIM plot with metabolites on the x-axis and treatment x day on the y-axis. 
dev.off()
```

### Extract VIP

```{r}
treatmentdayVIP <- as.data.frame(PLSDA.VIP(treatmentday.plsda)[["tab"]]) %>%
  rownames_to_column(., var = "metabolite") #Extract VIP information and save as a dataframe. Convert metabolite rownames to a column.
head(treatmentdayVIP) #Confirm changes
```

```{r}
write.csv(treatmentdayVIP, "all-data-VIP-day-treatment.csv", quote = FALSE, row.names = FALSE) #Save VIP scores
```

```{r}
treatmentdayVIP %>%
  filter(VIP >= 1) %>%
  nrow(.) #251 metabolites have VIP > 1
251/596 * 100 #42.1% metabolites VIP > 1
```

```{r}
treatmentdayVIP %>%
  filter(VIP >= 1) %>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(metabolite, VIP, sum))) +
  geom_point() +
  xlab("VIP Score") + ylab("Metabolite") +
  theme_classic() + theme(axis.text.y = element_text(size = 5)) #Using only metabolites with VIP > 1, arrange by metabolite name and reorder by cumulative VIP score. Plot points and change x and y axis labels.
ggsave("figures/all-data-VIP-day-treatment.pdf", height = 8.5, width = 11)
```

# PLSDA for known features

While I can use the PLSDA with all features to discuss larger patterns and maybe glean insight into functions of unknown metabolites, running the model with only known features will allow me to more confidently assess differences in metabolic pathways due to temperature and time. I will run this PLSDA for both temperature and day.

```{r}
X <- log(transMetabData[c(5:156)]) #Assign known metabolite data to the X dataframe after log transformation
Y <- as.factor(transMetabData$treatment_day) #Assign treatment data to the Y dataframe
```

```{r}
treatmentday.known.plsda <- plsda(X,Y, ncomp = 5) #ncomp = # treatments - 1
plotIndiv(treatmentday.known.plsda)
```

```{r}
#pdf("figures/known-metabolites-PLSDA-day-treatment-comp12.pdf", height = 8.5, width = 11)
plotIndiv(treatmentday.known.plsda, comp = c(1,2), ind.names = FALSE,
          cex = 3, col = c("lightblue", "#2171B5", "grey80", "#525252", "salmon", "#CB181D"), pch = c(12:17), point.lwd = 0.7,
          ellipse = TRUE, star = TRUE, centroid = FALSE, 
          legend = TRUE, legend.title = "Temperature (ºC) x Day", 
          title = "PLS-DA by Temperature and Day", X.label = "Component 1: 12% Explained Variance", size.xlabel = 15, Y.label = "Component 2: 12% Explained Variance", size.ylabel = 15, size.axis = 13,
          style = "ggplot2") #Visualize first two components of PLS-DA with no individual sample names. Alter point size, color, shape, and line width. Include 95% confidence ellipses and use star format to visualize sample distance from centroids. Include a legend and specify the legend title. Specify the plot title and text label sizes. Use ggplot style.
#dev.off()
```

```{r}
#pdf("figures/known-metabolites-PLSDA-day-treatment-comp13.pdf", height = 8.5, width = 11)
plotIndiv(treatmentday.known.plsda, comp = c(1,3), ind.names = FALSE,
          cex = 3, col = c("lightblue", "#2171B5", "grey80", "#525252", "salmon", "#CB181D"), pch = c(12:17), point.lwd = 0.7,
          ellipse = TRUE, star = TRUE, centroid = FALSE, 
          legend = TRUE, legend.title = "Temperature (ºC) x Day", 
          title = "PLS-DA by Temperature and Day", X.label = "Component 1: 12% Explained Variance", size.xlabel = 15, Y.label = "Component 3: 8% Explained Variance", size.ylabel = 15, size.axis = 13,
          style = "ggplot2") #Visualize first two components of PLS-DA with no individual sample names. Alter point size, color, shape, and line width. Include 95% confidence ellipses and use star format to visualize sample distance from centroids. Include a legend and specify the legend title. Specify the plot title and text label sizes. Use ggplot style.
#dev.off()
```

```{r}
pdf("figures/known-metabolites-cimPlot-day-treatment.pdf", height = 8.5, width = 11)
cim(treatmentday.known.plsda, mapping = "Y", row.names = transMetabData$treatment_day, xlab = "Metabolites", ylab = "Temperature (ºC) x Day", margins = c(8, 5), row.cex = 0.5) #Create CIM plot with metabolites on the x-axis and treatment x day on the y-axis. 
dev.off()
```

### Extract VIP

```{r}
treatmentday.known.VIP <- as.data.frame(PLSDA.VIP(treatmentday.known.plsda)[["tab"]]) %>%
  rownames_to_column(., var = "metabolite") #Extract VIP information and save as a dataframe. Convert metabolite rownames to a column.
head(treatmentdayVIP) #Confirm changes
```

```{r}
write.csv(treatmentday.known.VIP, "known-metabolites-VIP-day-treatment.csv", quote = FALSE, row.names = FALSE) #Save VIP scores
```

```{r}
treatmentday.known.VIP %>%
  filter(VIP >= 1) %>%
  nrow(.) #73 metabolites have VIP > 1
73/151 * 100 #48.3% metabolites VIP > 1
```

```{r}
treatmentday.known.VIP %>%
  filter(VIP >= 1) %>%
  arrange(VIP) %>%
  ggplot(aes(x = VIP, y = reorder(metabolite, VIP, sum))) +
  geom_point() +
  xlab("VIP Score") + ylab("Metabolite") +
  theme_classic() + theme(axis.text.y = element_text(size = 8)) #Using only metabolites with VIP > 1, arrange by metabolite name and reorder by cumulative VIP score. Plot points and change x and y axis labels.
ggsave("figures/known-metabolites-VIP-day-treatment.pdf", height = 8.5, width = 11)
```

## Pairwise tests for VIP metabolites

We now know which metabolites are most important for separating days and treatments. However, we do not know specifically which VIP distinguish between which treatment x day contrasts. I will use pairwise t-tests to understand 

### Treatment differences at day 3

#### 13_3 vs. 30_3

```{r}
list <- c("13_3", "30_3") #Assign treatments to examine
```

```{r}
X <- transMetabData %>%
  dplyr::filter(., treatment_day %in% list) %>%
  droplevels() #Filter transMetabData for desired contrasts
Y <- as.factor(X$treatment_day) #Treatments for Y
X <- X[, 5:156] #Retain data only
```

```{r}
known.plsda_13v30_day3 <- plsda(X, Y, ncomp = 5) #Run PLSDA for desired contrast
VIP_13v30_day3 <- as.data.frame(PLSDA.VIP(known.plsda_13v30_day3)[["tab"]]) %>%
  rownames_to_column(., var = "metabolite") %>%
  filter(., VIP >= 1) #Extract VIP list and filter for VIP > 1
```

```{r}
clean_13v30_day3 <- transMetabData %>%
  dplyr::filter(., treatment_day %in% list) %>%
  droplevels() #Filter transMetabData for desired contrasts.
VIP_select_13v30_day3 <- cbind(clean_13v30_day3[, 1:4], 
                               log(clean_13v30_day3[, names(clean_13v30_day3) %in% VIP_13v30_day3$metabolite])) %>%
  pivot_longer(., cols = 5:63, values_to = "log_norm_counts", names_to = "metabolites") %>%
  group_by(., metabolites) #cbind metadata columns (1:4) and log-transformed "clean" data for VIP. Pivot data longer and group by metabolites.
VIP_select_13v30_day3 #Confirm changes
```

```{r}
t.test_13v30_day3 <-do(VIP_select_13v30_day3, tidy(t.test(.$log_norm_counts ~ .$treatment_day,
                 alternative = "two.sided",
                 mu = 0,
                 paired = FALSE,
                 var.equal = FALSE,
                 conf.level = 0.95
                 ))) #Looped t-test for all metabolites with VIP > 1
t.test_13v30_day3$p.adj <- p.adjust(t.test_13v30_day3$p.value, method = c("fdr"), n = length(VIP_13v30_day3$metabolite)) #Adjust p value for the number of comparisons
t.test_13v30_day3
```

```{r}
t.test_13v30_day3 %>%
  ungroup(.) %>%
  filter(., p.adj < 0.05) %>%
  nrow(.) #0 significantly different metabolites
```

#### 13_3 vs. 5_3

### Treatment differences at day 22

#### 13_22 vs. 30_22

#### 13_22 vs. 5_22

### Day differences for each treatment

#### 5_3 vs. 5_22

#### 13_3 vs. 13_22

#### 30_3 vs. 30_22

# Validate PLSDA model

# WCNA analysis for metabolites







