---
title: "07-integration-analysis"
author: "Yaamini Venkataraman"
date: '2024-10-03'
output: html_document
---

In this script, I will integrate the metabolomics and lipidomics analyses. I will do this by correlating WCNA modules and using DIABLO to identify relationships between individual compounds.

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../output/07-integration-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, warning = FALSE, message = FALSE}
# if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse')
# if ("plotrix" %in% rownames(installed.packages()) == 'FALSE') install.packages('plotrix')
# if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan')
# if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify')
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics")
# if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire')
# if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom')
# if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages('RColorBrewer')
# if ("pheatmap" %in% rownames(installed.packages()) == 'FALSE') install.packages('pheatmap')
# if ("genefilter" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("genefilter")
# if ("WGCNA" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('WGCNA')
# if ("dendsort" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('dendsort')
# if ("ComplexHeatmap" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('ComplexHeatmap')
# if ("svglite" %in% rownames(installed.packages()) == 'FALSE') install.packages("svglite")
require(tidyverse)
require(plotrix)
require(vegan)
require(ggfortify)
require(mixOmics)
require(RVAideMemoire)
require(broom)
require(RColorBrewer)
require(pheatmap)
require(genefilter)
require(WGCNA)
require(dendsort)
require(ComplexHeatmap)
require(svglite)
```

```{r}
sessionInfo()
```

```{bash}
mkdir figures
```

# Import and format data

## Metabolomics data

```{r}
attach("../05-metabolomics-analysis/05-metabolomics-analysis.RData") #Attach metabolomics RData
metabolomicsMetadata <- metabolomicsMetadata #Save metadata
transMetabData <- transMetabData #Save transposed data used for PLSDA
rowwiseMetabData <- rowwiseMetabData #Rowwise data used for WCNA
MEsMet <- MEs #Module eigengenes for metabolomics data
moduleTraitCorMet <- moduleTraitCor #Correlations between module eigengenes and treatment (temperature x day)
moduleTraitPvalueMet <- moduleTraitPvalue #P values for correlations between module eigengenes and treatment (temperature x day)
mME_metabolomics <- mME_meta #Data used to create module expression matrix
plotColors <- plotColors #Color scheme for plots

respirationMetabolites <- respirationMetabolites #List of metabolites involved in respiration
calciumSignalingMetabolites <- calciumSignalingMetabolites #List of metabolites involved in calcium signaling
coldProtectionMetabolites <- coldProtectionMetabolites #List of metabolites involved in cold protection

detach("file:../05-metabolomics-analysis/05-metabolomics-analysis.RData") #Detach metabolomics RData
```

```{r}
head(metabolomicsMetadata)
head(transMetabData)
head(rowwiseMetabData)
head(MEsMet)
head(mME_metabolomics)
plotColors
```

## Lipidomics data

```{r}
attach("../06-lipidomics-analysis/06-lipidomics-analysis.RData") #Attach lipidomics RData
lipidomicsMetadata <- lipidomicsMetadata #Save metadata
knownTransLipidData <- knownTransLipidData #Save transposed data used for PLSDA
rowwiseLipidData <- rowwiseLipidData #Rowwise data used for WCNA
MEsLipid <- MEs #Module eigengenes for lipidomics data
moduleTraitCorLipid <- moduleTraitCor #Correlations between module eigengenes and temperature
moduleTraitPvalueLipid <- moduleTraitPvalue #P values for correlations between module eigengenes and temperature
mME_lipidomics <- mME_meta #Data used to create module expression matrix
detach("file:../06-lipidomics-analysis/06-lipidomics-analysis.RData") #Detach lipidomics RData
```

```{r}
head(lipidomicsMetadata)
head(knownTransLipidData)
head(rowwiseLipidData)
head(MEsLipid)
head(moduleTraitCorLipid)
head(moduleTraitPvalueLipid)
head(mME_lipidomics)
```

## Physiology data

### TTR data

```{r}
rawTTR <- read.csv("../../data/time-to-right.csv", header = TRUE) #Import raw data
head(rawTTR) #Confirm import. Trial data is in seconds.
```

```{r}
modTTR <- rawTTR %>%
  mutate(., day = case_when(date == "7/8/22" ~ 4,
                            date == "7/12/22" ~ 8,
                            date == "7/15/22" ~ 11,
                            date == "7/19/22" ~ 15,
                            date == "7/22/22" ~ 18,
                            date == "7/26/22" ~ 22)) %>%
  mutate(., treatment = case_when(treatment.tank == "1" | treatment.tank == "4" ~ "13C",
                                  treatment.tank == "2" | treatment.tank == "5" ~ "5C",
                                  treatment.tank == "3" | treatment.tank == "6" ~ "30C")) %>%
  mutate(., missing.legs = case_when(number.legs < 10 ~ "Y",
                                     number.legs == 10 ~ "N")) %>%
  mutate(., integument.cont = recode(integument.color,
                                     "B" = 0,
                                     "BG" = 0.5,
                                     "G" = 1, 
                                     "YG" = 1.5, 
                                     "Y" = 2, 
                                     "YO" = 2.5 , 
                                     "O" = 3, 
                                     "RO" = 3.5)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  filter(., is.na(TTRSE) == FALSE) %>%
  group_by(., day, treatment) %>%
  mutate(., TTRavgFull = mean(TTRavg)) %>%
  mutate(., TTRSEFull = std.error(TTRavg)) %>%
  mutate(., TTRavgFullLow = TTRavgFull - TTRSEFull) %>%
  mutate(., TTRavgFullHigh = TTRavgFull + TTRSEFull) %>%
  ungroup(.) #Remove sampling ID and notes columns. Add new column with day information. Add new column with treatment information. Create a a new column that with an index for width/length. Create new column as a binary for whether or not crabs are missing legs. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations, and remove rows where TTRavg | TTRSE = NA.  Calculate average and SE for all samples in a treatment for each day. Add/subtract TTRSEFull to/from TTRavgFull to get bounds. Ungroup.
head(modTTR) #Confirm formatting
```

I want to reduce the dataset down to crabs that were sampled. There were some crabs saved in different tubes as indicated in the notes column, but I fixed the tube labels when I sent them off for metabolomics sequencing!

```{r}
modTTRSampled <- modTTR %>%
  filter(is.na(sampling.ID) == FALSE) %>% 
  dplyr::select(-c(date, trial.1:trial.3, carapace.length, notes, TTRavgFull:TTRavgFullHigh)) %>% 
  rename(crab.ID = sampling.ID) %>%
  rename(tank = treatment.tank) %>%
  rename(probe_num = probe.number) %>% 
  mutate(treatment = gsub(pattern = "C", replacement = "", x = treatment) %>% as.factor(.)) %>%
  mutate(day = as.factor(day)) %>% 
  mutate(., unite(., "treatment_day", treatment:day, sep = "_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_  4", replacement = "_4")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_ 22", replacement = "_22")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 13_", replacement = "13_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 30_", replacement = "30_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "  5_", replacement = "5_")) %>%
  mutate(., crab.ID = as.factor(crab.ID)) #Retain only crabs that were sampled and remove any superfluous columns. Rename specific columns to match respirometry data. Change certain columns to characters in order to match with metabolomics/lipidomics data.
head(modTTRSampled) #Confirm formatting
```

### Respirometry data

```{r}
attach("../04-respirometry-analysis/04-respirometry-analysis.RData") #Attach respirometry RData
all_MO2_slope_results_demTTRdata <- all_MO2_slope_results_demTTRdata #Data used for respirometry GLM
detach("file:../04-respirometry-analysis/04-respirometry-analysis.RData") #Detach respirometry RData
```

I want to match crab id with all of the demographic information in the respirometry dataframe.

```{r}
all_MO2_slope_results_sampled <- all_MO2_slope_results_demTTRdata %>%
  mutate(treatment = gsub(pattern = "C", replacement = "", x = treatment) %>% as.factor(.)) %>%
  mutate(., day = case_when(day == "04" ~ "4",
                            day != "04" ~ day) %>%
           as.factor(.)) %>%
  mutate(., unite(., "treatment_day", treatment:day, sep = "_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_  4", replacement = "_4")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_ 22", replacement = "_22")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 13_", replacement = "13_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 30_", replacement = "30_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "  5_", replacement = "5_")) %>%
  filter(., day == "4" | day == "22") %>%
  left_join(., modTTRSampled, by = c("treatment", "day", "treatment_day", "tank", "probe_num", "sex", "integument.cont", "weight", "carapace.width", "missing.legs")) %>%
  dplyr::select(-c(TTRavg:TTRSE, integument.color, number.legs)) %>%
  mutate(., crab.ID = case_when(is.na(crab.ID) == TRUE ~ "304",
                                is.na(crab.ID) == FALSE ~ crab.ID)) #Change treatment, day, and treatment_day columns to match metabolomics/lipidomics datasets. Retain only respirometry data on the days that sampling was done. Join with modTTRSampled by all columns in common to get crab.ID. Remove superfluous columns. Manually change NA crab.ID to 304, since 304 was not included in the TTR data due to not righting.
head(all_MO2_slope_results_sampled) #Confirm formatting
```

# Correlating metabolomics and lipidomics data

To do this, I'll take the module expression information from each analysis and correlate them together!

```{r}
correlationInput <- left_join(mME_metabolomics %>%
                                pivot_wider(., names_prefix = "metabolite_", names_from = "Module", values_from = "value"),
                              mME_lipidomics %>%
                                pivot_wider(., names_prefix = "lipid_", names_from = "Module", values_from = "value"),
                              by = c("crab.ID")) %>%
  dplyr::select(., -c(treatment.y, day.y, treatment_day.y)) %>%
  dplyr::rename("treatment" = treatment.x, "day" = day.x, "treatment_day" = treatment_day.x) %>%
  dplyr::select(., -c("metabolite_1", "metabolite_8", "lipid_13", "lipid_14", "lipid_15"))
#Left join modified versions of module information tables from metabolomics and lipidomics data. Remove duplicate metadata information and rename columns to match standard naming conventions. Remove columns that were not significantly correlated to a treatment condition.
head(correlationInput)
```

```{r}
metabLipidCor <- cor(correlationInput[,5:24], method = "pearson") #Calculate Pearson's correlation coefficients
head(metabLipidCor %>% as.data.frame())
```

```{r}
nSamples <- nrow(rowwiseMetabData)
metabLipidPvalue <- corPvalueStudent(metabLipidCor, nSamples) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue %>% as.data.frame())
```

```{r}
metabLipidCorClean <- as.data.frame(metabLipidCor) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) #Take correlation data and keep columns where metabolite modules and correlated with lipid modules
head(metabLipidCorClean)
```

```{r}
metabLipidPvalueClean <- as.data.frame(metabLipidPvalue) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) #Take p-values and keep columns where metabolite modules and correlated with lipid modules
head(metabLipidPvalueClean)
```

```{r}
#Save dataframes
write.csv(metabLipidCorClean, "metabolite-lipid-module-correlations.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalueClean, "metabolite-lipid-module-pvalues.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalueClean, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCorClean))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCorClean)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCorClean), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

### Repeat without module 0

Module 0 is where the WCNA algorithm places compounds that are not co-expressed with any other compounds. I want to recreate this heatmap without module 0, since I'm interested in co-expressed metabolites that are associated wtih co-expressed lipids to understand pathway-level processes.

```{r}
metabLipidCorClean <- as.data.frame(metabLipidCor) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) #Take correlation data and keep columns where metabolite modules and correlated with lipid modules
head(metabLipidCorClean)
```

```{r}
metabLipidCorNo0 <- metabLipidCorClean %>%
  filter(., rownames(metabLipidCorClean) != "metabolite_0") %>%
  dplyr::select(-lipid_0) #Take dataframe and remove metabolite_0 row and lipid_0 column
head(metabLipidCorNo0) #Confirm changes
```

```{r}
metabLipidPvalueNo0 <- metabLipidPvalueClean %>%
  filter(., rownames(metabLipidPvalueClean) != "metabolite_0") %>%
  dplyr::select(-lipid_0) #Take dataframe and remove metabolite_0 row and lipid_0 column
head(metabLipidPvalueNo0) #Confirm changes
```

```{r}
#Save dataframes
write.csv(metabLipidCorNo0, "metabolite-lipid-module-correlations-no0.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalueNo0, "metabolite-lipid-module-pvalues-no0.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalueNo0, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCorNo0))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCorNo0)))) #Create dendograms for columns
```

```{r}
#pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-no0.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCorNo0), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
#dev.off()
```

Removing these modules doesn't change the overall pattern! I will stick to this version without the null modules.

### Repeat with temperature-specific correlations

Now that I have established correlative relationships between metabolite and lipid modules, I want to understand how those relationships change with changing temperature. To do this, I want to examine these correlations for these same modules, but just using data for 30ºC, 13ºC, or 5ºC.

#### 13ºC

```{r}
metabLipidCor13 <- correlationInput %>%
  mutate(., treatment = gsub(pattern = " 13", replacement = "13", x = treatment)) %>%
  filter(., treatment == "13") %>%
  dplyr::select(., -c(1:4)) %>%
  cor(., method = "pearson") %>%
  as.data.frame(.) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) %>%
  filter(., rownames(.) != "metabolite_0") %>%
  dplyr::select(-lipid_0) %>%
  as.matrix(.) #Take correlation input and filter data for 13ºC. Remove metadata columns and calculate Pearson's correlation coefficients. Convert to dataframe. Keep correlations where lipids are correlated with metabolites. Remove "0" modules. Convert back to a matrix
head(metabLipidCor13 %>% as.data.frame()) #Confirm formatting
```

```{r}
nSamples13 <- nrow(metabolomicsMetadata %>% filter(., treatment == " 13")) #Count the number of samples at 13ºC
metabLipidPvalue13 <- corPvalueStudent(metabLipidCor13, nSamples13) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue13 %>% as.data.frame()) #Confirm output
```

```{r}
#Save dataframes
write.csv(metabLipidCor13, "metabolite-lipid-module-correlations-13.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalue13, "metabolite-lipid-module-pvalues-13.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalue13, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCor13))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCor13)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-13.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCor13), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation at 13ºC",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

#### 30ºC

```{r}
metabLipidCor30 <- correlationInput %>%
  mutate(., treatment = gsub(pattern = " 30", replacement = "30", x = treatment)) %>%
  filter(., treatment == "30") %>%
  dplyr::select(., -c(1:4)) %>%
  cor(., method = "pearson") %>%
  as.data.frame(.) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) %>%
  filter(., rownames(.) != "metabolite_0") %>%
  dplyr::select(-lipid_0) %>%
  as.matrix(.) #Take correlation input and filter data for 30ºC. Remove metadata columns and calculate Pearson's correlation coefficients. Convert to dataframe. Keep correlations where lipids are correlated with metabolites. Remove "0" modules. Convert back to a matrix
head(metabLipidCor30 %>% as.data.frame()) #Confirm formatting
```

```{r}
nSamples30 <- nrow(metabolomicsMetadata %>% filter(., treatment == " 30")) #Count the number of samples at 30ºC
metabLipidPvalue30 <- corPvalueStudent(metabLipidCor30, nSamples30) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue30 %>% as.data.frame()) #Confirm output
```

```{r}
#Save dataframes
write.csv(metabLipidCor30, "metabolite-lipid-module-correlations-30.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalue30, "metabolite-lipid-module-pvalues-30.csv", quote = FALSE, row.names = TRUE)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalue30, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCor30))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCor30)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-30.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCor30), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation at 30ºC",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

#### 5ºC

```{r}
metabLipidCor5 <- correlationInput %>%
  mutate(., treatment = gsub(pattern = "  5", replacement = "5", x = treatment)) %>%
  filter(., treatment == "5") %>%
  dplyr::select(., -c(1:4)) %>%
  cor(., method = "pearson") %>%
  as.data.frame(.) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) %>%
  filter(., rownames(.) != "metabolite_0") %>%
  dplyr::select(-lipid_0) %>%
  as.matrix(.) #Take correlation input and filter data for 5ºC. Remove metadata columns and calculate Pearson's correlation coefficients. Convert to dataframe. Keep correlations where lipids are correlated with metabolites. Remove "0" modules. Convert back to a matrix
head(metabLipidCor5 %>% as.data.frame()) #Confirm formatting
```

```{r}
nSamples5 <- nrow(metabolomicsMetadata %>% filter(., treatment == "  5")) #Count the number of samples at 5ºC
metabLipidPvalue5 <- corPvalueStudent(metabLipidCor5, nSamples5) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue5 %>% as.data.frame()) #Confirm output
```

```{r}
#Save dataframes
write.csv(metabLipidCor5, "metabolite-lipid-module-correlations-5.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalue5, "metabolite-lipid-module-pvalues-5.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalue5, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCor5))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCor5)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-5.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCor5), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation at 5ºC",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

#### Create summary plot

My goal for this summary plot is to have the correlation coefficients for the metabolite x lipid modules across temperature. I will then be able to see if the correlation is primarily influenced by a specific temperature, or if it falls apart at a specific temperature.

```{r}
metabLipidCorNo0 %>%
  rownames_to_column(., var = "metabolite") %>%
  pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_overall") %>%
  left_join(., 
            (metabLipidPvalueNo0 %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_overall")),
            by = c("metabolite", "lipid")) %>%
  filter(., pvalue_overall < 0.05) %>%
  left_join(.,
            (metabLipidCor13 %>%
               as.data.frame(.) %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_13") %>%
               left_join(., 
                         (metabLipidPvalue13 %>%
                            as.data.frame(.) %>%
                            rownames_to_column(., var = "metabolite") %>%
                            pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_13")),
                         by = c("metabolite", "lipid"))),
            by = c("metabolite", "lipid")) %>%
  left_join(.,
            (metabLipidCor30 %>%
               as.data.frame(.) %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_30") %>%
               left_join(., 
                         (metabLipidPvalue30 %>%
                            as.data.frame(.) %>%
                            rownames_to_column(., var = "metabolite") %>%
                            pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_30")),
                         by = c("metabolite", "lipid"))),
            by = c("metabolite", "lipid")) %>%
  left_join(.,
            (metabLipidCor5 %>%
               as.data.frame(.) %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_05") %>%
               left_join(., 
                         (metabLipidPvalue5 %>%
                            as.data.frame(.) %>%
                            rownames_to_column(., var = "metabolite") %>%
                            pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_05")),
                         by = c("metabolite", "lipid"))),
            by = c("metabolite", "lipid")) %>%
  pivot_longer(.,
               cols = 3:10,
               names_to = c(".value", "condition"),
               names_pattern = "(.*)_(.*)") %>%
  ggplot(., aes(x = condition, y = correlation, color = condition, shape = condition)) +
  geom_point(size = 3) +
  facet_grid(metabolite ~ lipid, scales = "free_y") +
  labs(y = "Pearson's Correlation Coefficient") +
  scale_color_manual(name = "Condition",
                     values = c(rev(plotColors), "black"), 
                     labels = c("5ºC", "13ºC", "30ºC", "Overall")) +
  scale_shape_manual(values = c(15, 19, 17, 3),
                     name = "Condition",
                     labels = c("5ºC", "13ºC", "30ºC", "Overall")) +
  theme_classic(base_size = 15) + theme(axis.title.x = element_blank(),
                                        axis.ticks.x = element_blank(),
                                        axis.text.x = element_blank(),
                                        strip.background = element_rect(colour = "white")) #Take original correlation data and use a series of left_joins to merge with correlation data for each specific temperature that has already been pivoted longer. Finally, combine all correlation data into a single column and all p-value information into a single column using a specific regex pattern. Use information in a ggplot.
ggsave("figures/metabolte-lipid-module-relationship-correlations.pdf", height = 8.5, width = 11)
```

# Correlating physiology and -omics data

## WCNA

The next step is to add physiology information to the metabolomics and lipidomics WCNA analyses. I want to correlate metabolite and lipid profiles with average TTR and respirometry data on the days the crabs were dissected. I'm going to do this in three steps:

1. Metabolomics and lipidomics WCNAs separately, correlate with physiology data only
2. Metabolomics and lipidomics WCNAs separately, correlate with physiology and temperature data
3. Combined metabolomics and lipidomics WCNAs

```{bash}
mkdir WCNA

mkdir WCNA/metabolomics
mkdir WCNA/metabolomics/figures

mkdir WCNA/lipidomics
mkdir WCNA/lipidomics/figures
```

### Correlate separate metabolomics and lipidomics WCNAs with physiology only

#### Modify trait matrix

```{r}
datTraitsPhysOnly <- metabolomicsMetadata %>%
  mutate(., day = gsub(x = day, pattern = 3, replacement = 4) %>% as.factor(.)) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_3", replacement = "_4") %>% as.factor(.)) %>%
  left_join(x = ., 
            y = (modTTRSampled %>% 
                   dplyr::select(c(crab.ID, treatment_day, TTRavg, TTRSE))), 
            by = c("crab.ID", "treatment_day")) %>%
  left_join(x = ., 
            y = all_MO2_slope_results_sampled %>%
              dplyr::select(c(crab.ID, treatment_day, slope_nmol_hr_corrected)), 
            by = c("crab.ID", "treatment_day")) %>%
  arrange(., crab.ID) %>%
  dplyr::select(-c(treatment:treatment_day, TTRSE)) %>%
  column_to_rownames(., var = "crab.ID") %>% 
  rename(., "Average TTR" = TTRavg) %>%
  mutate(., "Oxygen Consumption" = -slope_nmol_hr_corrected) %>%
  dplyr::select(-slope_nmol_hr_corrected)
#Take metadata and fix day to day 4 instead of day 3. Join with TTR data. 304, 308, and 506 do not have TTR data because they failed to right. Join with respirometry data (only select crabs have accompanying respirometry data). Use a series of case_when commands to create individual columns for each treatment or day, with 1 indicating that sample is part of the group, and 0 indicating that sample is not part of the group. Remove previous treatment classification columns and TTRSE column. Convert crab.ID to rownames. Rename TTR column. Make oxygen consumption -slope, and then remove slope column.
head(datTraitsPhysOnly) #Confirm dataframe creation
nrow(datTraitsPhysOnly) == nrow(rowwiseMetabData) #Confirm that there are the same number of rows (samples) between the new trait matrix and the metabolite data
```

#### Metabolomics

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorMetPhysOnly <- cor(MEsMet, datTraitsPhysOnly, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueMetPhysOnly <- WGCNA::corPvalueStudent(moduleTraitCorMetPhysOnly, nSamples) #Get p-values for correlations
head(moduleTraitCorMetPhysOnly %>% as.data.frame())
head(moduleTraitPvalueMetPhysOnly %>% as.data.frame())
```

```{r}
moduleTraitTreeMetPhysOnly <- hclust(dist(t(moduleTraitCorMetPhysOnly)), method = "average") #Create cluster dendogram for module-trait correlations
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixMetPhysOnly <- paste(signif(moduleTraitCorMetPhysOnly, 2), "\n(",signif(moduleTraitPvalueMetPhysOnly, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixMetPhysOnly) <- dim(moduleTraitCorMetPhysOnly) #Ensure this matrix has the appropriate dimensions
head(textMatrixMetPhysOnly) #Confirm matrix creation
```

```{r}
pdf("WCNA/metabolomics/figures/module-trait-relationships-physOnly.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorMetPhysOnly, xLabels = names(datTraitsPhysOnly),  yLabels = names(MEsMet), ySymbols = names(MEsMet), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixMetPhysOnly, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalMetPhysOnly <- signif(moduleTraitPvalueMetPhysOnly, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendMetPhysOnly <- dendsort(hclust(dist(moduleTraitCorMetPhysOnly))) #Create dendograms for rows
col_dendMetPhysOnly <- dendsort(hclust(dist(t(moduleTraitCorMetPhysOnly)))) #Create dendograms for columns

trait_orderMetPhysOnly <- c("Average TTR", "Oxygen Consumption") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/metabolomics/figures/module-trait-relationship-heatmap-physOnly.pdf", height = 8.5, width = 8.5)
htMetPhysOnly <- Heatmap(moduleTraitCorMetPhysOnly, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                         col = blueWhiteRed(50), 
                         row_names_side = "left", 
                         row_dend_side = "left",
                         width = unit(5, "in"), 
                         height = unit(4.5, "in"), 
                         column_dend_reorder = TRUE, 
                         cluster_columns = col_dendMetPhysOnly,
                         row_dend_reorder = FALSE,  
                         #column_split = 3, 
                         #row_split = 3, 
                         #column_dend_height = unit(.5, "in"),
                         cluster_rows = row_dendMetPhysOnly, 
                         #column_order = trait_order, 
                         #row_gap = unit(2.5, "mm"), 
                         border = TRUE,
                         cell_fun = function(j, i, x, y, w, h, col) {
                           if(heatmappvalMetPhysOnly[i, j] < 0.05) {
                             grid.text(sprintf("%s", heatmappvalMetPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                           }
                           else {
                             grid.text(sprintf("%s", heatmappvalMetPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                           }},
                         column_names_rot = 45,
                         column_names_gp =  gpar(fontsize = 12, border = FALSE),
                         column_title_gp = gpar(fontsize = 20),
                         row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htMetPhysOnly) #Draw heatmap
dev.off()
```

#### Lipidomics

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorLipidPhysOnly <- cor(MEsLipid, datTraitsPhysOnly, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueLipidPhysOnly <- WGCNA::corPvalueStudent(moduleTraitCorLipidPhysOnly, nSamples) #Get p-values for correlations
head(moduleTraitCorLipidPhysOnly %>% as.data.frame())
head(moduleTraitPvalueLipidPhysOnly %>% as.data.frame())
```

```{r}
moduleTraitTreeLipidPhysOnly <- hclust(dist(t(moduleTraitCorLipidPhysOnly)), method = "average") #Create cluster dendogram for module-trait correlations
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixLipidPhysOnly <- paste(signif(moduleTraitCorLipidPhysOnly, 2), "\n(",signif(moduleTraitPvalueLipidPhysOnly, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixLipidPhysOnly) <- dim(moduleTraitCorLipidPhysOnly) #Ensure this matrix has the appropriate dimensions
head(textMatrixLipidPhysOnly) #Confirm matrix creation
```

```{r}
pdf("WCNA/lipidomics/figures/module-trait-relationships-physOnly.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorLipidPhysOnly, xLabels = names(datTraitsPhysOnly),  yLabels = names(MEsLipid), ySymbols = names(MEsLipid), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixLipidPhysOnly, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalLipidPhysOnly <- signif(moduleTraitPvalueLipidPhysOnly, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendLipidPhysOnly <- dendsort(hclust(dist(moduleTraitCorLipidPhysOnly))) #Create dendograms for rows
col_dendLipidPhysOnly <- dendsort(hclust(dist(t(moduleTraitCorLipidPhysOnly)))) #Create dendograms for columns

trait_orderLipidPhysOnly <- c("Average TTR", "Oxygen Consumption") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/lipidomics/figures/module-trait-relationship-heatmap-physOnly.pdf", height = 8.5, width = 8.5)
htLipidPhysOnly <- Heatmap(moduleTraitCorLipidPhysOnly, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                           col = blueWhiteRed(50), 
                           row_names_side = "left", 
                           row_dend_side = "left",
                           width = unit(5, "in"), 
                           height = unit(4.5, "in"), 
                           column_dend_reorder = TRUE, 
                           cluster_columns = col_dendLipidPhysOnly,
                           row_dend_reorder = FALSE,  
                           #column_split = 3, 
                           #row_split = 3, 
                           #column_dend_height = unit(.5, "in"),
                           cluster_rows = row_dendLipidPhysOnly, 
                           #column_order = trait_order, 
                           #row_gap = unit(2.5, "mm"), 
                           border = TRUE,
                           cell_fun = function(j, i, x, y, w, h, col) {
                             if(heatmappvalLipidPhysOnly[i, j] < 0.05) {
                               grid.text(sprintf("%s", heatmappvalLipidPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                             }
                             else {
                               grid.text(sprintf("%s", heatmappvalLipidPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                             }},
                           column_names_rot = 45,
                           column_names_gp =  gpar(fontsize = 12, border = FALSE),
                           column_title_gp = gpar(fontsize = 20),
                           row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htLipidPhysOnly) #Draw heatmap
dev.off()
```

### Correlate separate metabolomics and lipidomics WCNAs with physiology, temperature, and day

#### Metabolomics

##### Modify trait matrix

The trait matricies for metabolomics and lipidomics will be separate since the interaction between temperature x day was significant for metabolites, and only temperature was significant for lipids.

```{r}
datTraitsPhysTemp <- metabolomicsMetadata %>%
  mutate(., day = gsub(x = day, pattern = 3, replacement = 4) %>% as.factor(.)) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_3", replacement = "_4") %>% as.factor(.)) %>%
  left_join(x = ., 
            y = (modTTRSampled %>% 
                   dplyr::select(c(crab.ID, treatment_day, TTRavg, TTRSE))), 
            by = c("crab.ID", "treatment_day")) %>%
  left_join(x = ., 
            y = all_MO2_slope_results_sampled %>%
              dplyr::select(c(crab.ID, treatment_day, slope_nmol_hr_corrected)), 
            by = c("crab.ID", "treatment_day")) %>%
  arrange(., crab.ID) %>%
  mutate(., "13ºC at Day 4" = case_when(treatment_day == "13_4" ~ 1,
                                        treatment_day != "13_4" ~ 0)) %>%
  mutate(., "5ºC at Day 4" = case_when(treatment_day == "5_4" ~ 1,
                                       treatment_day != "5_4" ~ 0)) %>%
  mutate(., "30ºC at Day 4" = case_when(treatment_day == "30_4" ~ 1,
                                        treatment_day != "30_4" ~ 0)) %>%
  mutate(., "13ºC at Day 22" = case_when(treatment_day == "13_22" ~ 1,
                                         treatment_day != "13_22" ~ 0)) %>%
  mutate(., "5ºC at Day 22" = case_when(treatment_day == "5_22" ~ 1,
                                        treatment_day != "5_22" ~ 0)) %>%
  mutate(., "30ºC at Day 22" = case_when(treatment_day == "30_22" ~ 1,
                                         treatment_day != "30_22" ~ 0)) %>%
  dplyr::select(-c(treatment:treatment_day, TTRSE)) %>%
  column_to_rownames(., var = "crab.ID") %>% 
  rename(., "Average TTR" = TTRavg) %>%
  rename(., "Oxygen Consumption" = slope_nmol_hr_corrected)
#Take metadata and fix day to day 4 instead of day 3. Join with TTR data. 304, 308, and 506 do not have TTR data because they failed to right. Join with respirometry data (only select crabs have accompanying respirometry data). Use a series of case_when commands to create individual columns for each treatment or day, with 1 indicating that sample is part of the group, and 0 indicating that sample is not part of the group. Remove previous treatment classification columns and TTRSE column. Convert crab.ID to rownames. Rename TTR and respirometry columns
head(datTraitsPhysTemp) #Confirm dataframe creation
nrow(datTraitsPhysTemp) == nrow(rowwiseMetabData) #Confirm that there are the same number of rows (samples) between the new trait matrix and the metabolite data
```

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorMetPhysTemp <- cor(MEsMet, datTraitsPhysTemp, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueMetPhysTemp <- WGCNA::corPvalueStudent(moduleTraitCorMetPhysTemp, nSamples) #Get p-values for correlations
head(moduleTraitCorMetPhysTemp %>% as.data.frame())
head(moduleTraitPvalueMetPhysTemp %>% as.data.frame())
```

```{r}
moduleTraitTreeMetPhysTemp <- hclust(dist(t(moduleTraitCorMetPhysTemp)), method = "average") #Create cluster dendogram for module-trait correlations
```

```{r}
# pdf(file = "WCNA/metabolomics/figures/module-trait-cluster-dendogram-physTemp.pdf", height = 8.5, width = 11)
plot(moduleTraitTreeMetPhysTemp) #Plot cluster dendogram
# dev.off()
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixMetPhysTemp <- paste(signif(moduleTraitCorMetPhysTemp, 2), "\n(",signif(moduleTraitPvalueMetPhysTemp, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixMetPhysTemp) <- dim(moduleTraitCorMetPhysTemp) #Ensure this matrix has the appropriate dimensions
head(textMatrixMetPhysTemp) #Confirm matrix creation
```

```{r}
pdf("WCNA/metabolomics/figures/module-trait-relationships-physTemp.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorMetPhysTemp, xLabels = names(datTraitsPhysTemp),  yLabels = names(MEsMet), ySymbols = names(MEsMet), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixMetPhysTemp, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalMetPhysTemp <- signif(moduleTraitPvalueMetPhysTemp, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendMetPhysTemp <- dendsort(hclust(dist(moduleTraitCorMetPhysTemp))) #Create dendograms for rows
col_dendMetPhysTemp <- dendsort(hclust(dist(t(moduleTraitCorMetPhysTemp)))) #Create dendograms for columns

trait_orderMetPhysTemp <- c("Average TTR", "Oxygen Consumption", "5ºC at Day 3", "13ºC at Day 3", "30ºC at Day 3", "5ºC at Day 22", "13ºC at Day 22", "30ºC at Day 22") #Order of traits for heatmap
```

```{r}
#pdf(file = "WCNA/metabolomics/figures/module-trait-relationship-heatmap-physTemp.pdf", height = 8.5, width = 8.5)
htMetPhysTemp <- Heatmap(moduleTraitCorMetPhysTemp, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                         col = blueWhiteRed(50), 
                         row_names_side = "left", 
                         row_dend_side = "left",
                         width = unit(5, "in"), 
                         height = unit(4.5, "in"), 
                         column_dend_reorder = TRUE, 
                         cluster_columns = col_dendMetPhysTemp,
                         row_dend_reorder = FALSE,  
                         #column_split = 3, 
                         #row_split = 3, 
                         #column_dend_height = unit(.5, "in"),
                         cluster_rows = row_dendMetPhysTemp, 
                         #column_order = trait_order, 
                         #row_gap = unit(2.5, "mm"), 
                         border = TRUE,
                         cell_fun = function(j, i, x, y, w, h, col) {
                           if(heatmappvalMetPhysTemp[i, j] < 0.05) {
                             grid.text(sprintf("%s", heatmappvalMetPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                           }
                           else {
                             grid.text(sprintf("%s", heatmappvalMetPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                           }},
                         column_names_rot = 45,
                         column_names_gp =  gpar(fontsize = 12, border = FALSE),
                         column_title_gp = gpar(fontsize = 20),
                         row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htMetPhysTemp) #Draw heatmap
#dev.off()
```

##### Append existing correlation information

I noticed that the treatment x module eigengene correlations I got from this analysis were different from when I did just temperature. However, the correlations between physiology and module eigengenes were the same. This could be because I am using a different R version than I was for the original WCNA analysis. I'm going to try appending the physiology correlations to the previous treatment correlations to see if that removes the inconsistency.

```{r}
moduleTraitCorMetAppend <- moduleTraitCorMet %>%
  as.data.frame(.) %>%
  rename("13ºC at Day 4" = "13ºC at Day 3") %>%
  rename("30ºC at Day 4" = "30ºC at Day 3") %>%
  rename("5ºC at Day 4" = "5ºC at Day 3") %>% 
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitCorMetPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Rename columns and convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitCorMetAppend #Confirm matrix creation
```

```{r}
moduleTraitPvalueMetAppend <- moduleTraitPvalueMet %>%
  as.data.frame(.) %>%
  rename("13ºC at Day 4" = "13ºC at Day 3") %>%
  rename("30ºC at Day 4" = "30ºC at Day 3") %>%
  rename("5ºC at Day 4" = "5ºC at Day 3") %>% 
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitPvalueMetPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Rename columns and convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitPvalueMetAppend #Confirm matrix creation
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalMetAppend <- signif(moduleTraitPvalueMetAppend, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendMetAppend <- dendsort(hclust(dist(moduleTraitCorMetAppend))) #Create dendograms for rows
col_dendMetAppend <- dendsort(hclust(dist(t(moduleTraitCorMetAppend)))) #Create dendograms for columns

trait_orderMetAppend <- c("Average TTR", "Oxygen Consumption", "5ºC at Day 3", "13ºC at Day 3", "30ºC at Day 3", "5ºC at Day 22", "13ºC at Day 22", "30ºC at Day 22") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/metabolomics/figures/module-trait-relationship-heatmap-append.pdf", height = 8.5, width = 8.5)
htMetAppend <- Heatmap(moduleTraitCorMetAppend, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                       col = blueWhiteRed(50), 
                       row_names_side = "left", 
                       row_dend_side = "left",
                       width = unit(5, "in"), 
                       height = unit(4.5, "in"), 
                       column_dend_reorder = FALSE, 
                       cluster_columns = FALSE,
                       row_dend_reorder = FALSE,  
                       column_split = c(rep("A", times = 6), rep("B", times = 2)), 
                       column_gap = unit(3, "mm"),
                       #row_split = 3, 
                       #column_dend_height = unit(.5, "in"),
                       cluster_rows = row_dendMetAppend, 
                       #row_gap = unit(2.5, "mm"), 
                       border = TRUE,
                       cell_fun = function(j, i, x, y, w, h, col) {
                         if(heatmappvalMetAppend[i, j] < 0.05) {
                           grid.text(sprintf("%s", heatmappvalMetAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                         }
                         else {
                           grid.text(sprintf("%s", heatmappvalMetAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                         }},
                       column_names_rot = 45,
                       column_names_gp =  gpar(fontsize = 12, border = FALSE),
                       column_title_gp = gpar(fontsize = 20),
                       row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htMetAppend) #Draw heatmap
dev.off()
```

#### Lipidomics

##### Modify trait matrix

```{r}
datTraitsPhysTempLipid <- lipidomicsMetadata %>%
  dplyr::select(-c(day:treatment_day)) %>%
  left_join(x = ., 
            y = (modTTRSampled %>% 
                   dplyr::select(c(crab.ID, treatment, TTRavg, TTRSE))), 
            by = c("crab.ID", "treatment")) %>%
  left_join(x = ., 
            y = all_MO2_slope_results_sampled %>%
              dplyr::select(c(crab.ID, treatment, slope_nmol_hr_corrected)), 
            by = c("crab.ID", "treatment")) %>%
  arrange(., crab.ID) %>%
  mutate(., "13ºC" = case_when(treatment == "13" ~ 1,
                               treatment != "13" ~ 0)) %>%
  mutate(., "5ºC" = case_when(treatment == "5" ~ 1,
                              treatment != "5" ~ 0)) %>%
  mutate(., "30ºC" = case_when(treatment == "30" ~ 1,
                               treatment != "30" ~ 0)) %>%
  dplyr::select(-c(treatment, TTRSE)) %>%
  column_to_rownames(., var = "crab.ID") %>% 
  rename(., "Average TTR" = TTRavg) %>%
  rename(., "Oxygen Consumption" = slope_nmol_hr_corrected) #Take metadata join with TTR data. 304, 308, and 506 do not have TTR data because they failed to right. Join with respirometry data (only select crabs have accompanying respirometry data). Use a series of case_when commands to create individual columns for each treatment, with 1 indicating that sample is part of the group, and 0 indicating that sample is not part of the group. Remove previous treatment classification columns and TTRSE column. Convert crab.ID to rownames. Rename TTR and respirometry columns
head(datTraitsPhysTempLipid) #Confirm dataframe creation
nrow(datTraitsPhysTempLipid) == nrow(rowwiseLipidData) #Confirm that there are the same number of rows (samples) between the new trait matrix and the metabolite data
```

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorLipidPhysTemp <- cor(MEsLipid, datTraitsPhysTempLipid, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueLipidPhysTemp <- WGCNA::corPvalueStudent(moduleTraitCorLipidPhysTemp, nSamples) #Get p-values for correlations
head(moduleTraitCorLipidPhysTemp %>% as.data.frame())
head(moduleTraitPvalueLipidPhysTemp %>% as.data.frame())
```

```{r}
moduleTraitTreeLipidPhysTemp <- hclust(dist(t(moduleTraitCorLipidPhysTemp)), method = "average") #Create cluster dendogram for module-trait correlations
```

```{r}
pdf(file = "WCNA/lipidomics/figures/module-trait-cluster-dendogram-physTemp.pdf", height = 8.5, width = 11)
plot(moduleTraitTreeLipidPhysTemp) #Plot cluster dendogram
dev.off()
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixLipidPhysTemp <- paste(signif(moduleTraitCorLipidPhysTemp, 2), "\n(",signif(moduleTraitPvalueLipidPhysTemp, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixLipidPhysTemp) <- dim(moduleTraitCorLipidPhysTemp) #Ensure this matrix has the appropriate dimensions
head(textMatrixLipidPhysTemp) #Confirm matrix creation
```

```{r}
pdf("WCNA/lipidomics/figures/module-trait-relationships-physTemp.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorLipidPhysTemp, xLabels = names(datTraitsPhysTempLipid),  yLabels = names(MEsLipid), ySymbols = names(MEsLipid), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixLipidPhysTemp, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalLipidPhysTemp <- signif(moduleTraitPvalueLipidPhysTemp, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendLipidPhysTemp <- dendsort(hclust(dist(moduleTraitCorLipidPhysTemp))) #Create dendograms for rows
col_dendLipidPhysTemp <- dendsort(hclust(dist(t(moduleTraitCorLipidPhysTemp)))) #Create dendograms for columns

trait_orderLipidPhysTemp <- c("Average TTR", "Oxygen Consumption", "5ºC", "13ºC", "30ºC") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/lipidomics/figures/module-trait-relationship-heatmap-physTemp.pdf", height = 8.5, width = 8.5)
htLipidPhysTemp <- Heatmap(moduleTraitCorLipidPhysTemp, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                           col = blueWhiteRed(50), 
                           row_names_side = "left", 
                           row_dend_side = "left",
                           width = unit(5, "in"), 
                           height = unit(4.5, "in"), 
                           column_dend_reorder = TRUE, 
                           cluster_columns = col_dendLipidPhysTemp,
                           row_dend_reorder = FALSE,  
                           #column_split = 3, 
                           #row_split = 3, 
                           #column_dend_height = unit(.5, "in"),
                           cluster_rows = row_dendLipidPhysTemp, 
                           #column_order = trait_order, 
                           #row_gap = unit(2.5, "mm"), 
                           border = TRUE,
                           cell_fun = function(j, i, x, y, w, h, col) {
                             if(heatmappvalLipidPhysTemp[i, j] < 0.05) {
                               grid.text(sprintf("%s", heatmappvalLipidPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                             }
                             else {
                               grid.text(sprintf("%s", heatmappvalLipidPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                             }},
                           column_names_rot = 45,
                           column_names_gp =  gpar(fontsize = 12, border = FALSE),
                           column_title_gp = gpar(fontsize = 20),
                           row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htLipidPhysTemp) #Draw heatmap
dev.off()
```

##### Append existing correlation information

```{r}
moduleTraitCorLipidAppend <- moduleTraitCorLipid %>%
  as.data.frame(.) %>%
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitCorLipidPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitCorLipidAppend #Confirm matrix creation
```

```{r}
moduleTraitPvalueLipidAppend <- moduleTraitPvalueLipid %>%
  as.data.frame(.) %>%
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitPvalueLipidPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitPvalueLipidAppend #Confirm matrix creation
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalLipidAppend <- signif(moduleTraitPvalueLipidAppend, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendLipidAppend <- dendsort(hclust(dist(moduleTraitCorLipidAppend))) #Create dendograms for rows
col_dendLipidAppend <- dendsort(hclust(dist(t(moduleTraitCorLipidAppend)))) #Create dendograms for columns

trait_orderLipidAppend <- c("Average TTR", "Oxygen Consumption", "5ºC", "13º", "30ºC") #Order of traits for heatmap
```

```{r}
#pdf(file = "WCNA/lipidomics/figures/module-trait-relationship-heatmap-append.pdf", height = 8.5, width = 8.5)
htLipidAppend <- Heatmap(moduleTraitCorLipidAppend, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                         col = blueWhiteRed(50), 
                         row_names_side = "left", 
                         row_dend_side = "left",
                         width = unit(5, "in"), 
                         height = unit(4.5, "in"), 
                         column_dend_reorder = FALSE, 
                         cluster_columns = FALSE,
                         row_dend_reorder = FALSE,  
                         column_split = c(rep("A", times = 3), rep("B", times = 2)), 
                         column_gap = unit(3, "mm"),
                         #row_split = 3, 
                         #column_dend_height = unit(.5, "in"),
                         cluster_rows = row_dendLipidAppend, 
                         #row_gap = unit(2.5, "mm"), 
                         border = TRUE,
                         cell_fun = function(j, i, x, y, w, h, col) {
                           if(heatmappvalLipidAppend[i, j] < 0.05) {
                             grid.text(sprintf("%s", heatmappvalLipidAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                           }
                           else {
                             grid.text(sprintf("%s", heatmappvalLipidAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                           }},
                         column_names_rot = 45,
                         column_names_gp =  gpar(fontsize = 12, border = FALSE),
                         column_title_gp = gpar(fontsize = 20),
                         row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htLipidAppend) #Draw heatmap
#dev.off()
```

### Interpret correlations between physiology and module eigengenes

Moving forward, I'm going to focus on the version where I appended physiology information onto the existing WCNA data. My next step is to understand what the significant correlations mean! I will do this in a few steps:

1. Identify molecules present in module eigengenes that were significantly correlated with physiology traits
2. Identify VIP molecules present in significantly correlated module eigengenes
3. Identify major pathways present in significantly correlated modules

#### Metabolomics

Righting response was not significantly correlated with any module.

Oxygen consumption was positively correlated with ME5. ME5 had a negative correlation with 30ºC on boy days 4 and 22, as well as a positive correlation with 5ºC on day 22. Respiration was also negatively correlated with ME0, which was negatively correlated with 5ºC on day 22 and positively correlated with 30ºC on day 22.

##### Identify metabolites present in significant modules

```{r}
module0_metabolites <- read.csv("../05-metabolomics-analysis/metaboanalyst/module0_metabolites.csv") #Import list of metabolites in module 0
module5_metabolites <- read.csv("../05-metabolomics-analysis/metaboanalyst/module5_metabolites.csv") #Import list of metabolites in module 5
```

##### Identify VIP in significant modules

```{r}
VIP_module0 <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module0") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, module) #Import list of VIP in module 0. Retain columns of interest
VIP_module0
```

```{r}
VIP_module5 <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module5") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, module) #Import list of VIP in module 5. Retain columns of interest
VIP_module5
```

##### Identify pathways represented in the significant modules

###### VIP enrihcment pathways 

```{r}
module0_pairwiseVIPpathway <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-pairwise-VIP-pathways.txt", sep = "\t") %>%
  filter(., module == "module0") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, pathway, module) #Import list of VIP in module 0. Retain columns of interest
module0_pairwiseVIPpathway
```

```{r}
module5_pairwiseVIPpathway <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-pairwise-VIP-pathways.txt", sep = "\t") %>%
  filter(., module == "module5") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, pathway, module) #Import list of VIP in module 0. Retain columns of interest
module5_pairwiseVIPpathway
```

###### A priori pathways

```{r}
rbind(module0_metabolites %>%
        filter(., Metabolite %in% respirationMetabolites) %>%
        mutate(., category = "respiration", module = "module0"), #5 respiration metabolites
      module0_metabolites %>%
        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
        mutate(., category = "calciumSignaling", module = "module0"), #3 calcium
      module0_metabolites %>%
        filter(., Metabolite %in% coldProtectionMetabolites) %>%
        mutate(., category = "coldProtection", module = "module0") #0 cold protection
) #Identify metabolites involved in various pre-ordained pathways
```

```{r}
rbind(module5_metabolites %>%
        filter(., Metabolite %in% respirationMetabolites) %>%
        mutate(., category = "respiration", module = "module5"), #0 respiration metabolites
      module5_metabolites %>%
        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
        mutate(., category = "calciumSignaling", module = "module5"), #2 calcium
      module5_metabolites %>%
        filter(., Metabolite %in% coldProtectionMetabolites) %>%
        mutate(., category = "coldProtection", module = "module5") #0 cold protection
) #Identify metabolites involved in various pre-ordained pathways
```

###### Metaboanalyst pathway enrichment

I used Metaboanalyst as a tool to get pathway information for the metabolites in modules 0 and 5.

Module 0: phosphoinositol, n-epsilon-trimethyllysine, and isothreonic acid not included

Module 5: ribose-5-phosphate not included

While there were no significantly enriched pathways in module 0, module 5 had several relating to valine and phenylalanine biosynthesis and metabolism.

```{r}
#Create lists of metabolites involved in significant pathways. Some names have spaces afterwards to reflect naming conventions in original dataframe
valineBiosynthesis <- c("threonine", "isoleucine ", "leucine", "2-ketoisocaproic acid", "valine ")
phenylalanineBiosynthesis <- c("phenylalanine", "tyrosine")
phenylalanineMetabolism <- c("phenylalanine", "tyrosine")
valineDegradation <- c("isoleucine ", "leucine", "valine ")
```

##### Combine all information

```{r}
module0_annotations <- module0_metabolites %>%
  dplyr::rename(metabolite = Metabolite) %>%
  left_join(., y = VIP_module0 %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = "metabolite", names_from = "comparison", values_from = "comparison"), 
            by = "metabolite") %>%
  left_join(., y = module0_pairwiseVIPpathway %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = c("metabolite", "pathway"), names_from = "comparison", values_from = "comparison"), 
            by = c("metabolite", "day2213v5")) %>%
  left_join(x = ., 
            y = rbind(module0_metabolites %>%
                        filter(., Metabolite %in% respirationMetabolites) %>%
                        mutate(., category = "respiration"),
                      module0_metabolites %>%
                        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
                        mutate(., category = "calciumSignaling"),
                      module0_metabolites %>%
                        filter(., Metabolite %in% coldProtectionMetabolites) %>%
                        mutate(., category = "coldProtection")) %>%
              dplyr::rename(metabolite = "Metabolite") %>%
              pivot_wider(., id_cols = "metabolite", names_from = "category", values_from = "category"), 
            by = "metabolite") %>%
  mutate(., respiration = case_when(is.na(respiration) == TRUE ~ 0,
                                    is.na(respiration) == FALSE ~ 1)) %>%
  mutate(., calciumSignaling = case_when(is.na(calciumSignaling) == TRUE ~ 0,
                                         is.na(calciumSignaling) == FALSE ~ 1)) %>%
  mutate(., coldProtection = 0) %>%
  mutate(., day2213v30 = case_when(is.na(day2213v30) == TRUE ~ 0,
                                   is.na(day2213v30) == FALSE ~ 1)) %>%
  mutate(., day2213v5 = case_when(is.na(day2213v5) == TRUE ~ 0,
                                  is.na(day2213v5) == FALSE ~ 1)) #Take module metabolite information and join with modified VIP information, enrichment information, and a priori pathway information.
head(module0_annotations) #Confirm dataframe creation
```

```{r}
module5_annotations <- module5_metabolites %>%
  dplyr::rename(metabolite = Metabolite) %>%
  left_join(., y = VIP_module5 %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = "metabolite", names_from = "comparison", values_from = "comparison"), 
            by = "metabolite") %>%
  mutate(., day2213v5 = 0) %>%
  left_join(., y = module5_pairwiseVIPpathway %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = c("metabolite", "pathway"), names_from = "comparison", values_from = "comparison"), 
            by = c("metabolite", "day2213v30")) %>%
  left_join(x = ., 
            y = rbind(module5_metabolites %>%
                        filter(., Metabolite %in% respirationMetabolites) %>%
                        mutate(., category = "respiration"),
                      module5_metabolites %>%
                        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
                        mutate(., category = "calciumSignaling"),
                      module5_metabolites %>%
                        filter(., Metabolite %in% coldProtectionMetabolites) %>%
                        mutate(., category = "coldProtection")) %>%
              dplyr::rename(metabolite = "Metabolite") %>%
              pivot_wider(., id_cols = "metabolite", names_from = "category", values_from = "category"), 
            by = "metabolite") %>%
  mutate(., respiration = 0) %>%
  mutate(., calciumSignaling = case_when(is.na(calciumSignaling) == TRUE ~ 0,
                                         is.na(calciumSignaling) == FALSE ~ 1)) %>%
  mutate(., coldProtection = 0) %>%
  mutate(., day2213v30 = case_when(is.na(day2213v30) == TRUE ~ 0,
                                   is.na(day2213v30) == FALSE ~ 1)) %>%
  left_join(x = .,
            y = rbind(module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% valineBiosynthesis) %>%
                        mutate(., physPathway = "valineBiosynthesisPhys"), 
                      module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% phenylalanineBiosynthesis) %>%
                        mutate(., physPathway = "phenylalanineBiosynthesisPhys"), 
                      module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% phenylalanineMetabolism) %>%
                        mutate(., physPathway = "phenylalanineMetabolismPhys"), module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% valineDegradation) %>%
                        mutate(., physPathway = "valineDegradationPhys")) %>%
              pivot_wider(., id_cols = "metabolite", names_from = "physPathway", values_from = "physPathway"),
            by = "metabolite") %>%
  mutate(., valineBiosynthesisPhys = case_when(is.na(valineBiosynthesisPhys) == TRUE ~ 0,
                                              is.na(valineBiosynthesisPhys) == FALSE ~ 1)) %>%
  mutate(., phenylalanineBiosynthesisPhys = case_when(is.na(phenylalanineBiosynthesisPhys) == TRUE ~ 0,
                                              is.na(phenylalanineBiosynthesisPhys) == FALSE ~ 1)) %>%
    mutate(., phenylalanineMetabolismPhys = case_when(is.na(phenylalanineMetabolismPhys) == TRUE ~ 0,
                                              is.na(phenylalanineMetabolismPhys) == FALSE ~ 1)) %>%
    mutate(., valineDegradationPhys = case_when(is.na(valineDegradationPhys) == TRUE ~ 0,
                                              is.na(valineDegradationPhys) == FALSE ~ 1)) #Take module metabolite information and join with modified VIP information, enrichment information, and a priori pathway information.
head(module5_annotations) #Confirm dataframe creation
```

```{r}
#Save annotation dataframes
write.csv(module0_annotations, "WCNA/metabolomics/module0_annotations.csv", quote = FALSE, row.names = FALSE)
write.csv(module5_annotations, "WCNA/metabolomics/module5_annotations.csv", quote = FALSE, row.names = FALSE)
```

Valine biosynthesis, phenylalanine biosynthesis, phenylalanine metabolism, and valine degradation seem to play an important role in temperature regulation of respiration! I will need to explore this further.

#### Lipidomics

Righting response:

- Negative correlation with ME15
- Negative correlation with ME3, which was also negatively correlated with 5ºC and oxgygen consumption, and positively correlated with 30ºC
- Negative correlation with ME6, which was positively correlated with 30ºC

Oxygen consumption:

- Negative correlation with ME5, which was negatively correlated with 30ºC
- Positive correlation with ME9, which was positively correlated with 5ºC and negatively correlated with 30ºC
- Positive correlation with ME0, which was positively correlated with 5ºC
- Negative correlation with ME3, which was was negatively correlated with 5ºC and righting response, and positively correlated with 30ºC

For interpretation, I need to keep in mind that the correlations were with slope, not -slope (what I ended up plotting). That means the larger the negative number, the more oxygen was being consumed. 

- Positive correlation: lipid concentrations increased as slope became more positive (less consumption)
- Negative correlation: lipid concentrations decreased as slope became more positive (less consumption)

FOR CLARITY'S SAKE: DO CORRELATIONS WITH NEGATIVE SLOPE

I will focus on modules 0, 3, 5, 6, 9, and 15.

##### Identify metabolites present in significant modules

```{r}
module0_metabolites <- read.csv("../05-metabolomics-analysis/metaboanalyst/module0_metabolites.csv") #Import list of metabolites in module 0
module5_metabolites <- read.csv("../05-metabolomics-analysis/metaboanalyst/module5_metabolites.csv") #Import list of metabolites in module 5
```

##### Identify VIP in significant modules

```{r}
VIP_module0 <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module0") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, module) #Import list of VIP in module 0. Retain columns of interest
VIP_module0
```

```{r}
VIP_module5 <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module5") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, module) #Import list of VIP in module 5. Retain columns of interest
VIP_module5
```


### Combined metabolomics and lipidomics WCNs with physiology, temperature, and day

## ASCA

## Individual metabolite and lipid correlations with DIABLO

Do correlations with VIP from significantly correlated modules?



