---
title: "07-integration-analysis"
author: "Yaamini Venkataraman"
date: '2024-10-03'
output: html_document
---

In this script, I will integrate the metabolomics and lipidomics analyses. I will do this by correlating WCNA modules and using DIABLO to identify relationships between individual compounds.

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../output/07-integration-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, warning = FALSE, message = FALSE}
# if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse')
# if ("plotrix" %in% rownames(installed.packages()) == 'FALSE') install.packages('plotrix')
# if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan')
# if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify')
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics")
# if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire')
# if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom')
# if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages('RColorBrewer')
# if ("pheatmap" %in% rownames(installed.packages()) == 'FALSE') install.packages('pheatmap')
# if ("genefilter" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("genefilter")
# if ("WGCNA" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('WGCNA')
# if ("dendsort" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('dendsort')
# if ("ComplexHeatmap" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install('ComplexHeatmap')
# if ("svglite" %in% rownames(installed.packages()) == 'FALSE') install.packages("svglite")
# if ("svglite" %in% rownames(installed.packages()) == 'FALSE') install.packages("svglite")
# if ("patchwork" %in% rownames(installed.packages()) == 'FALSE') install.packages("patchwork")
require(tidyverse)
require(plotrix)
require(vegan)
require(ggfortify)
require(mixOmics)
require(RVAideMemoire)
require(broom)
require(RColorBrewer)
require(pheatmap)
require(genefilter)
require(WGCNA)
require(dendsort)
require(ComplexHeatmap)
require(svglite)
require(patchwork)
```

```{r}
sessionInfo()
```

```{bash}
mkdir figures
```

# Import and format data

## Metabolomics data

```{r}
attach("../05-metabolomics-analysis/05-metabolomics-analysis.RData") #Attach metabolomics RData
rawMetabolomicsData <- rawMetabolomicsData #Save raw metabolomics data from sequencer
metabolomicsMetadata <- metabolomicsMetadata #Save metadata
transMetabData <- transMetabData #Save transposed data used for PLSDA

rowwiseMetabData <- rowwiseMetabData #Rowwise data used for WCNA
MEsMet <- MEs #Module eigengenes for metabolomics data
moduleTraitCorMet <- moduleTraitCor #Correlations between module eigengenes and treatment (temperature x day)
moduleTraitPvalueMet <- moduleTraitPvalue #P values for correlations between module eigengenes and treatment (temperature x day)
mME_metabolomics <- mME_meta #Data used to create module expression matrix
plotColors <- plotColors #Color scheme for plots

respirationMetabolites <- respirationMetabolites #List of metabolites involved in respiration
calciumSignalingMetabolites <- calciumSignalingMetabolites #List of metabolites involved in calcium signaling
coldProtectionMetabolites <- coldProtectionMetabolites #List of metabolites involved in cold protection

detach("file:../05-metabolomics-analysis/05-metabolomics-analysis.RData") #Detach metabolomics RData
```

```{r}
head(rawMetabolomicsData)
head(metabolomicsMetadata)
head(transMetabData)
head(rowwiseMetabData)
head(MEsMet)
head(mME_metabolomics)
plotColors
```

## Lipidomics data

```{r}
attach("../06-lipidomics-analysis/06-lipidomics-analysis.RData") #Attach lipidomics RData
rawLipidomicsData <- rawLipidomicsData
lipidIdentifiers <- lipidIdentifiers
lipidomicsMetadata <- lipidomicsMetadata #Save metadata
knownTransLipidData <- knownTransLipidData #Save transposed data used for PLSDA

rowwiseLipidData <- rowwiseLipidData #Rowwise data used for WCNA
MEsLipid <- MEs #Module eigengenes for lipidomics data
moduleTraitCorLipid <- moduleTraitCor #Correlations between module eigengenes and temperature
moduleTraitPvalueLipid <- moduleTraitPvalue #P values for correlations between module eigengenes and temperature
mME_lipidomics <- mME_meta #Data used to create module expression matrix

significantVIP_13v30_annot <- significantVIP_13v30_annot #VIP annotated with lipid class and saturation state
significantVIP_13v5_annot <- significantVIP_13v5_annot #VIP annotated with lipid class and saturation state

detach("file:../06-lipidomics-analysis/06-lipidomics-analysis.RData") #Detach lipidomics RData
```

```{r}
head(rawLipidomicsData)
head(lipidIdentifiers)
head(lipidomicsMetadata)
head(knownTransLipidData)
head(rowwiseLipidData)
head(MEsLipid)
head(moduleTraitCorLipid)
head(moduleTraitPvalueLipid)
head(mME_lipidomics)
```

```{r}
#Create lists of metabolites involved in significant pathways. 
valineBiosynthesis <- c("threonine", "isoleucine", "leucine", "2-ketoisocaproic acid", "valine")
arginineBiosynthesis <- c("alpha-ketoglutarate", "glutamate", "citrulline", "ornithine", "urea", "fumaric acid")
glutathioneMetabolism <- c("glycine", "oxoproline", "glutamate", "ornithine", "putrescine", "cadaverine")
alanineMetabolism <- c("asparagine", "fumaric acid", "alanine", "alpha-ketoglutarate", "glutamate")
```

## Physiology data

### TTR data

```{r}
rawTTR <- read.csv("../../data/time-to-right.csv", header = TRUE) #Import raw data
head(rawTTR) #Confirm import. Trial data is in seconds.
```

```{r}
modTTR <- rawTTR %>%
  mutate(., day = case_when(date == "7/8/22" ~ 4,
                            date == "7/12/22" ~ 8,
                            date == "7/15/22" ~ 11,
                            date == "7/19/22" ~ 15,
                            date == "7/22/22" ~ 18,
                            date == "7/26/22" ~ 22)) %>%
  mutate(., treatment = case_when(treatment.tank == "1" | treatment.tank == "4" ~ "13C",
                                  treatment.tank == "2" | treatment.tank == "5" ~ "5C",
                                  treatment.tank == "3" | treatment.tank == "6" ~ "30C")) %>%
  mutate(., missing.legs = case_when(number.legs < 10 ~ "Y",
                                     number.legs == 10 ~ "N")) %>%
  mutate(., integument.cont = recode(integument.color,
                                     "B" = 0,
                                     "BG" = 0.5,
                                     "G" = 1, 
                                     "YG" = 1.5, 
                                     "Y" = 2, 
                                     "YO" = 2.5 , 
                                     "O" = 3, 
                                     "RO" = 3.5)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  filter(., is.na(TTRSE) == FALSE) %>%
  group_by(., day, treatment) %>%
  mutate(., TTRavgFull = mean(TTRavg)) %>%
  mutate(., TTRSEFull = std.error(TTRavg)) %>%
  mutate(., TTRavgFullLow = TTRavgFull - TTRSEFull) %>%
  mutate(., TTRavgFullHigh = TTRavgFull + TTRSEFull) %>%
  ungroup(.) #Remove sampling ID and notes columns. Add new column with day information. Add new column with treatment information. Create a a new column that with an index for width/length. Create new column as a binary for whether or not crabs are missing legs. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations, and remove rows where TTRavg | TTRSE = NA.  Calculate average and SE for all samples in a treatment for each day. Add/subtract TTRSEFull to/from TTRavgFull to get bounds. Ungroup.
head(modTTR) #Confirm formatting
```

I want to reduce the dataset down to crabs that were sampled. There were some crabs saved in different tubes as indicated in the notes column, but I fixed the tube labels when I sent them off for metabolomics sequencing!

```{r}
modTTRSampled <- modTTR %>%
  filter(is.na(sampling.ID) == FALSE) %>% 
  dplyr::select(-c(date, trial.1:trial.3, carapace.length, notes, TTRavgFull:TTRavgFullHigh)) %>% 
  rename(crab.ID = sampling.ID) %>%
  rename(tank = treatment.tank) %>%
  rename(probe_num = probe.number) %>% 
  mutate(treatment = gsub(pattern = "C", replacement = "", x = treatment) %>% as.factor(.)) %>%
  mutate(day = as.factor(day)) %>% 
  mutate(., unite(., "treatment_day", treatment:day, sep = "_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_  4", replacement = "_4")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_ 22", replacement = "_22")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 13_", replacement = "13_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 30_", replacement = "30_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "  5_", replacement = "5_")) %>%
  mutate(., crab.ID = as.factor(crab.ID)) #Retain only crabs that were sampled and remove any superfluous columns. Rename specific columns to match respirometry data. Change certain columns to characters in order to match with metabolomics/lipidomics data.
head(modTTRSampled) #Confirm formatting
```

### Respirometry data

```{r}
attach("../04-respirometry-analysis/04-respirometry-analysis.RData") #Attach respirometry RData
all_MO2_slope_results_demTTRdata <- all_MO2_slope_results_demTTRdata #Data used for respirometry GLM
detach("file:../04-respirometry-analysis/04-respirometry-analysis.RData") #Detach respirometry RData
```

I want to match crab id with all of the demographic information in the respirometry dataframe.

```{r}
all_MO2_slope_results_sampled <- all_MO2_slope_results_demTTRdata %>%
  mutate(treatment = gsub(pattern = "C", replacement = "", x = treatment) %>% as.factor(.)) %>%
  mutate(., day = case_when(day == "04" ~ "4",
                            day != "04" ~ day) %>%
           as.factor(.)) %>%
  mutate(., unite(., "treatment_day", treatment:day, sep = "_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_  4", replacement = "_4")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_ 22", replacement = "_22")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 13_", replacement = "13_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = " 30_", replacement = "30_")) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "  5_", replacement = "5_")) %>%
  filter(., day == "4" | day == "22") %>%
  left_join(., modTTRSampled, by = c("treatment", "day", "treatment_day", "tank", "probe_num", "sex", "integument.cont", "weight", "carapace.width", "missing.legs")) %>%
  dplyr::select(-c(TTRavg:TTRSE, integument.color, number.legs)) %>%
  mutate(., crab.ID = case_when(is.na(crab.ID) == TRUE ~ "304",
                                is.na(crab.ID) == FALSE ~ crab.ID)) #Change treatment, day, and treatment_day columns to match metabolomics/lipidomics datasets. Retain only respirometry data on the days that sampling was done. Join with modTTRSampled by all columns in common to get crab.ID. Remove superfluous columns. Manually change NA crab.ID to 304, since 304 was not included in the TTR data due to not righting.
head(all_MO2_slope_results_sampled) #Confirm formatting
```

# Correlating metabolomics and lipidomics data

To do this, I'll take the module expression information from each analysis and correlate them together!

```{r}
correlationInput <- left_join(mME_metabolomics %>%
                                pivot_wider(., names_prefix = "metabolite_", names_from = "Module", values_from = "value"),
                              mME_lipidomics %>%
                                pivot_wider(., names_prefix = "lipid_", names_from = "Module", values_from = "value"),
                              by = c("crab.ID")) %>%
  dplyr::select(., -c(treatment.y, day.y, treatment_day.y)) %>%
  dplyr::rename("treatment" = treatment.x, "day" = day.x, "treatment_day" = treatment_day.x) %>%
  dplyr::select(., -c("metabolite_1", "metabolite_8", "lipid_13", "lipid_14", "lipid_15"))
#Left join modified versions of module information tables from metabolomics and lipidomics data. Remove duplicate metadata information and rename columns to match standard naming conventions. Remove columns that were not significantly correlated to a treatment condition.
head(correlationInput)
```

```{r}
metabLipidCor <- cor(correlationInput[,5:24], method = "pearson") #Calculate Pearson's correlation coefficients
head(metabLipidCor %>% as.data.frame())
```

```{r}
nSamples <- nrow(rowwiseMetabData)
metabLipidPvalue <- corPvalueStudent(metabLipidCor, nSamples) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue %>% as.data.frame())
```

```{r}
metabLipidCorClean <- as.data.frame(metabLipidCor) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) #Take correlation data and keep columns where metabolite modules and correlated with lipid modules
head(metabLipidCorClean)
```

```{r}
metabLipidPvalueClean <- as.data.frame(metabLipidPvalue) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) #Take p-values and keep columns where metabolite modules and correlated with lipid modules
head(metabLipidPvalueClean)
```

```{r}
#Save dataframes
write.csv(metabLipidCorClean, "metabolite-lipid-module-correlations.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalueClean, "metabolite-lipid-module-pvalues.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalueClean, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCorClean))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCorClean)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCorClean), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

### Repeat without module 0

Module 0 is where the WCNA algorithm places compounds that are not co-expressed with any other compounds. I want to recreate this heatmap without module 0, since I'm interested in co-expressed metabolites that are associated wtih co-expressed lipids to understand pathway-level processes.

```{r}
metabLipidCorClean <- as.data.frame(metabLipidCor) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) #Take correlation data and keep columns where metabolite modules and correlated with lipid modules
head(metabLipidCorClean)
```

```{r}
metabLipidCorNo0 <- metabLipidCorClean %>%
  filter(., rownames(metabLipidCorClean) != "metabolite_0") %>%
  dplyr::select(-lipid_0) #Take dataframe and remove metabolite_0 row and lipid_0 column
head(metabLipidCorNo0) #Confirm changes
```

```{r}
metabLipidPvalueNo0 <- metabLipidPvalueClean %>%
  filter(., rownames(metabLipidPvalueClean) != "metabolite_0") %>%
  dplyr::select(-lipid_0) #Take dataframe and remove metabolite_0 row and lipid_0 column
head(metabLipidPvalueNo0) #Confirm changes
```

```{r}
#Save dataframes
write.csv(metabLipidCorNo0, "metabolite-lipid-module-correlations-no0.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalueNo0, "metabolite-lipid-module-pvalues-no0.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalueNo0, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCorNo0))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCorNo0)))) #Create dendograms for columns
```

```{r}
#pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-no0.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCorNo0), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
#dev.off()
```

Removing these modules doesn't change the overall pattern! I will stick to this version without the null modules.

### Repeat with temperature-specific correlations

Now that I have established correlative relationships between metabolite and lipid modules, I want to understand how those relationships change with changing temperature. To do this, I want to examine these correlations for these same modules, but just using data for 30ºC, 13ºC, or 5ºC.

#### 13ºC

```{r}
metabLipidCor13 <- correlationInput %>%
  mutate(., treatment = gsub(pattern = " 13", replacement = "13", x = treatment)) %>%
  filter(., treatment == "13") %>%
  dplyr::select(., -c(1:4)) %>%
  cor(., method = "pearson") %>%
  as.data.frame(.) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) %>%
  filter(., rownames(.) != "metabolite_0") %>%
  dplyr::select(-lipid_0) %>%
  as.matrix(.) #Take correlation input and filter data for 13ºC. Remove metadata columns and calculate Pearson's correlation coefficients. Convert to dataframe. Keep correlations where lipids are correlated with metabolites. Remove "0" modules. Convert back to a matrix
head(metabLipidCor13 %>% as.data.frame()) #Confirm formatting
```

```{r}
nSamples13 <- nrow(metabolomicsMetadata %>% filter(., treatment == " 13")) #Count the number of samples at 13ºC
metabLipidPvalue13 <- corPvalueStudent(metabLipidCor13, nSamples13) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue13 %>% as.data.frame()) #Confirm output
```

```{r}
#Save dataframes
write.csv(metabLipidCor13, "metabolite-lipid-module-correlations-13.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalue13, "metabolite-lipid-module-pvalues-13.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalue13, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCor13))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCor13)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-13.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCor13), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation at 13ºC",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

#### 30ºC

```{r}
metabLipidCor30 <- correlationInput %>%
  mutate(., treatment = gsub(pattern = " 30", replacement = "30", x = treatment)) %>%
  filter(., treatment == "30") %>%
  dplyr::select(., -c(1:4)) %>%
  cor(., method = "pearson") %>%
  as.data.frame(.) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) %>%
  filter(., rownames(.) != "metabolite_0") %>%
  dplyr::select(-lipid_0) %>%
  as.matrix(.) #Take correlation input and filter data for 30ºC. Remove metadata columns and calculate Pearson's correlation coefficients. Convert to dataframe. Keep correlations where lipids are correlated with metabolites. Remove "0" modules. Convert back to a matrix
head(metabLipidCor30 %>% as.data.frame()) #Confirm formatting
```

```{r}
nSamples30 <- nrow(metabolomicsMetadata %>% filter(., treatment == " 30")) #Count the number of samples at 30ºC
metabLipidPvalue30 <- corPvalueStudent(metabLipidCor30, nSamples30) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue30 %>% as.data.frame()) #Confirm output
```

```{r}
#Save dataframes
write.csv(metabLipidCor30, "metabolite-lipid-module-correlations-30.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalue30, "metabolite-lipid-module-pvalues-30.csv", quote = FALSE, row.names = TRUE)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalue30, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCor30))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCor30)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-30.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCor30), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation at 30ºC",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

#### 5ºC

```{r}
metabLipidCor5 <- correlationInput %>%
  mutate(., treatment = gsub(pattern = "  5", replacement = "5", x = treatment)) %>%
  filter(., treatment == "5") %>%
  dplyr::select(., -c(1:4)) %>%
  cor(., method = "pearson") %>%
  as.data.frame(.) %>%
  dplyr::select(., starts_with("lipid_")) %>%
  filter(., row_number() %in% 1:7) %>%
  filter(., rownames(.) != "metabolite_0") %>%
  dplyr::select(-lipid_0) %>%
  as.matrix(.) #Take correlation input and filter data for 5ºC. Remove metadata columns and calculate Pearson's correlation coefficients. Convert to dataframe. Keep correlations where lipids are correlated with metabolites. Remove "0" modules. Convert back to a matrix
head(metabLipidCor5 %>% as.data.frame()) #Confirm formatting
```

```{r}
nSamples5 <- nrow(metabolomicsMetadata %>% filter(., treatment == "  5")) #Count the number of samples at 5ºC
metabLipidPvalue5 <- corPvalueStudent(metabLipidCor5, nSamples5) #Calculate p-values for metabolite-lipid module correlations
head(metabLipidPvalue5 %>% as.data.frame()) #Confirm output
```

```{r}
#Save dataframes
write.csv(metabLipidCor5, "metabolite-lipid-module-correlations-5.csv", quote = FALSE, row.names = TRUE)
write.csv(metabLipidPvalue5, "metabolite-lipid-module-pvalues-5.csv", quote = FALSE, row.names = TRUE)
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappval <- signif(metabLipidPvalue5, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dend <- dendsort(hclust(dist(metabLipidCor5))) #Create dendograms for rows
col_dend <- dendsort(hclust(dist(t(metabLipidCor5)))) #Create dendograms for columns
```

```{r}
pdf(file = "figures/metabolite-lipid-module-relationship-heatmap-5.pdf", height = 8.5, width = 8.5)
ht <- Heatmap(as.matrix(metabLipidCor5), name = "Eigengene", column_title = "Metabolomics-Lipidomics Eigengene Correlation at 5ºC",
              col = blueWhiteRed(50), 
              row_names_side = "left", 
              row_dend_side = "left",
              width = unit(5, "in"), 
              height = unit(4.5, "in"), 
              column_dend_reorder = TRUE, 
              cluster_columns = col_dend,
              row_dend_reorder = FALSE,  
              #column_split = 3, 
              #row_split = 3, 
              #column_dend_height = unit(.5, "in"),
              cluster_rows = row_dend, 
              #row_gap = unit(2.5, "mm"), 
              border = TRUE,
              cell_fun = function(j, i, x, y, w, h, col) {
                if(heatmappval[i, j] < 0.05) {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                }
                else {
                  grid.text(sprintf("%s", heatmappval[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                }},
              column_names_rot = 45,
              column_names_gp =  gpar(fontsize = 12, border = FALSE),
              column_title_gp = gpar(fontsize = 20),
              row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(ht) #Draw heatmap
dev.off()
```

#### Create summary plot

My goal for this summary plot is to have the correlation coefficients for the metabolite x lipid modules across temperature. I will then be able to see if the correlation is primarily influenced by a specific temperature, or if it falls apart at a specific temperature.

```{r}
metabLipidCorNo0 %>%
  rownames_to_column(., var = "metabolite") %>%
  pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_overall") %>%
  left_join(., 
            (metabLipidPvalueNo0 %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_overall")),
            by = c("metabolite", "lipid")) %>%
  filter(., pvalue_overall < 0.05) %>%
  left_join(.,
            (metabLipidCor13 %>%
               as.data.frame(.) %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_13") %>%
               left_join(., 
                         (metabLipidPvalue13 %>%
                            as.data.frame(.) %>%
                            rownames_to_column(., var = "metabolite") %>%
                            pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_13")),
                         by = c("metabolite", "lipid"))),
            by = c("metabolite", "lipid")) %>%
  left_join(.,
            (metabLipidCor30 %>%
               as.data.frame(.) %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_30") %>%
               left_join(., 
                         (metabLipidPvalue30 %>%
                            as.data.frame(.) %>%
                            rownames_to_column(., var = "metabolite") %>%
                            pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_30")),
                         by = c("metabolite", "lipid"))),
            by = c("metabolite", "lipid")) %>%
  left_join(.,
            (metabLipidCor5 %>%
               as.data.frame(.) %>%
               rownames_to_column(., var = "metabolite") %>%
               pivot_longer(cols = 2:13, names_to = "lipid", values_to = "correlation_05") %>%
               left_join(., 
                         (metabLipidPvalue5 %>%
                            as.data.frame(.) %>%
                            rownames_to_column(., var = "metabolite") %>%
                            pivot_longer(cols = 2:13, names_to = "lipid", values_to = "pvalue_05")),
                         by = c("metabolite", "lipid"))),
            by = c("metabolite", "lipid")) %>%
  pivot_longer(.,
               cols = 3:10,
               names_to = c(".value", "condition"),
               names_pattern = "(.*)_(.*)") %>%
  ggplot(., aes(x = condition, y = correlation, color = condition, shape = condition)) +
  geom_point(size = 3) +
  facet_grid(metabolite ~ lipid, scales = "free_y") +
  labs(y = "Pearson's Correlation Coefficient") +
  scale_color_manual(name = "Condition",
                     values = c(rev(plotColors), "black"), 
                     labels = c("5ºC", "13ºC", "30ºC", "Overall")) +
  scale_shape_manual(values = c(15, 19, 17, 3),
                     name = "Condition",
                     labels = c("5ºC", "13ºC", "30ºC", "Overall")) +
  theme_classic(base_size = 15) + theme(axis.title.x = element_blank(),
                                        axis.ticks.x = element_blank(),
                                        axis.text.x = element_blank(),
                                        strip.background = element_rect(colour = "white")) #Take original correlation data and use a series of left_joins to merge with correlation data for each specific temperature that has already been pivoted longer. Finally, combine all correlation data into a single column and all p-value information into a single column using a specific regex pattern. Use information in a ggplot.
ggsave("figures/metabolte-lipid-module-relationship-correlations.pdf", height = 8.5, width = 11)
```

# Correlating physiology and -omics data

## WCNA

The next step is to add physiology information to the metabolomics and lipidomics WCNA analyses. I want to correlate metabolite and lipid profiles with average TTR and respirometry data on the days the crabs were dissected. I'm going to do this in three steps:

1. Metabolomics and lipidomics WCNAs separately, correlate with physiology data only
2. Metabolomics and lipidomics WCNAs separately, correlate with physiology and temperature data
3. Combined metabolomics and lipidomics WCNAs

```{bash}
mkdir WCNA

mkdir WCNA/metabolomics
mkdir WCNA/metabolomics/figures

mkdir WCNA/lipidomics
mkdir WCNA/lipidomics/figures
```

### Correlate separate metabolomics and lipidomics WCNAs with physiology only

#### Modify trait matrix

```{r}
datTraitsPhysOnly <- metabolomicsMetadata %>%
  mutate(., day = gsub(x = day, pattern = 3, replacement = 4) %>% as.factor(.)) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_3", replacement = "_4") %>% as.factor(.)) %>%
  left_join(x = ., 
            y = (modTTRSampled %>% 
                   dplyr::select(c(crab.ID, treatment_day, TTRavg, TTRSE))), 
            by = c("crab.ID", "treatment_day")) %>%
  left_join(x = ., 
            y = all_MO2_slope_results_sampled %>%
              dplyr::select(c(crab.ID, treatment_day, slope_nmol_hr_corrected)), 
            by = c("crab.ID", "treatment_day")) %>%
  arrange(., crab.ID) %>%
  dplyr::select(-c(treatment:treatment_day, TTRSE)) %>%
  column_to_rownames(., var = "crab.ID") %>% 
  rename(., "Average TTR" = TTRavg) %>%
  mutate(., "Oxygen Consumption" = -slope_nmol_hr_corrected) %>%
  dplyr::select(-slope_nmol_hr_corrected)
#Take metadata and fix day to day 4 instead of day 3. Join with TTR data. 304, 308, and 506 do not have TTR data because they failed to right. Join with respirometry data (only select crabs have accompanying respirometry data). Use a series of case_when commands to create individual columns for each treatment or day, with 1 indicating that sample is part of the group, and 0 indicating that sample is not part of the group. Remove previous treatment classification columns and TTRSE column. Convert crab.ID to rownames. Rename TTR column. Make oxygen consumption -slope, and then remove slope column.
head(datTraitsPhysOnly) #Confirm dataframe creation
nrow(datTraitsPhysOnly) == nrow(rowwiseMetabData) #Confirm that there are the same number of rows (samples) between the new trait matrix and the metabolite data
```

#### Metabolomics

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorMetPhysOnly <- cor(MEsMet, datTraitsPhysOnly, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueMetPhysOnly <- WGCNA::corPvalueStudent(moduleTraitCorMetPhysOnly, nSamples) #Get p-values for correlations
head(moduleTraitCorMetPhysOnly %>% as.data.frame())
head(moduleTraitPvalueMetPhysOnly %>% as.data.frame())
```

```{r}
moduleTraitTreeMetPhysOnly <- hclust(dist(t(moduleTraitCorMetPhysOnly)), method = "average") #Create cluster dendogram for module-trait correlations
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixMetPhysOnly <- paste(signif(moduleTraitCorMetPhysOnly, 2), "\n(",signif(moduleTraitPvalueMetPhysOnly, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixMetPhysOnly) <- dim(moduleTraitCorMetPhysOnly) #Ensure this matrix has the appropriate dimensions
head(textMatrixMetPhysOnly) #Confirm matrix creation
```

```{r}
pdf("WCNA/metabolomics/figures/module-trait-relationships-physOnly.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorMetPhysOnly, xLabels = names(datTraitsPhysOnly),  yLabels = names(MEsMet), ySymbols = names(MEsMet), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixMetPhysOnly, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalMetPhysOnly <- signif(moduleTraitPvalueMetPhysOnly, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendMetPhysOnly <- dendsort(hclust(dist(moduleTraitCorMetPhysOnly))) #Create dendograms for rows
col_dendMetPhysOnly <- dendsort(hclust(dist(t(moduleTraitCorMetPhysOnly)))) #Create dendograms for columns

trait_orderMetPhysOnly <- c("Average TTR", "Oxygen Consumption") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/metabolomics/figures/module-trait-relationship-heatmap-physOnly.pdf", height = 8.5, width = 8.5)
htMetPhysOnly <- Heatmap(moduleTraitCorMetPhysOnly, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                         col = blueWhiteRed(50), 
                         row_names_side = "left", 
                         row_dend_side = "left",
                         width = unit(5, "in"), 
                         height = unit(4.5, "in"), 
                         column_dend_reorder = TRUE, 
                         cluster_columns = col_dendMetPhysOnly,
                         row_dend_reorder = FALSE,  
                         #column_split = 3, 
                         #row_split = 3, 
                         #column_dend_height = unit(.5, "in"),
                         cluster_rows = row_dendMetPhysOnly, 
                         #column_order = trait_order, 
                         #row_gap = unit(2.5, "mm"), 
                         border = TRUE,
                         cell_fun = function(j, i, x, y, w, h, col) {
                           if(heatmappvalMetPhysOnly[i, j] < 0.05) {
                             grid.text(sprintf("%s", heatmappvalMetPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                           }
                           else {
                             grid.text(sprintf("%s", heatmappvalMetPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                           }},
                         column_names_rot = 45,
                         column_names_gp =  gpar(fontsize = 12, border = FALSE),
                         column_title_gp = gpar(fontsize = 20),
                         row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htMetPhysOnly) #Draw heatmap
dev.off()
```

#### Lipidomics

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorLipidPhysOnly <- cor(MEsLipid, datTraitsPhysOnly, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueLipidPhysOnly <- WGCNA::corPvalueStudent(moduleTraitCorLipidPhysOnly, nSamples) #Get p-values for correlations
head(moduleTraitCorLipidPhysOnly %>% as.data.frame())
head(moduleTraitPvalueLipidPhysOnly %>% as.data.frame())
```

```{r}
moduleTraitTreeLipidPhysOnly <- hclust(dist(t(moduleTraitCorLipidPhysOnly)), method = "average") #Create cluster dendogram for module-trait correlations
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixLipidPhysOnly <- paste(signif(moduleTraitCorLipidPhysOnly, 2), "\n(",signif(moduleTraitPvalueLipidPhysOnly, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixLipidPhysOnly) <- dim(moduleTraitCorLipidPhysOnly) #Ensure this matrix has the appropriate dimensions
head(textMatrixLipidPhysOnly) #Confirm matrix creation
```

```{r}
pdf("WCNA/lipidomics/figures/module-trait-relationships-physOnly.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorLipidPhysOnly, xLabels = names(datTraitsPhysOnly),  yLabels = names(MEsLipid), ySymbols = names(MEsLipid), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixLipidPhysOnly, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalLipidPhysOnly <- signif(moduleTraitPvalueLipidPhysOnly, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendLipidPhysOnly <- dendsort(hclust(dist(moduleTraitCorLipidPhysOnly))) #Create dendograms for rows
col_dendLipidPhysOnly <- dendsort(hclust(dist(t(moduleTraitCorLipidPhysOnly)))) #Create dendograms for columns

trait_orderLipidPhysOnly <- c("Average TTR", "Oxygen Consumption") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/lipidomics/figures/module-trait-relationship-heatmap-physOnly.pdf", height = 8.5, width = 8.5)
htLipidPhysOnly <- Heatmap(moduleTraitCorLipidPhysOnly, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                           col = blueWhiteRed(50), 
                           row_names_side = "left", 
                           row_dend_side = "left",
                           width = unit(5, "in"), 
                           height = unit(4.5, "in"), 
                           column_dend_reorder = TRUE, 
                           cluster_columns = col_dendLipidPhysOnly,
                           row_dend_reorder = FALSE,  
                           #column_split = 3, 
                           #row_split = 3, 
                           #column_dend_height = unit(.5, "in"),
                           cluster_rows = row_dendLipidPhysOnly, 
                           #column_order = trait_order, 
                           #row_gap = unit(2.5, "mm"), 
                           border = TRUE,
                           cell_fun = function(j, i, x, y, w, h, col) {
                             if(heatmappvalLipidPhysOnly[i, j] < 0.05) {
                               grid.text(sprintf("%s", heatmappvalLipidPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                             }
                             else {
                               grid.text(sprintf("%s", heatmappvalLipidPhysOnly[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                             }},
                           column_names_rot = 45,
                           column_names_gp =  gpar(fontsize = 12, border = FALSE),
                           column_title_gp = gpar(fontsize = 20),
                           row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htLipidPhysOnly) #Draw heatmap
dev.off()
```

### Correlate separate metabolomics and lipidomics WCNAs with physiology, temperature, and day

#### Metabolomics

##### Modify trait matrix

The trait matricies for metabolomics and lipidomics will be separate since the interaction between temperature x day was significant for metabolites, and only temperature was significant for lipids.

```{r}
datTraitsPhysTemp <- metabolomicsMetadata %>%
  mutate(., day = gsub(x = day, pattern = 3, replacement = 4) %>% as.factor(.)) %>%
  mutate(., treatment_day = gsub(x = treatment_day, pattern = "_3", replacement = "_4") %>% as.factor(.)) %>%
  left_join(x = ., 
            y = (modTTRSampled %>% 
                   dplyr::select(c(crab.ID, treatment_day, TTRavg, TTRSE))), 
            by = c("crab.ID", "treatment_day")) %>%
  left_join(x = ., 
            y = all_MO2_slope_results_sampled %>%
              dplyr::select(c(crab.ID, treatment_day, slope_nmol_hr_corrected)), 
            by = c("crab.ID", "treatment_day")) %>%
  arrange(., crab.ID) %>%
  mutate(., "13ºC at Day 4" = case_when(treatment_day == "13_4" ~ 1,
                                        treatment_day != "13_4" ~ 0)) %>%
  mutate(., "5ºC at Day 4" = case_when(treatment_day == "5_4" ~ 1,
                                       treatment_day != "5_4" ~ 0)) %>%
  mutate(., "30ºC at Day 4" = case_when(treatment_day == "30_4" ~ 1,
                                        treatment_day != "30_4" ~ 0)) %>%
  mutate(., "13ºC at Day 22" = case_when(treatment_day == "13_22" ~ 1,
                                         treatment_day != "13_22" ~ 0)) %>%
  mutate(., "5ºC at Day 22" = case_when(treatment_day == "5_22" ~ 1,
                                        treatment_day != "5_22" ~ 0)) %>%
  mutate(., "30ºC at Day 22" = case_when(treatment_day == "30_22" ~ 1,
                                         treatment_day != "30_22" ~ 0)) %>%
  dplyr::select(-c(treatment:treatment_day, TTRSE)) %>%
  column_to_rownames(., var = "crab.ID") %>% 
  rename(., "Average TTR" = TTRavg) %>%
  mutate(., "Oxygen Consumption" = -slope_nmol_hr_corrected) %>%
  dplyr::select(-slope_nmol_hr_corrected)
#Take metadata and fix day to day 4 instead of day 3. Join with TTR data. 304, 308, and 506 do not have TTR data because they failed to right. Join with respirometry data (only select crabs have accompanying respirometry data). Use a series of case_when commands to create individual columns for each treatment or day, with 1 indicating that sample is part of the group, and 0 indicating that sample is not part of the group. Remove previous treatment classification columns and TTRSE column. Convert crab.ID to rownames. Rename TTR and respirometry columns
head(datTraitsPhysTemp) #Confirm dataframe creation
nrow(datTraitsPhysTemp) == nrow(rowwiseMetabData) #Confirm that there are the same number of rows (samples) between the new trait matrix and the metabolite data
```

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorMetPhysTemp <- cor(MEsMet, datTraitsPhysTemp, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueMetPhysTemp <- WGCNA::corPvalueStudent(moduleTraitCorMetPhysTemp, nSamples) #Get p-values for correlations
head(moduleTraitCorMetPhysTemp %>% as.data.frame())
head(moduleTraitPvalueMetPhysTemp %>% as.data.frame())
```

```{r}
moduleTraitTreeMetPhysTemp <- hclust(dist(t(moduleTraitCorMetPhysTemp)), method = "average") #Create cluster dendogram for module-trait correlations
```

```{r}
pdf(file = "WCNA/metabolomics/figures/module-trait-cluster-dendogram-physTemp.pdf", height = 8.5, width = 11)
plot(moduleTraitTreeMetPhysTemp) #Plot cluster dendogram
dev.off()
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixMetPhysTemp <- paste(signif(moduleTraitCorMetPhysTemp, 2), "\n(",signif(moduleTraitPvalueMetPhysTemp, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixMetPhysTemp) <- dim(moduleTraitCorMetPhysTemp) #Ensure this matrix has the appropriate dimensions
head(textMatrixMetPhysTemp) #Confirm matrix creation
```

```{r}
pdf("WCNA/metabolomics/figures/module-trait-relationships-physTemp.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorMetPhysTemp, xLabels = names(datTraitsPhysTemp),  yLabels = names(MEsMet), ySymbols = names(MEsMet), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixMetPhysTemp, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalMetPhysTemp <- signif(moduleTraitPvalueMetPhysTemp, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendMetPhysTemp <- dendsort(hclust(dist(moduleTraitCorMetPhysTemp))) #Create dendograms for rows
col_dendMetPhysTemp <- dendsort(hclust(dist(t(moduleTraitCorMetPhysTemp)))) #Create dendograms for columns

trait_orderMetPhysTemp <- c("Average TTR", "Oxygen Consumption", "5ºC at Day 3", "13ºC at Day 3", "30ºC at Day 3", "5ºC at Day 22", "13ºC at Day 22", "30ºC at Day 22") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/metabolomics/figures/module-trait-relationship-heatmap-physTemp.pdf", height = 8.5, width = 8.5)
htMetPhysTemp <- Heatmap(moduleTraitCorMetPhysTemp, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                         col = blueWhiteRed(50), 
                         row_names_side = "left", 
                         row_dend_side = "left",
                         width = unit(5, "in"), 
                         height = unit(4.5, "in"), 
                         column_dend_reorder = TRUE, 
                         cluster_columns = col_dendMetPhysTemp,
                         row_dend_reorder = FALSE,  
                         #column_split = 3, 
                         #row_split = 3, 
                         #column_dend_height = unit(.5, "in"),
                         cluster_rows = row_dendMetPhysTemp, 
                         #column_order = trait_order, 
                         #row_gap = unit(2.5, "mm"), 
                         border = TRUE,
                         cell_fun = function(j, i, x, y, w, h, col) {
                           if(heatmappvalMetPhysTemp[i, j] < 0.05) {
                             grid.text(sprintf("%s", heatmappvalMetPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                           }
                           else {
                             grid.text(sprintf("%s", heatmappvalMetPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                           }},
                         column_names_rot = 45,
                         column_names_gp =  gpar(fontsize = 12, border = FALSE),
                         column_title_gp = gpar(fontsize = 20),
                         row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htMetPhysTemp) #Draw heatmap
dev.off()
```

##### Append existing correlation information

I noticed that the treatment x module eigengene correlations I got from this analysis were different from when I did just temperature. However, the correlations between physiology and module eigengenes were the same. This could be because I am using a different R version than I was for the original WCNA analysis. I'm going to try appending the physiology correlations to the previous treatment correlations to see if that removes the inconsistency.

```{r}
moduleTraitCorMetAppend <- moduleTraitCorMet %>%
  as.data.frame(.) %>%
  rename("13ºC at Day 4" = "13ºC at Day 3") %>%
  rename("30ºC at Day 4" = "30ºC at Day 3") %>%
  rename("5ºC at Day 4" = "5ºC at Day 3") %>% 
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitCorMetPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Rename columns and convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitCorMetAppend #Confirm matrix creation
```

```{r}
moduleTraitPvalueMetAppend <- moduleTraitPvalueMet %>%
  as.data.frame(.) %>%
  rename("13ºC at Day 4" = "13ºC at Day 3") %>%
  rename("30ºC at Day 4" = "30ºC at Day 3") %>%
  rename("5ºC at Day 4" = "5ºC at Day 3") %>% 
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitPvalueMetPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Rename columns and convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitPvalueMetAppend #Confirm matrix creation
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalMetAppend <- signif(moduleTraitPvalueMetAppend, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendMetAppend <- dendsort(hclust(dist(moduleTraitCorMetAppend))) #Create dendograms for rows
col_dendMetAppend <- dendsort(hclust(dist(t(moduleTraitCorMetAppend)))) #Create dendograms for columns

trait_orderMetAppend <- c("Average TTR", "Oxygen Consumption", "5ºC at Day 3", "13ºC at Day 3", "30ºC at Day 3", "5ºC at Day 22", "13ºC at Day 22", "30ºC at Day 22") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/metabolomics/figures/module-trait-relationship-heatmap-append.pdf", height = 8.5, width = 8.5)
htMetAppend <- Heatmap(moduleTraitCorMetAppend, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                       col = blueWhiteRed(50), 
                       row_names_side = "left", 
                       row_dend_side = "left",
                       width = unit(5, "in"), 
                       height = unit(4.5, "in"), 
                       column_dend_reorder = FALSE, 
                       cluster_columns = FALSE,
                       row_dend_reorder = FALSE,  
                       column_split = c(rep("A", times = 6), rep("B", times = 2)), 
                       column_gap = unit(3, "mm"),
                       #row_split = 3, 
                       #column_dend_height = unit(.5, "in"),
                       cluster_rows = row_dendMetAppend, 
                       #row_gap = unit(2.5, "mm"), 
                       border = TRUE,
                       cell_fun = function(j, i, x, y, w, h, col) {
                         if(heatmappvalMetAppend[i, j] < 0.05) {
                           grid.text(sprintf("%s", heatmappvalMetAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                         }
                         else {
                           grid.text(sprintf("%s", heatmappvalMetAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                         }},
                       column_names_rot = 45,
                       column_names_gp =  gpar(fontsize = 12, border = FALSE),
                       column_title_gp = gpar(fontsize = 20),
                       row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htMetAppend) #Draw heatmap
dev.off()
```

#### Lipidomics

##### Modify trait matrix

```{r}
datTraitsPhysTempLipid <- lipidomicsMetadata %>%
  dplyr::select(-c(day:treatment_day)) %>%
  left_join(x = ., 
            y = (modTTRSampled %>% 
                   dplyr::select(c(crab.ID, treatment, TTRavg, TTRSE))), 
            by = c("crab.ID", "treatment")) %>%
  left_join(x = ., 
            y = all_MO2_slope_results_sampled %>%
              dplyr::select(c(crab.ID, treatment, slope_nmol_hr_corrected)), 
            by = c("crab.ID", "treatment")) %>%
  arrange(., crab.ID) %>%
  mutate(., "13ºC" = case_when(treatment == "13" ~ 1,
                               treatment != "13" ~ 0)) %>%
  mutate(., "5ºC" = case_when(treatment == "5" ~ 1,
                              treatment != "5" ~ 0)) %>%
  mutate(., "30ºC" = case_when(treatment == "30" ~ 1,
                               treatment != "30" ~ 0)) %>%
  dplyr::select(-c(treatment, TTRSE)) %>%
  column_to_rownames(., var = "crab.ID") %>% 
  rename(., "Average TTR" = TTRavg) %>%
  mutate(., "Oxygen Consumption" = -slope_nmol_hr_corrected) %>%
  dplyr::select(-slope_nmol_hr_corrected)
#Take metadata join with TTR data. 304, 308, and 506 do not have TTR data because they failed to right. Join with respirometry data (only select crabs have accompanying respirometry data). Use a series of case_when commands to create individual columns for each treatment, with 1 indicating that sample is part of the group, and 0 indicating that sample is not part of the group. Remove previous treatment classification columns and TTRSE column. Convert crab.ID to rownames. Rename TTR and respirometry columns
head(datTraitsPhysTempLipid) #Confirm dataframe creation
nrow(datTraitsPhysTempLipid) == nrow(rowwiseLipidData) #Confirm that there are the same number of rows (samples) between the new trait matrix and the metabolite data
```

##### Correlate trait matrix with WCNA modules

```{r}
moduleTraitCorLipidPhysTemp <- cor(MEsLipid, datTraitsPhysTempLipid, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueLipidPhysTemp <- WGCNA::corPvalueStudent(moduleTraitCorLipidPhysTemp, nSamples) #Get p-values for correlations
head(moduleTraitCorLipidPhysTemp %>% as.data.frame())
head(moduleTraitPvalueLipidPhysTemp %>% as.data.frame())
```

```{r}
moduleTraitTreeLipidPhysTemp <- hclust(dist(t(moduleTraitCorLipidPhysTemp)), method = "average") #Create cluster dendogram for module-trait correlations
```

```{r}
pdf(file = "WCNA/lipidomics/figures/module-trait-cluster-dendogram-physTemp.pdf", height = 8.5, width = 11)
plot(moduleTraitTreeLipidPhysTemp) #Plot cluster dendogram
dev.off()
```

##### Plot correlations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
textMatrixLipidPhysTemp <- paste(signif(moduleTraitCorLipidPhysTemp, 2), "\n(",signif(moduleTraitPvalueLipidPhysTemp, 1), ")", sep = "") #Create a matrix with the module-trait correlation and p-values
dim(textMatrixLipidPhysTemp) <- dim(moduleTraitCorLipidPhysTemp) #Ensure this matrix has the appropriate dimensions
head(textMatrixLipidPhysTemp) #Confirm matrix creation
```

```{r}
pdf("WCNA/lipidomics/figures/module-trait-relationships-physTemp.pdf", height = 8.5, width = 11)
labeledHeatmap(Matrix = moduleTraitCorLipidPhysTemp, xLabels = names(datTraitsPhysTempLipid),  yLabels = names(MEsLipid), ySymbols = names(MEsLipid), cex.lab.y = 1.5, cex.lab.x = 1.5, colors = blueWhiteRed(50), textMatrix = textMatrixLipidPhysTemp, setStdMargins = TRUE, cex.text = 1, zlim = c(-1,1), main = paste("Module-trait relationships"), cex.main = 2) #Use the textMatrix to create a heatmap with correlations between modules and the various treatments.
dev.off()
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalLipidPhysTemp <- signif(moduleTraitPvalueLipidPhysTemp, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendLipidPhysTemp <- dendsort(hclust(dist(moduleTraitCorLipidPhysTemp))) #Create dendograms for rows
col_dendLipidPhysTemp <- dendsort(hclust(dist(t(moduleTraitCorLipidPhysTemp)))) #Create dendograms for columns

trait_orderLipidPhysTemp <- c("Average TTR", "Oxygen Consumption", "5ºC", "13ºC", "30ºC") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/lipidomics/figures/module-trait-relationship-heatmap-physTemp.pdf", height = 8.5, width = 8.5)
htLipidPhysTemp <- Heatmap(moduleTraitCorLipidPhysTemp, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                           col = blueWhiteRed(50), 
                           row_names_side = "left", 
                           row_dend_side = "left",
                           width = unit(5, "in"), 
                           height = unit(4.5, "in"), 
                           column_dend_reorder = TRUE, 
                           cluster_columns = col_dendLipidPhysTemp,
                           row_dend_reorder = FALSE,  
                           #column_split = 3, 
                           #row_split = 3, 
                           #column_dend_height = unit(.5, "in"),
                           cluster_rows = row_dendLipidPhysTemp, 
                           #column_order = trait_order, 
                           #row_gap = unit(2.5, "mm"), 
                           border = TRUE,
                           cell_fun = function(j, i, x, y, w, h, col) {
                             if(heatmappvalLipidPhysTemp[i, j] < 0.05) {
                               grid.text(sprintf("%s", heatmappvalLipidPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                             }
                             else {
                               grid.text(sprintf("%s", heatmappvalLipidPhysTemp[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                             }},
                           column_names_rot = 45,
                           column_names_gp =  gpar(fontsize = 12, border = FALSE),
                           column_title_gp = gpar(fontsize = 20),
                           row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htLipidPhysTemp) #Draw heatmap
dev.off()
```

##### Append existing correlation information

```{r}
moduleTraitCorLipidAppend <- moduleTraitCorLipid %>%
  as.data.frame(.) %>%
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitCorLipidPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitCorLipidAppend #Confirm matrix creation
```

```{r}
moduleTraitPvalueLipidAppend <- moduleTraitPvalueLipid %>%
  as.data.frame(.) %>%
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitPvalueLipidPhysOnly %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitPvalueLipidAppend #Confirm matrix creation
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalLipidAppend <- signif(moduleTraitPvalueLipidAppend, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendLipidAppend <- dendsort(hclust(dist(moduleTraitCorLipidAppend))) #Create dendograms for rows
col_dendLipidAppend <- dendsort(hclust(dist(t(moduleTraitCorLipidAppend)))) #Create dendograms for columns

trait_orderLipidAppend <- c("Average TTR", "Oxygen Consumption", "5ºC", "13º", "30ºC") #Order of traits for heatmap
```

```{r}
pdf(file = "WCNA/lipidomics/figures/module-trait-relationship-heatmap-append.pdf", height = 8.5, width = 8.5)
htLipidAppend <- Heatmap(moduleTraitCorLipidAppend, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                         col = blueWhiteRed(50), 
                         row_names_side = "left", 
                         row_dend_side = "left",
                         width = unit(5, "in"), 
                         height = unit(4.5, "in"), 
                         column_dend_reorder = FALSE, 
                         cluster_columns = FALSE,
                         row_dend_reorder = FALSE,  
                         column_split = c(rep("A", times = 3), rep("B", times = 2)), 
                         column_gap = unit(3, "mm"),
                         #row_split = 3, 
                         #column_dend_height = unit(.5, "in"),
                         cluster_rows = row_dendLipidAppend, 
                         #row_gap = unit(2.5, "mm"), 
                         border = TRUE,
                         cell_fun = function(j, i, x, y, w, h, col) {
                           if(heatmappvalLipidAppend[i, j] < 0.05) {
                             grid.text(sprintf("%s", heatmappvalLipidAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                           }
                           else {
                             grid.text(sprintf("%s", heatmappvalLipidAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                           }},
                         column_names_rot = 45,
                         column_names_gp =  gpar(fontsize = 12, border = FALSE),
                         column_title_gp = gpar(fontsize = 20),
                         row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htLipidAppend) #Draw heatmap
dev.off()
```

### Interpret correlations between physiology and module eigengenes

Moving forward, I'm going to focus on the version where I appended physiology information onto the existing WCNA data. My next step is to understand what the significant correlations mean! I will do this in a few steps:

1. Identify molecules present in module eigengenes that were significantly correlated with physiology traits
2. Identify VIP molecules present in significantly correlated module eigengenes
3. Identify major pathways present in significantly correlated modules

#### Metabolomics

Righting response was not significantly correlated with any module.

Oxygen consumption was neagtively correlated with ME5. ME5 had a negative correlation with 30ºC on boy days 4 and 22, as well as a positive correlation with 5ºC on day 22. Respiration was also positively correlated with ME0, which was negatively correlated with 5ºC on day 22 and positively correlated with 30ºC on day 22.

##### Identify metabolites present in significant modules

```{r}
module0_metabolites <- read.csv("../05-metabolomics-analysis/metaboanalyst/module0_metabolites.csv") #Import list of metabolites in module 0
module5_metabolites <- read.csv("../05-metabolomics-analysis/metaboanalyst/module5_metabolites.csv") #Import list of metabolites in module 5
```

##### Identify VIP in significant modules

```{r}
VIP_module0 <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module0") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, module) #Import list of VIP in module 0. Retain columns of interest
VIP_module0
```

```{r}
VIP_module5 <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module5") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, module) #Import list of VIP in module 5. Retain columns of interest
VIP_module5
```

##### Identify pathways represented in the significant modules

###### VIP enrichment pathways 

```{r}
module0_pairwiseVIPpathway <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-pairwise-VIP-pathways.txt", sep = "\t") %>%
  filter(., module == "module0") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, pathway, module) #Import list of VIP in module 0. Retain columns of interest
module0_pairwiseVIPpathway
```

```{r}
module5_pairwiseVIPpathway <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-pairwise-VIP-pathways.txt", sep = "\t") %>%
  filter(., module == "module5") %>%
  dplyr::select(metabolite, statistic, p.adj, comparison, pathway, module) #Import list of VIP in module 0. Retain columns of interest
module5_pairwiseVIPpathway
```

###### A priori pathways

```{r}
rbind(module0_metabolites %>%
        filter(., Metabolite %in% respirationMetabolites) %>%
        mutate(., category = "respiration", module = "module0"), #5 respiration metabolites
      module0_metabolites %>%
        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
        mutate(., category = "calciumSignaling", module = "module0"), #3 calcium
      module0_metabolites %>%
        filter(., Metabolite %in% coldProtectionMetabolites) %>%
        mutate(., category = "coldProtection", module = "module0") #0 cold protection
) #Identify metabolites involved in various pre-ordained pathways
```

```{r}
rbind(module5_metabolites %>%
        filter(., Metabolite %in% respirationMetabolites) %>%
        mutate(., category = "respiration", module = "module5"), #0 respiration metabolites
      module5_metabolites %>%
        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
        mutate(., category = "calciumSignaling", module = "module5"), #2 calcium
      module5_metabolites %>%
        filter(., Metabolite %in% coldProtectionMetabolites) %>%
        mutate(., category = "coldProtection", module = "module5") #0 cold protection
) #Identify metabolites involved in various pre-ordained pathways
```

###### Metaboanalyst pathway enrichment

I used Metaboanalyst as a tool to get pathway information for the metabolites in modules 0 and 5.

Module 0: phosphoinositol, n-epsilon-trimethyllysine, and isothreonic acid not included

Module 5: ribose-5-phosphate not included

While there were no significantly enriched pathways in module 0, module 5 had several relating to valine and phenylalanine biosynthesis and metabolism.

```{r}
#Create lists of metabolites involved in significant pathways. Some names have spaces afterwards to reflect naming conventions in original dataframe
valineBiosynthesis <- c("threonine", "isoleucine ", "leucine", "2-ketoisocaproic acid", "valine ")
phenylalanineBiosynthesis <- c("phenylalanine", "tyrosine")
phenylalanineMetabolism <- c("phenylalanine", "tyrosine")
valineDegradation <- c("isoleucine ", "leucine", "valine ")
```

##### Combine all information

```{r}
module0_annotations <- module0_metabolites %>%
  dplyr::rename(metabolite = Metabolite) %>%
  left_join(., y = VIP_module0 %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = "metabolite", names_from = "comparison", values_from = "comparison"), 
            by = "metabolite") %>%
  left_join(., y = module0_pairwiseVIPpathway %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = c("metabolite", "pathway"), names_from = "comparison", values_from = "comparison"), 
            by = c("metabolite", "day2213v5")) %>%
  left_join(x = ., 
            y = rbind(module0_metabolites %>%
                        filter(., Metabolite %in% respirationMetabolites) %>%
                        mutate(., category = "respiration"),
                      module0_metabolites %>%
                        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
                        mutate(., category = "calciumSignaling"),
                      module0_metabolites %>%
                        filter(., Metabolite %in% coldProtectionMetabolites) %>%
                        mutate(., category = "coldProtection")) %>%
              dplyr::rename(metabolite = "Metabolite") %>%
              pivot_wider(., id_cols = "metabolite", names_from = "category", values_from = "category"), 
            by = "metabolite") %>%
  mutate(., respiration = case_when(is.na(respiration) == TRUE ~ 0,
                                    is.na(respiration) == FALSE ~ 1)) %>%
  mutate(., calciumSignaling = case_when(is.na(calciumSignaling) == TRUE ~ 0,
                                         is.na(calciumSignaling) == FALSE ~ 1)) %>%
  mutate(., coldProtection = 0) %>%
  mutate(., day2213v30 = case_when(is.na(day2213v30) == TRUE ~ 0,
                                   is.na(day2213v30) == FALSE ~ 1)) %>%
  mutate(., day2213v5 = case_when(is.na(day2213v5) == TRUE ~ 0,
                                  is.na(day2213v5) == FALSE ~ 1)) #Take module metabolite information and join with modified VIP information, enrichment information, and a priori pathway information.
head(module0_annotations) #Confirm dataframe creation
```

```{r}
module5_annotations <- module5_metabolites %>%
  dplyr::rename(metabolite = Metabolite) %>%
  left_join(., y = VIP_module5 %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = "metabolite", names_from = "comparison", values_from = "comparison"), 
            by = "metabolite") %>%
  mutate(., day2213v5 = 0) %>%
  left_join(., y = module5_pairwiseVIPpathway %>% 
              dplyr::select(-module) %>%
              mutate(., comparison = case_when(comparison == "13v30_day22" ~ "day2213v30",
                                               comparison == "13v5_day22" ~ "day2213v5")) %>%
              pivot_wider(., id_cols = c("metabolite", "pathway"), names_from = "comparison", values_from = "comparison"), 
            by = c("metabolite", "day2213v30")) %>%
  left_join(x = ., 
            y = rbind(module5_metabolites %>%
                        filter(., Metabolite %in% respirationMetabolites) %>%
                        mutate(., category = "respiration"),
                      module5_metabolites %>%
                        filter(., Metabolite %in% calciumSignalingMetabolites) %>%
                        mutate(., category = "calciumSignaling"),
                      module5_metabolites %>%
                        filter(., Metabolite %in% coldProtectionMetabolites) %>%
                        mutate(., category = "coldProtection")) %>%
              dplyr::rename(metabolite = "Metabolite") %>%
              pivot_wider(., id_cols = "metabolite", names_from = "category", values_from = "category"), 
            by = "metabolite") %>%
  mutate(., respiration = 0) %>%
  mutate(., calciumSignaling = case_when(is.na(calciumSignaling) == TRUE ~ 0,
                                         is.na(calciumSignaling) == FALSE ~ 1)) %>%
  mutate(., coldProtection = 0) %>%
  mutate(., day2213v30 = case_when(is.na(day2213v30) == TRUE ~ 0,
                                   is.na(day2213v30) == FALSE ~ 1)) %>%
  left_join(x = .,
            y = rbind(module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% valineBiosynthesis) %>%
                        mutate(., physPathway = "valineBiosynthesisPhys"), 
                      module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% phenylalanineBiosynthesis) %>%
                        mutate(., physPathway = "phenylalanineBiosynthesisPhys"), 
                      module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% phenylalanineMetabolism) %>%
                        mutate(., physPathway = "phenylalanineMetabolismPhys"), module5_metabolites %>%
                        dplyr::rename(metabolite = "Metabolite") %>%
                        filter(., metabolite %in% valineDegradation) %>%
                        mutate(., physPathway = "valineDegradationPhys")) %>%
              pivot_wider(., id_cols = "metabolite", names_from = "physPathway", values_from = "physPathway"),
            by = "metabolite") %>%
  mutate(., valineBiosynthesisPhys = case_when(is.na(valineBiosynthesisPhys) == TRUE ~ 0,
                                               is.na(valineBiosynthesisPhys) == FALSE ~ 1)) %>%
  mutate(., phenylalanineBiosynthesisPhys = case_when(is.na(phenylalanineBiosynthesisPhys) == TRUE ~ 0,
                                                      is.na(phenylalanineBiosynthesisPhys) == FALSE ~ 1)) %>%
  mutate(., phenylalanineMetabolismPhys = case_when(is.na(phenylalanineMetabolismPhys) == TRUE ~ 0,
                                                    is.na(phenylalanineMetabolismPhys) == FALSE ~ 1)) %>%
  mutate(., valineDegradationPhys = case_when(is.na(valineDegradationPhys) == TRUE ~ 0,
                                              is.na(valineDegradationPhys) == FALSE ~ 1)) #Take module metabolite information and join with modified VIP information, enrichment information, and a priori pathway information.
head(module5_annotations) #Confirm dataframe creation
```

```{r}
#Save annotation dataframes
write.csv(module0_annotations, "WCNA/metabolomics/module0_annotations.csv", quote = FALSE, row.names = FALSE)
write.csv(module5_annotations, "WCNA/metabolomics/module5_annotations.csv", quote = FALSE, row.names = FALSE)
```

Valine biosynthesis, phenylalanine biosynthesis, phenylalanine metabolism, and valine degradation seem to play an important role in temperature regulation of respiration! I will need to explore this further.

#### Lipidomics

Righting response:

- Negative correlation with ME15
- Negative correlation with ME3, which was also negatively correlated with 5ºC and oxgygen consumption, and positively correlated with 30ºC
- Negative correlation with ME6, which was positively correlated with 30ºC

Oxygen consumption:

- Positive correlation with ME5, which was negatively correlated with 30ºC
- Negative correlation with ME9, which was positively correlated with 5ºC and negatively correlated with 30ºC
- Negative correlation with ME0, which was positively correlated with 5ºC
- Positive correlation with ME3, which was was negatively correlated with 5ºC and righting response, and positively correlated with 30ºC

I will focus on modules 0, 3, 5, 6, 9, and 15.

##### Identify metabolites present in significant modules

```{r}
module0_lipids <- read.delim("../06-lipidomics-analysis/metaboanalyst/module0_lipids.tsv", sep = "\t") %>%
  dplyr::select(-identifier) #Import list of lipids in module 0
module3_lipids <- read.delim("../06-lipidomics-analysis/metaboanalyst/module3_lipids.tsv", sep = "\t") %>%
  dplyr::select(-identifier) %>%
  unique(.) #Import list of lipids in module 3. Remove any duplicated rows
module5_lipids <- read.delim("../06-lipidomics-analysis/metaboanalyst/module5_lipids.tsv", sep = "\t") %>%
  dplyr::select(-identifier) #Import list of lipids in module 5
module6_lipids <- read.delim("../06-lipidomics-analysis/metaboanalyst/module6_lipids.tsv", sep = "\t") %>%
  dplyr::select(-identifier) #Import list of lipids in module 6
module9_lipids <- read.delim("../06-lipidomics-analysis/metaboanalyst/module9_lipids.tsv", sep = "\t") %>%
  dplyr::select(-identifier) #Import list of lipids in module 9
module15_lipids <- read.delim("../06-lipidomics-analysis/metaboanalyst/module15_lipids.tsv", sep = "\t") %>%
  dplyr::select(-identifier) #Import list of lipids in module 15
```

```{r}
#Ensure that there aren't any duplicated entries remaining
module0_lipids %>% dplyr::select(lipid) %>% unique %>% nrow(.) == nrow(module0_lipids)
module3_lipids %>% dplyr::select(lipid) %>% unique %>% nrow(.) == nrow(module3_lipids)
module5_lipids %>% dplyr::select(lipid) %>% unique %>% nrow(.) == nrow(module5_lipids)
module6_lipids %>% dplyr::select(lipid) %>% unique %>% nrow(.) == nrow(module6_lipids)
module9_lipids %>% dplyr::select(lipid) %>% unique %>% nrow(.) == nrow(module9_lipids)
module15_lipids %>% dplyr::select(lipid) %>% unique %>% nrow(.) == nrow(module15_lipids)
```
```{r}
module0_lipids
module3_lipids
module5_lipids
module6_lipids
module9_lipids
module15_lipids
```

##### Identify VIP in significant modules

```{r}
VIPlipids_module0 <- read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module0") %>%
  dplyr::select(lipid, statistic, p.adj, comparison, module) #Import list of VIP in module 0. Retain columns of interest
VIPlipids_module0 #No VIP
```

```{r}
VIPlipids_module3 <- read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module3") %>%
  dplyr::select(lipid, statistic, p.adj, comparison, module) #Import list of VIP in module 3. Retain columns of interest
VIPlipids_module3
```

```{r}
VIPlipids_module5 <- read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module5") %>%
  dplyr::select(lipid, statistic, p.adj, comparison, module) #Import list of VIP in module 5. Retain columns of interest
VIPlipids_module5
```

```{r}
VIPlipids_module6 <- read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module6") %>%
  dplyr::select(lipid, statistic, p.adj, comparison, module) #Import list of VIP in module 6. Retain columns of interest
VIPlipids_module6 
```

```{r}
VIPlipids_module9 <- read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module9") %>%
  dplyr::select(lipid, statistic, p.adj, comparison, module) #Import list of VIP in module 9. Retain columns of interest
VIPlipids_module9
```

```{r}
VIPlipids_module15 <- read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
  filter(., module == "module15") %>%
  dplyr::select(lipid, statistic, p.adj, comparison, module) #Import list of VIP in module 15. Retain columns of interest
VIPlipids_module15 #No VIP
```

##### Identify pathways represented in the significant modules

###### VIP in enriched pathways

```{r}
LIONtoTerm13v30 <- read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-term-associations-13v30.csv") %>%
  dplyr::select(LION.term, LION.name) %>%
  slice(-1) %>%
  filter(LION.term == "LION:0012080" | LION.term == "LION:0000095" | LION.term == "LION:0000465" | LION.term == "LION:0000010" | LION.term == "LION:0012010" | LION.term == "LION:0000003" | LION.term == "LION:0000031") %>% 
  mutate(LION.term = gsub(x = LION.term, pattern = ":", replacement = "."))
#Import dataframe with lion terms and term names. Retain only significantly enriched terms
head(LIONtoTerm13v30) #Confirm formatting
```

```{r}
LIONtoTerm13v5 <- read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-term-associations-13v5.csv") %>%
  dplyr::select(LION.term, LION.name) %>%
  slice(-1) %>%
  filter(LION.term == "LION:0012080" | LION.term == "LION:0012081" | LION.term == "LION:0000011" | LION.term == "LION:0000003") %>% 
  mutate(LION.term = gsub(x = LION.term, pattern = ":", replacement = ".")) #Import dataframe with lion terms and term names. Retain only significantly enriched terms
head(LIONtoTerm13v5) #Confirm formatting
```

```{r}
module3Lipids_enrichedVIP <- read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (VIPlipids_module3$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
  rownames_to_column(., var = "lipid") %>%
  left_join(x = .,
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              filter(., lipid %in% (VIPlipids_module3$lipid %>%
                                      str_trim(side = "both"))) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
              rownames_to_column(., var = "lipid"),
            by = c("lipid", "LION.0000003", "LION.0012080")) %>%
  mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                     LION.0000003 != "x" ~ NA)) %>%
  mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                     LION.0000010 != "x" ~ NA)) %>% 
  mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                     LION.0000031 != "x" ~ NA)) %>% 
  mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                     LION.0000095 != "x" ~ NA)) %>%   
  mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                     LION.0000465 != "x" ~ NA)) %>%    
  mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                     LION.0012010 != "x" ~ NA)) %>%
  mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                     LION.0012080 != "x" ~ NA)) %>%
  mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                     LION.0000011 != "x" ~ NA)) %>%
  mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                     LION.0012081 != "x" ~ NA))
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for VIP lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Repeat process with 13v5 LION terms and join with dataframe based on common LION terms and lipids. Use case_when to pinpoint which LION terms ar related to specific enrichment categories
module3Lipids_enrichedVIP #Confirm dataframe creation
```

```{r}
module5Lipids_enrichedVIP <- read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (VIPlipids_module5$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
  rownames_to_column(., var = "lipid") %>%
  left_join(x = .,
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              filter(., lipid %in% (VIPlipids_module5$lipid %>%
                                      str_trim(side = "both"))) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
              rownames_to_column(., var = "lipid"),
            by = c("lipid", "LION.0000003", "LION.0012080")) %>%
  mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                     LION.0000003 != "x" ~ NA)) %>%
  mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                     LION.0000010 != "x" ~ NA)) %>% 
  mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                     LION.0000031 != "x" ~ NA)) %>% 
  mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                     LION.0000095 != "x" ~ NA)) %>%   
  mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                     LION.0000465 != "x" ~ NA)) %>%    
  mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                     LION.0012010 != "x" ~ NA)) %>%
  mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                     LION.0012080 != "x" ~ NA)) %>%
  mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                     LION.0000011 != "x" ~ NA)) %>%
  mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                     LION.0012081 != "x" ~ NA))
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for VIP lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Repeat process with 13v5 LION terms and join with dataframe based on common LION terms and lipids. Use case_when to pinpoint which LION terms ar related to specific enrichment categories
module5Lipids_enrichedVIP #Confirm dataframe creation
```

```{r}
module6Lipids_enrichedVIP <- read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (VIPlipids_module6$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
  rownames_to_column(., var = "lipid") %>%
  left_join(x = .,
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              filter(., lipid %in% (VIPlipids_module6$lipid %>%
                                      str_trim(side = "both"))) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
              rownames_to_column(., var = "lipid"),
            by = c("lipid", "LION.0000003", "LION.0012080")) %>%
  mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                     LION.0000003 != "x" ~ NA)) %>%
  mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                     LION.0000010 != "x" ~ NA)) %>% 
  mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                     LION.0000031 != "x" ~ NA)) %>% 
  mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                     LION.0000095 != "x" ~ NA)) %>%   
  mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                     LION.0000465 != "x" ~ NA)) %>%    
  mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                     LION.0012010 != "x" ~ NA)) %>%
  mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                     LION.0012080 != "x" ~ NA)) %>%
  mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                     LION.0000011 != "x" ~ NA)) %>%
  mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                     LION.0012081 != "x" ~ NA))
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for VIP lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Repeat process with 13v5 LION terms and join with dataframe based on common LION terms and lipids. Use case_when to pinpoint which LION terms ar related to specific enrichment categories
module6Lipids_enrichedVIP #Confirm dataframe creation
```

```{r}
module9Lipids_enrichedVIP <- read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (VIPlipids_module9$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
  rownames_to_column(., var = "lipid") %>%
  left_join(x = .,
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              filter(., lipid %in% (VIPlipids_module9$lipid %>%
                                      str_trim(side = "both"))) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
              rownames_to_column(., var = "lipid"),
            by = c("lipid", "LION.0000003", "LION.0012080")) %>%
  mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                     LION.0000003 != "x" ~ NA)) %>%
  mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                     LION.0000010 != "x" ~ NA)) %>% 
  mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                     LION.0000031 != "x" ~ NA)) %>% 
  mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                     LION.0000095 != "x" ~ NA)) %>%   
  mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                     LION.0000465 != "x" ~ NA)) %>%    
  mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                     LION.0012010 != "x" ~ NA)) %>%
  mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                     LION.0012080 != "x" ~ NA)) %>%
  mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                     LION.0000011 != "x" ~ NA)) %>%
  mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                     LION.0012081 != "x" ~ NA))
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for VIP lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Repeat process with 13v5 LION terms and join with dataframe based on common LION terms and lipids. Use case_when to pinpoint which LION terms ar related to specific enrichment categories
module9Lipids_enrichedVIP #Confirm dataframe creation
```

There are no VIP in modules 0 or 15, so I did not do this analysis with those modules.

###### Lipid classes

I previously annotated VIP with lipid classes and saturation state., which would be useful for understanding differences in cell membranes across temperature.

```{r}
module3Lipids_VIPclasses <- significantVIP_13v30_annot %>%
  rbind(significantVIP_13v5_annot) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  dplyr::select(lipid, comparison:saturation) %>%
  mutate(comparison = case_when(comparison == "13 vs. 30" ~ "13v30",
                                comparison == "13 vs. 5" ~ "13v5")) %>%
  unique(.) %>%
  left_join(x = VIPlipids_module3 %>%
              mutate(lipid = str_trim(lipid, side = "both")),
            y = .,
            by = c("lipid", "comparison")) %>%
  arrange(., lipid) %>%
  pivot_wider(., id_cols = c(lipid, module, class, targetClass, saturation, p.adj), names_from = "comparison", names_prefix = "statistic.", values_from = "statistic") %>%
  mutate(., comparison = case_when(is.na(statistic.13v30) == FALSE ~ "13v30",
                                   is.na(statistic.13v5) == FALSE ~ "13v5")) %>%
  pivot_wider(., id_cols = c(lipid, module, class, targetClass, saturation, statistic.13v30, statistic.13v5), names_from = "comparison", names_prefix = "padj.", values_from = "p.adj") #Combine lists of VIP. Remove any leading or trailing white space from lipids and select columns of interest. Modify information in comparison column. Retain only unique rows. Join with module VIP information and arrange by lipid. Pivot wider in two steps to assign correct statistic and p.adj information to each lipid.
module3Lipids_VIPclasses
```

```{r}
module5Lipids_VIPclasses <- significantVIP_13v30_annot %>%
  rbind(significantVIP_13v5_annot) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  dplyr::select(lipid, comparison:saturation) %>%
  mutate(comparison = case_when(comparison == "13 vs. 30" ~ "13v30",
                                comparison == "13 vs. 5" ~ "13v5")) %>%
  unique(.) %>%
  left_join(x = VIPlipids_module5 %>%
              mutate(lipid = str_trim(lipid, side = "both")),
            y = .,
            by = c("lipid", "comparison")) %>%
  arrange(., lipid) %>%
  dplyr::rename(statistic.13v30 = statistic) %>%
  dplyr::rename(padj.13v30 = p.adj) %>%
  dplyr::select(-comparison) %>%
  mutate(., statistic.13v5 = NA,
         padj.13v5 = NA) #Combine lists of VIP. Remove any leading or trailing white space from lipids and select columns of interest. Modify information in comparison column. Retain only unique rows. Join with module VIP information and arrange by lipid. Since there are no 13v5 anotated in this module, manually modify columns to match other dataframes.
module5Lipids_VIPclasses
```

```{r}
module6Lipids_VIPclasses <- significantVIP_13v30_annot %>%
  rbind(significantVIP_13v5_annot) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  dplyr::select(lipid, comparison:saturation) %>%
  mutate(comparison = case_when(comparison == "13 vs. 30" ~ "13v30",
                                comparison == "13 vs. 5" ~ "13v5")) %>%
  unique(.) %>%
  left_join(x = VIPlipids_module6 %>%
              mutate(lipid = str_trim(lipid, side = "both")),
            y = .,
            by = c("lipid", "comparison")) %>%
  arrange(., lipid) %>%
  dplyr::rename(statistic.13v30 = statistic) %>%
  dplyr::rename(padj.13v30 = p.adj) %>%
  dplyr::select(-comparison) %>%
  mutate(., statistic.13v5 = NA,
         padj.13v5 = NA) #Combine lists of VIP. Remove any leading or trailing white space from lipids and select columns of interest. Modify information in comparison column. Retain only unique rows. Join with module VIP information and arrange by lipid. Since there are no 13v5 anotated in this module, manually modify columns to match other dataframes.
module6Lipids_VIPclasses
```

```{r}
module9Lipids_VIPclasses <- significantVIP_13v30_annot %>%
  rbind(significantVIP_13v5_annot) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  dplyr::select(lipid, comparison:saturation) %>%
  mutate(comparison = case_when(comparison == "13 vs. 30" ~ "13v30",
                                comparison == "13 vs. 5" ~ "13v5")) %>%
  unique(.) %>%
  left_join(x = VIPlipids_module9 %>%
              mutate(lipid = str_trim(lipid, side = "both")),
            y = .,
            by = c("lipid", "comparison")) %>%
  arrange(., lipid) %>%
  pivot_wider(., id_cols = c(lipid, module, class, targetClass, saturation, p.adj), names_from = "comparison", names_prefix = "statistic.", values_from = "statistic") %>%
  mutate(., comparison = case_when(is.na(statistic.13v30) == FALSE ~ "13v30",
                                   is.na(statistic.13v5) == FALSE ~ "13v5")) %>%
  pivot_wider(., id_cols = c(lipid, module, class, targetClass, saturation, statistic.13v30, statistic.13v5), names_from = "comparison", names_prefix = "padj.", values_from = "p.adj") #Combine lists of VIP. Remove any leading or trailing white space from lipids and select columns of interest. Modify information in comparison column. Retain only unique rows. Join with module VIP information and arrange by lipid. Pivot wider in two steps to assign correct statistic and p.adj information to each lipid.
module9Lipids_VIPclasses
```

###### LION/web pathway enrichment

I am going to put the lipid information from modules 0, 3, 5, 6, 9, and 15 through LION/web enrichment. This will be to see if there are any overrepresented processes unique to the physiology modules, or to see if there are any overlapping enriched terms between modules significant for physiology and temperature.

- Target-list mode: target list is a list of lipids in the module, background is a list of all detected and known lipids.

```{r}
module0Lipid_enrichment <- read.csv("WCNA/lipidomics/LION-enrichment-report-module0phys/LION-enrichment-results.csv") %>%
  filter(., FDR.q.value < 0.05)
module0Lipid_enrichment #No enriched terms in module 0
```

```{r}
module3Lipid_enrichment <- read.csv("WCNA/lipidomics/LION-enrichment-report-module3phys/LION-enrichment-results.csv") %>%
  filter(., FDR.q.value < 0.05)
module3Lipid_enrichment #7 enriched terms in module
```

```{r}
LIONtoTermmodule3 <- read.csv("WCNA/lipidomics/LION-enrichment-report-module3phys/LION-term-associations.csv") %>%
  dplyr::select(LION.term, LION.name) %>%
  slice(-1) %>%
  filter(LION.term %in% module3Lipid_enrichment$Term.ID) %>% 
  mutate(LION.term = gsub(x = LION.term, pattern = ":", replacement = "."))
#Import dataframe with lion terms and term names. Retain only significantly enriched terms
head(LIONtoTermmodule3) #Confirm formatting
```

```{r}
module3Lipids_enrichedPhys <- read.csv("WCNA/lipidomics/LION-enrichment-report-module3phys/LION-lipid-associations.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (module3_lipids$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTermmodule3$LION.term) %>%
  rename_with(~ paste0(.x, ".PhysModule3")) %>%
  rownames_to_column(., var = "lipid")
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Add suffix to all columns to delineate these are enriched phys pathways, not associated with temperature VIP.
module3Lipids_enrichedPhys #Confirm dataframe creation
```

```{r}
module5Lipid_enrichment <- read.csv("WCNA/lipidomics/LION-enrichment-report-module5phys/LION-enrichment-results.csv") %>%
  filter(., FDR.q.value < 0.05)
module5Lipid_enrichment #6 enriched terms in module
```

```{r}
LIONtoTermmodule5 <- read.csv("WCNA/lipidomics/LION-enrichment-report-module5phys/LION-term-associations.csv") %>%
  dplyr::select(LION.term, LION.name) %>%
  slice(-1) %>%
  filter(LION.term %in% module5Lipid_enrichment$Term.ID) %>% 
  mutate(LION.term = gsub(x = LION.term, pattern = ":", replacement = "."))
#Import dataframe with lion terms and term names. Retain only significantly enriched terms
head(LIONtoTermmodule5) #Confirm formatting
```

```{r}
module5Lipids_enrichedPhys <- read.csv("WCNA/lipidomics/LION-enrichment-report-module5phys/LION-lipid-associations.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (module5_lipids$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTermmodule5$LION.term) %>%
  rename_with(~ paste0(.x, ".PhysModule5")) %>%
  rownames_to_column(., var = "lipid")
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Add suffix to all columns to delineate these are enriched phys pathways, not associated with temperature VIP.
module5Lipids_enrichedPhys #Confirm dataframe creation
```

```{r}
module6Lipid_enrichment <- read.csv("WCNA/lipidomics/LION-enrichment-report-module6phys/LION-enrichment-results.csv") %>%
  filter(., FDR.q.value < 0.05)
module6Lipid_enrichment #7 enriched terms in module
```

```{r}
LIONtoTermmodule6 <- read.csv("WCNA/lipidomics/LION-enrichment-report-module6phys/LION-term-associations.csv") %>%
  dplyr::select(LION.term, LION.name) %>%
  slice(-1) %>%
  filter(LION.term %in% module6Lipid_enrichment$Term.ID) %>% 
  mutate(LION.term = gsub(x = LION.term, pattern = ":", replacement = "."))
#Import dataframe with lion terms and term names. Retain only significantly enriched terms
head(LIONtoTermmodule6) #Confirm formatting
```

```{r}
module6Lipids_enrichedPhys <- read.csv("WCNA/lipidomics/LION-enrichment-report-module6phys/LION-lipid-associations.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (module6_lipids$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTermmodule6$LION.term) %>%
  rename_with(~ paste0(.x, ".PhysModule6")) %>%
  rownames_to_column(., var = "lipid")
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Add suffix to all columns to delineate these are enriched phys pathways, not associated with temperature VIP.
module6Lipids_enrichedPhys #Confirm dataframe creation
```

```{r}
module9Lipid_enrichment <- read.csv("WCNA/lipidomics/LION-enrichment-report-module9phys/LION-enrichment-results.csv") %>%
  filter(., FDR.q.value < 0.05)
module9Lipid_enrichment #1 enriched terms in module
```

```{r}
LIONtoTermmodule9 <- read.csv("WCNA/lipidomics/LION-enrichment-report-module9phys/LION-term-associations.csv") %>%
  dplyr::select(LION.term, LION.name) %>%
  slice(-1) %>%
  filter(LION.term %in% module9Lipid_enrichment$Term.ID) %>% 
  mutate(LION.term = gsub(x = LION.term, pattern = ":", replacement = "."))
#Import dataframe with lion terms and term names. Retain only significantly enriched terms
head(LIONtoTermmodule9) #Confirm formatting
```

```{r}
module9Lipids_enrichedPhys <- read.csv("WCNA/lipidomics/LION-enrichment-report-module9phys/LION-lipid-associations.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (module9_lipids$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTermmodule9$LION.term) %>%
  rename_with(~ paste0(.x, ".PhysModule9")) %>%
  rownames_to_column(., var = "lipid")
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Add suffix to all columns to delineate these are enriched phys pathways, not associated with temperature VIP.
module9Lipids_enrichedPhys #Confirm dataframe creation
```

```{r}
module15Lipid_enrichment <- read.csv("WCNA/lipidomics/LION-enrichment-report-module15phys/LION-enrichment-results.csv") %>%
  filter(., FDR.q.value < 0.05)
module15Lipid_enrichment #5 enriched terms in module
```

```{r}
LIONtoTermmodule15 <- read.csv("WCNA/lipidomics/LION-enrichment-report-module15phys/LION-term-associations.csv") %>%
  dplyr::select(LION.term, LION.name) %>%
  slice(-1) %>%
  filter(LION.term %in% module15Lipid_enrichment$Term.ID) %>% 
  mutate(LION.term = gsub(x = LION.term, pattern = ":", replacement = "."))
#Import dataframe with lion terms and term names. Retain only significantly enriched terms
head(LIONtoTermmodule15) #Confirm formatting
```

```{r}
module15Lipids_enrichedPhys <- read.csv("WCNA/lipidomics/LION-enrichment-report-module15phys/LION-lipid-associations.csv", strip.white = TRUE) %>%
  slice(-1) %>%
  mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
  rename(lipid = LION.term) %>%
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  filter(., lipid %in% (module15_lipids$lipid %>%
                          str_trim(side = "both"))) %>%
  unique(.) %>%
  remove_rownames() %>%
  column_to_rownames(., var = "lipid") %>%
  dplyr::select_if(colnames(.) %in% LIONtoTermmodule15$LION.term) %>%
  rename_with(~ paste0(.x, ".PhysModule15")) %>%
  rownames_to_column(., var = "lipid")
#Import table with lion terms as columns and lipids as rows. Remove first row, which has lion term names. Remove leading characters from lipids, rename column, and remove white space on both sides of the string. Filter for lipids in module, modified to remove white space. Remove repetitive rows and remove rownames. Assign new rownames using unique lipid names. Select columns if they match with lion terms in LIONtoTerm13v30. Convert rownames back to a column. Add suffix to all columns to delineate these are enriched phys pathways, not associated with temperature VIP.
module15Lipids_enrichedPhys #Confirm dataframe creation
```

##### Combine all information

Module 0 has no VIP nor any enriched pathways, so there won't be a table for that module.

```{r}
allPhysModules_lipidAnnotations <- module3_lipids %>% 
  mutate(lipid = str_trim(lipid, side = "both")) %>%
  remove_rownames(.) %>%
  left_join(., module3Lipids_VIPclasses, by = "lipid") %>%
  dplyr::select(-c(PubChem.CID:module)) %>%
  unique(.) %>%
  group_by(., lipid, class, targetClass, saturation) %>%
  summarise(across(starts_with(c("statistic.", "padj.")), ~sum(., na.rm = TRUE))) %>%
  ungroup(.) %>%
  mutate(., across(starts_with(c("statistic.", "padj.")), ~na_if(., 0))) %>%
  left_join(., module3Lipids_enrichedVIP, by = "lipid") %>%
  left_join(., module3Lipids_enrichedPhys, by = "lipid") %>%
  full_join(x = ., 
            y = (module5_lipids %>% 
                   mutate(lipid = str_trim(lipid, side = "both")) %>%
                   remove_rownames(.) %>%
                   left_join(., module5Lipids_VIPclasses, by = "lipid") %>%
                   dplyr::select(-c(PubChem.CID:module)) %>%
                   unique(.) %>%
                   group_by(., lipid, class, targetClass, saturation) %>%
                   summarise(across(starts_with(c("statistic.", "padj.")), ~sum(., na.rm = TRUE))) %>%
                   ungroup(.) %>%
                   mutate(., across(starts_with(c("statistic.", "padj.")), ~na_if(., 0))) %>%
                   left_join(., module5Lipids_enrichedVIP, by = "lipid") %>%
                   left_join(., module5Lipids_enrichedPhys, by = "lipid")),
            by = c("lipid", "class", "targetClass", "saturation", "statistic.13v5", "padj.13v5", 
                   "LION.0000003", "LION.0000010", "LION.0000031", "LION.0000095", "LION.0000465", "LION.0012010", "LION.0012080", "LION.0000011", "LION.0012081")) %>%
  full_join(x = ., 
            y = (module6_lipids %>% 
                   mutate(lipid = str_trim(lipid, side = "both")) %>%
                   remove_rownames(.) %>%
                   left_join(., module6Lipids_VIPclasses, by = "lipid") %>%
                   dplyr::select(-c(PubChem.CID:module)) %>%
                   unique(.) %>%
                   group_by(., lipid, class, targetClass, saturation) %>%
                   summarise(across(starts_with(c("statistic.", "padj.")), ~sum(., na.rm = TRUE))) %>%
                   ungroup(.) %>%
                   mutate(., across(starts_with(c("statistic.", "padj.")), ~na_if(., 0))) %>%
                   left_join(., module6Lipids_enrichedVIP, by = "lipid") %>%
                   left_join(., module6Lipids_enrichedPhys, by = "lipid")),
            by = c("lipid", "class", "targetClass", "saturation", "statistic.13v5", "padj.13v5", 
                   "LION.0000003", "LION.0000010", "LION.0000031", "LION.0000095", "LION.0000465", "LION.0012010", "LION.0012080", "LION.0000011", "LION.0012081")) %>%
  full_join(x = ., 
            y = (module9_lipids %>% 
                   mutate(lipid = str_trim(lipid, side = "both")) %>%
                   remove_rownames(.) %>%
                   left_join(., module9Lipids_VIPclasses, by = "lipid") %>%
                   dplyr::select(-c(PubChem.CID:module)) %>%
                   unique(.) %>%
                   group_by(., lipid, class, targetClass, saturation) %>%
                   summarise(across(starts_with(c("statistic.", "padj.")), ~sum(., na.rm = TRUE))) %>%
                   ungroup(.) %>%
                   mutate(., across(starts_with(c("statistic.", "padj.")), ~na_if(., 0))) %>%
                   left_join(., module9Lipids_enrichedVIP, by = "lipid") %>%
                   left_join(., module9Lipids_enrichedPhys, by = "lipid")),
            by = c("lipid", "class", "targetClass", "saturation", "statistic.13v30", "padj.13v30", "statistic.13v5", "padj.13v5", 
                   "LION.0000003", "LION.0000010", "LION.0000031", "LION.0000095", "LION.0000465", "LION.0012010", "LION.0012080", "LION.0000011", "LION.0012081")) %>%
  full_join(x = ., 
            y = (module15_lipids %>% 
                   mutate(lipid = str_trim(lipid, side = "both")) %>%
                   remove_rownames(.) %>%
                   dplyr::select(-c(PubChem.CID:INCHIKEY)) %>%
                   unique(.) %>%
                   left_join(., module15Lipids_enrichedPhys, by = "lipid")),
            by = "lipid")
#Remove white text from each side of lipid name and remove rownames. Join with class and saturation information for VIP and remove extra columns and duplicate rows. Group by lipid, class, targetClass, and saturation to collapse values across rows. Convert 0 to NA. Join with enriched lion term information for temperature VIP and enrichment information for phys module. Combine information across modules using full_join, modifying formatting as needed.
allPhysModules_lipidAnnotations
```

```{r}
write.csv(allPhysModules_lipidAnnotations, "WCNA/lipidomics/all-phys-module-lipid-annotations.csv", quote = FALSE, row.names = FALSE) #Save as .csv
```

### Combined metabolomics and lipidomics WCNA with physiology and temperature

The next thing I want to do is run a combined WCNA with all metabolomics and lipidomics data. Then, I will correlate the combined module eigengenes with temperature and physiology. I won't use day, since day was not a significant predictor for the lipid PCA. This will allow me to identify metabolomics and lipidomics in shared pathways.

```{bash}
mkdir combined-WCNA
mkdir combined-WCNA/figures
```

#### Combine metabolite and lipid data

```{r}
rowwiseAllData <- left_join(x = rowwiseMetabData %>%
                              rownames_to_column(., var = "crab.ID"),
                            y = rowwiseLipidData %>%
                              rownames_to_column(., var = "crab.ID"),
                            by = "crab.ID") %>%
  column_to_rownames(., var = "crab.ID") #Combine metabolite and lipid data through left_join. Change crab.ID column back to rownames
head(rowwiseAllData) #Confirm dataframe creation
```

I don't need to do p over A filtering for the combined dataset, since all metabolites and all lipids were used in the downstream analysis. 

#### Network construction and consensus module detection

##### Choosing a soft-thresholding power: Analysis of a network topology β  

The soft thresholding power (β) is the number to which the co-expression similarity is raised to calculate adjacency. The function `pickSoftThreshold` performs a network topology analysis. The user chooses a set of candidate powers, however the default parameters are suitable values.  

```{r, message=FALSE, warning=FALSE}
allowWGCNAThreads()
powers <- c(c(1:20), seq(from = 12, to=20, by=2)) #Create a string of numbers from 1 through 10, and even numbers from 10 through 20
sft <-pickSoftThreshold(rowwiseAllData, powerVector = powers, verbose = 5) # Call the network topology analysis function
```

```{r}
sizeGrWindow(9, 5)
par(mfrow = c(1,2));
cex1 = 0.9;
# # # Scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
     main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     labels=powers,cex=cex1,col="red");
# # # this line corresponds to using an R^2 cut-off
abline(h=0.85,col="red")
# # # Mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1], sft$fitIndices[,5],
     xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
     main = paste("Mean connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")
```

When choosing a soft thresholding power, want to choose the lowest number that reaches the R<sup>2</sup> cutoff. From this data, it appears that the **soft thresholding power is 8**.  

##### Identify modules using `blockwiseModules`  

Use `blockwiseModules` to identify modules of metabolites.  

Settings used: 

networkType = "unsigned" 
deepSplit = 2
pamRespectsDendro = F
minModuleSize = 5
maxBlockSize = 4000
reassignThreshold = 0
mergeCutHeight = 0.25

```{r, echo=TRUE, warning=FALSE, message=FALSE}

picked_power = 8
temp_cor <- cor       
cor <- WGCNA::cor # Force it to use WGCNA cor function (fix a namespace conflict issue)
netwk <- blockwiseModules(rowwiseAllData,                         # <= input here
                          
                          # == Adjacency Function ==
                          power = picked_power,               # <= power here
                          networkType = "unsigned",
                          
                          # == Tree and Block Options ==
                          deepSplit = 2,
                          pamRespectsDendro = F,
                          # detectCutHeight = 0.75,
                          minModuleSize = 5,                  
                          maxBlockSize = 4000,
                          
                          # == Module Adjustments ==
                          reassignThreshold = 0,
                          mergeCutHeight = 0.25,
                          
                          # == TOM == Archive the run results in TOM file (saves time) but it doesn't save a file
                          saveTOMs = F,
                          saveTOMFileBase = "ER",
                          
                          # == Output Options
                          numericLabels = T,
                          verbose = 3)

cor <- temp_cor     # Return cor function to original namespace
```

```{r}
mergedColors = netwk$colors # Identify labels as numbers 
table(mergedColors)
```

Module sizes are as follows: 

0    1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19 
78 172  55  40  30  26  21  20  16  16  16  11  10   9   9   9   8   8   7   6 

```{r}
# Plot the dendrogram and the module colors underneath

#pdf("combined-WCNA/figures/cluster-dendogram-mergedME.pdf")
plotDendroAndColors(
  netwk$dendrograms[[1]],
  mergedColors[netwk$blockGenes[[1]]],
  "Module colors",
  dendroLabels = FALSE,
  hang = 0.03,
  addGuide = TRUE,
  guideHang = 0.05 )
#dev.off()
```

##### Relate modules to sample information

``` {r, echo=TRUE, warning=FALSE, message=FALSE}
module_df <- data.frame(
  Metabolite = names(netwk$colors),
  colors = netwk$colors
  #colors = labels2colors(netwk$colors)
)

module_df[1:5,]

write.csv(module_df, "combined-WCNA/combined_modules.csv")

# Get Module Eigengenes per cluster
MEs <- moduleEigengenes(rowwiseAllData, mergedColors)$eigengenes

# Reorder modules so similar modules are next to each other
MEs <- orderMEs(MEs)
module_order = names(MEs) %>% gsub("ME","", .)

# Add Sample names
MEs0 <- MEs
MEs0$crab.ID = row.names(MEs)

# tidy & plot data
mME = MEs0 %>%
  pivot_longer(-crab.ID) %>%
  mutate(
    name = gsub("ME", "", name),
    name = factor(name, levels = module_order)
  )

mME %>% ggplot(., aes(x=crab.ID, y=name, fill=value)) +
  geom_tile() +
  theme_bw() +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1,1)) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(title = "Module-Sample Relationships", y = "Modules", fill="corr")
```

##### Relate modules to treatment and day

I already have trait matrices from correlating physiology information with my existing WCNAs. I am going to do my correlations between the combined WCNA and temperature or physiology traits separately to be consistent with previous methods.

```{r}
datTraitsPhysOnly #Trait matrix for physiology data
datTraitsTempOnly <- datTraitsPhysTempLipid %>%
  dplyr::select(2:4) #Trait matrix for temperature only
datTraitsTempOnly
```

```{r}
#Define numbers of metabolites and samples and view 
nMetabolites <- ncol(rowwiseAllData)
nSamples <- nrow(rowwiseAllData)

nMetabolites #567 compounds
nSamples #69 samples
```

###### Physiology

```{r}
moduleTraitCorPhys <- cor(MEs, datTraitsPhysOnly, use = "p") #Correlations of traits with eigengenes
moduleTraitPvaluePhys <- corPvalueStudent(moduleTraitCorPhys, nSamples) #Get p-values for correlations
head(moduleTraitCorPhys %>% as.data.frame())
head(moduleTraitPvaluePhys %>% as.data.frame())
```

```{r}
moduleTraitTreePhys <- hclust(dist(t(moduleTraitCorPhys)), method = "average") #Create cluster dendogram for module-trait correlations
```

```{r}
#pdf(file = "combined-WCNA/figures/module-trait-cluster-dendogram-phys.pdf", height = 8.5, width = 11)
#plot(moduleTraitTreePhys) #Plot cluster dendogram
#dev.off()
```

###### Temperature

```{r}
moduleTraitCorTemp <- cor(MEs, datTraitsTempOnly, use = "p") #Correlations of traits with eigengenes
moduleTraitPvalueTemp <- corPvalueStudent(moduleTraitCorTemp, nSamples) #Get p-values for correlations
head(moduleTraitCorTemp %>% as.data.frame())
head(moduleTraitPvalueTemp %>% as.data.frame())
```

```{r}
moduleTraitTreeTemp <- hclust(dist(t(moduleTraitCorTemp)), method = "average") #Create cluster dendogram for module-trait correlations
```

```{r}
# pdf(file = "combined-WCNA/figures/module-trait-cluster-dendogram-temp.pdf", height = 8.5, width = 11)
plot(moduleTraitTreeTemp) #Plot cluster dendogram
# dev.off()
```

##### Append physiology to temperature correlations

```{r}
moduleTraitCorAppend <- moduleTraitCorTemp %>%
  as.data.frame(.) %>%
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitCorPhys %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitCorAppend #Confirm matrix creation
```

```{r}
moduleTraitPvalueAppend <- moduleTraitPvalueTemp %>%
  as.data.frame(.) %>%
  rownames_to_column(., var = "ME") %>%
  left_join(., y = (moduleTraitPvaluePhys %>% 
                      as.data.frame(.) %>% 
                      rownames_to_column(., var = "ME"))) %>%
  column_to_rownames(., var = "ME") %>%
  as.matrix(.) #Take previous correlations and convert to a dataframe. Convert rownames to ME column. Join with phys correlations and reconvert column to rownames. Convert back to a matrix
moduleTraitPvalueAppend #Confirm matrix creation
```

##### Plot module-trait associations

```{r, echo=TRUE, warning=FALSE, message=FALSE}
heatmappvalAppend <- signif(moduleTraitPvalueAppend, 1) #Create list of pvalues for eigengene correlation with specific traits

row_dendAppend <- dendsort(hclust(dist(moduleTraitCorAppend))) #Create dendograms for rows
col_dendAppend <- dendsort(hclust(dist(t(moduleTraitCorAppend)))) #Create dendograms for columns

trait_orderAppend <- c("Average TTR", "Oxygen Consumption", "5ºC", "13º", "30ºC") #Order of traits for heatmap
```

```{r}
# pdf(file = "combined-WCNA/figures/module-trait-relationship-heatmap-append.pdf", height = 8.5, width = 8.5)
htAppend <- Heatmap(moduleTraitCorAppend, name = "Eigengene", column_title = "Module-Group Eigengene Correlation",
                    col = blueWhiteRed(50), 
                    row_names_side = "left", 
                    row_dend_side = "left",
                    width = unit(5, "in"), 
                    height = unit(4.5, "in"), 
                    column_dend_reorder = FALSE, 
                    cluster_columns = FALSE,
                    row_dend_reorder = FALSE,  
                    column_split = c(rep("A", times = 3), rep("B", times = 2)), 
                    column_gap = unit(3, "mm"),
                    #row_split = 3, 
                    #column_dend_height = unit(.5, "in"),
                    cluster_rows = row_dendAppend, 
                    #row_gap = unit(2.5, "mm"), 
                    border = TRUE,
                    cell_fun = function(j, i, x, y, w, h, col) {
                      if(heatmappvalAppend[i, j] < 0.05) {
                        grid.text(sprintf("%s", heatmappvalAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                      }
                      else {
                        grid.text(sprintf("%s", heatmappvalAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                      }},
                    column_names_rot = 45,
                    column_names_gp =  gpar(fontsize = 12, border = FALSE),
                    column_title_gp = gpar(fontsize = 20),
                    row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)) #Create a heatmap object
draw(htAppend) #Draw heatmap
# dev.off()
```
```{r}
# svg(file = "combined-WCNA/figures/module-trait-relationship-heatmap-append.svg", height = 8.5, width = 8.5)
htAppend2 <- Heatmap(moduleTraitCorAppend, name = "Correlation", column_title = "Module-Group Eigengene Correlation",
                    # col = blueWhiteRed(50), 
                    row_names_side = "left", 
                    row_dend_side = "left",
                    width = unit(5, "in"), 
                    height = unit(4.5, "in"), 
                    column_dend_reorder = FALSE, 
                    cluster_columns = FALSE,
                    row_dend_reorder = FALSE,  
                    column_split = c(rep("A", times = 3), rep("B", times = 2)), 
                    column_gap = unit(3, "mm"),
                    #row_split = 3, 
                    #column_dend_height = unit(.5, "in"),
                    cluster_rows = row_dendAppend, 
                    #row_gap = unit(2.5, "mm"), 
                    border = TRUE,
                    cell_fun = function(j, i, x, y, w, h, col) {
                      if(heatmappvalAppend[i, j] < 0.05) {
                        grid.text(sprintf("%s", heatmappvalAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "bold"))
                      }
                      else {
                        grid.text(sprintf("%s", heatmappvalAppend[i, j]), x, y, gp = gpar(fontsize = 10, fontface = "plain"))
                      }},
                    column_names_rot = 45,
                    column_names_gp =  gpar(fontsize = 12, border = FALSE),
                    column_title_gp = gpar(fontsize = 20),
                    row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE))
draw(htAppend2) #Draw heatmap
# dev.off()
```

##### Create lists of compounds in each module

For each module, I want the compound name, but I also want all of the PubChem and KEGG ID information provided by the sequencing facility, and other annotation information. I also want to determine if a compound is a metabolite or lipid.

```{r}
module_alldfs <- list() #Create a list to save dataframes

for (i in 0:19) {
  module_alldfs[[i+1]] <- rbind(module_df %>%
                                  dplyr::rename(., Module = colors,
                                                Compound = Metabolite) %>%
                                  mutate(Compound = str_trim(Compound, side = "both")) %>%
                                  filter(., Module == i) %>%
                                  inner_join(., (rawMetabolomicsData %>%
                                                   dplyr::rename(Compound = BinBase.name) %>%
                                                   mutate(Compound = str_trim(Compound, side = "both"))),
                                             by = "Compound") %>%
                                  dplyr::select(., -c(ret.index:mass.spec, InChI.Key)) %>%
                                  mutate(class = "metabolite"), #Take metabolite information from the module of interest. Trim white space on each side of the compound name. Join with raw metabolomics data and retain columns of interest
                                module_df %>%
                                  dplyr::rename(., Module = colors,
                                                Compound = Metabolite) %>%
                                  mutate(Compound = str_trim(Compound, side = "both")) %>%
                                  filter(., Module == i) %>%
                                  inner_join(., (rawLipidomicsData %>% 
                                                   dplyr::rename(Compound = lipid) %>%
                                                   mutate(Compound = str_trim(Compound, side = "both"))),
                                             by = c("Compound")) %>%
                                  dplyr::select(., -c(identifier:ESI.mode)) %>%
                                  unique(.) %>%
                                  group_by(Compound) %>%
                                  summarise_if(is.numeric, ~sum(., na.rm = TRUE)) %>%
                                  ungroup(.) %>%
                                  mutate(., PubChem = NA,
                                         KEGG = NA,
                                         Module = i,
                                         class = "lipid") #Take lipid information from the module of interest. Trim white space on each side of the compound name. Join with raw lipid data and retain columns of interest. Concatenate any duplicate rows for lipids with the same name.
  )
} #Use a for loop to create a list of module dataframes
```

```{r}
names(module_alldfs) <- c("module0_all",
                          "module1_all",
                          "module2_all",
                          "module3_all",
                          "module4_all",
                          "module5_all",
                          "module6_all",
                          "module7_all",
                          "module8_all",
                          "module9_all",
                          "module10_all",
                          "module11_all",
                          "module12_all",
                          "module13_all",
                          "module14_all",
                          "module15_all",
                          "module16_all",
                          "module17_all",
                          "module18_all",
                          "module19_all") #Rename dataframes within list
```

```{r}
module_allInformation <- data.frame("Module" = 0:19,
                                    "Metabolites" = rep(0, times = 20),
                                    "Lipids" = rep(0, times = 20)) #Create empty dataframe to store information 
for (i in 0:19) {
  module_allInformation$Metabolites[i+1] <- nrow(module_alldfs[[i+1]] %>% filter(., class == "metabolite")) #Count the number of metabolites in specified list
  module_allInformation$Lipids[i+1] <- nrow(module_alldfs[[i+1]] %>% filter(., class == "lipid")) #Count the number of lipids in the specified list
}
head(module_allInformation) #Confirm dataframe modification
write.csv(module_allInformation, "combined-WCNA/module-information.csv", quote = FALSE, row.names = FALSE)
```

```{r}
for (i in 0:19) {
  write_delim(module_alldfs[[i+1]], paste0("combined-WCNA/module", i, "_compounds.tsv"), delim = "\t", col_names = TRUE)
} #Save each module dataframe from list as a tab-delimted file
```

##### Interpret correlations

I am going to focus on modules that had correlations with temperature and physiology, since I want this analysis to provide insight into how metabolite-lipid interactions impact whole-organism responses.

- ME3: Negatively correlated with 5ºC, negatively correlated with righting response, positively correlated with oxygen consumption
- ME6: Negatively correlated with 5ºC, negatively correlated with TTR
- ME13: Negatively correlated with 5ºC, positively correlated with 30ºC, negatively correlated with TTR
- ME11: Negatively correlated with 30ºC, negatively correlated with oxygen consumption

```{r}
module_allInformation %>%
  filter(., Module == 3 | Module == 6 | Module == 13 | Module == 11)
```

It's interesting to see that the majority of these modules contain either metabolites or lipids — not both! That in itself suggests that metabolites and lipids have unique roles in regulating the physiological endpoints we are interested in. My next step is annotate the compounds in these modules.

```{r}
names(module_alldfs)
```

###### Module 3

```{r}
module3_allMetabAnnot <- module_alldfs[[4]] %>%
  dplyr::select(Compound:KEGG, class) %>%
  filter(., class == "metabolite") %>%
  mutate(., respirationMetabolites = case_when(Compound %in% respirationMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                               Compound %in% respirationMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., calciumSignalingMetabolites = case_when(Compound %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                    Compound %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., coldProtectionMetabolites = case_when(Compound %in% coldProtectionMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                  Compound %in% coldProtectionMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  left_join(x = .,
            y = read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
              dplyr::select(metabolite, comparison) %>%
              mutate(metabolite = str_trim(metabolite, side = "both")) %>%
              pivot_wider(., id_cols = metabolite, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
              mutate(., VIP13v30_day22 = case_when(is.na(VIP13v30_day22) == FALSE ~ "Y",
                                                   is.na(VIP13v30_day22) == TRUE ~ "N")) %>%
              mutate(., VIP13v5_day22 = case_when(is.na(VIP13v5_day22) == FALSE ~ "Y",
                                                  is.na(VIP13v5_day22) == TRUE ~ "N")) %>%
              mutate(., VIP5_day3v22 = case_when(is.na(VIP5_day3v22) == FALSE ~ "Y",
                                                 is.na(VIP5_day3v22) == TRUE ~ "N")) %>%
              dplyr::rename(., Compound = metabolite),
            by = "Compound") %>%
  mutate(., VIP13v30_day22 = case_when(is.na(VIP13v30_day22) == TRUE ~ "N",
                                       is.na(VIP13v30_day22) == FALSE ~ VIP13v30_day22)) %>%
  mutate(., VIP13v5_day22 = case_when(is.na(VIP13v5_day22) == TRUE ~ "N",
                                      is.na(VIP13v5_day22) == FALSE ~ VIP13v5_day22)) %>%
  mutate(., VIP5_day3v22 = case_when(is.na(VIP5_day3v22) == TRUE ~ "N",
                                     is.na(VIP5_day3v22) == FALSE ~ VIP5_day3v22)) %>%
  mutate(., valineBiosynthesis = case_when(Compound %in% valineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                           Compound %in% valineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., arginineBiosynthesis = case_when(Compound %in% arginineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                             Compound %in% arginineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., glutathioneMetabolism = case_when(Compound %in% glutathioneMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                              Compound %in% glutathioneMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., alanineMetabolism = case_when(Compound %in% alanineMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                          Compound %in% alanineMetabolism %>% str_trim(., side = "both") == FALSE ~ "N"))


#Take module information and retain columns of interest. Subset for metabolite information. Add annotation information for a priori pathways, VIP for temperature treatments, and enrichment for temperature treatment.
head(module3_allMetabAnnot)
```

```{r}
write_delim(module3_allMetabAnnot, "combined-WCNA/module3_metabolite-annotations.tsv", delim = "\t", col_names = TRUE) #Save annotations
```

```{r}
module3_allLipidAnnot <- module_alldfs[[4]] %>%
  dplyr::select(Compound:KEGG, class) %>%
  filter(., class == "lipid") %>%
  left_join(x = .,
            y = read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
              dplyr::select(lipid, comparison) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              dplyr::rename(Compound = lipid) %>%
              unique(.) %>%
              pivot_wider(., id_cols = Compound, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
              mutate(., VIP13v30 = case_when(is.na(VIP13v30) == FALSE ~ "Y",
                                             is.na(VIP13v30) == TRUE ~ "N")) %>%
              mutate(., VIP13v5 = case_when(is.na(VIP13v5) == FALSE ~ "Y",
                                            is.na(VIP13v5) == TRUE ~ "N")) ,
            by = "Compound") %>%
  mutate(., VIP13v30 = case_when(is.na(VIP13v30) == TRUE ~ "N",
                                 is.na(VIP13v30) == FALSE ~ VIP13v30)) %>%
  mutate(., VIP13v5 = case_when(is.na(VIP13v5) == TRUE ~ "N",
                                is.na(VIP13v5) == FALSE ~ VIP13v5)) %>%
  left_join(x = .,
            y = significantVIP_13v30_annot %>%
              rbind(significantVIP_13v5_annot) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              dplyr::select(lipid, class:saturation) %>%
              unique(.) %>%
              dplyr::rename(lipidClass = class,
                            Compound = lipid),
            by = "Compound") %>%
  left_join(x = .,
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
              rownames_to_column(., var = "Compound"),
            by = "Compound") %>%
  left_join(x = ., 
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
              rownames_to_column(., var = "Compound")) %>%
  mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                     LION.0000003 != "x" ~ NA)) %>%
  mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                     LION.0000010 != "x" ~ NA)) %>% 
  mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                     LION.0000031 != "x" ~ NA)) %>% 
  mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                     LION.0000095 != "x" ~ NA)) %>%   
  mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                     LION.0000465 != "x" ~ NA)) %>%    
  mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                     LION.0012010 != "x" ~ NA)) %>%
  mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                     LION.0012080 != "x" ~ NA)) %>%
  mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                     LION.0000011 != "x" ~ NA)) %>%
  mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                     LION.0012081 != "x" ~ NA))
#Take module information and retain columns of interest. Subset for lipid information. Add annotation information for VIP for temperature treatments, class and saturation state for VIP, and enrichment for temperature treatment.
head(module3_allLipidAnnot)
```

```{r}
module3_allLipidAnnot %>% 
  group_by(saturation, targetClass) %>% 
  summarise(., count = n())
module3_allLipidAnnot %>%
  filter(., VIP13v5 == "Y")
```


```{r}
write_delim(module3_allLipidAnnot, "combined-WCNA/module3_lipid-annotations.tsv", delim = "\t", col_names = TRUE) #Save annotations
```

###### Module 6

```{r}
module6_allLipidAnnot <- module_alldfs[[7]] %>%
  dplyr::select(Compound, PubChem:KEGG, class) %>%
  filter(., class == "lipid") %>%
  left_join(x = .,
            y = read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
              dplyr::select(lipid, comparison) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              dplyr::rename(Compound = lipid) %>%
              unique(.) %>%
              pivot_wider(., id_cols = Compound, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
              mutate(., VIP13v30 = case_when(is.na(VIP13v30) == FALSE ~ "Y",
                                             is.na(VIP13v30) == TRUE ~ "N")) %>%
              mutate(., VIP13v5 = case_when(is.na(VIP13v5) == FALSE ~ "Y",
                                            is.na(VIP13v5) == TRUE ~ "N")) ,
            by = "Compound") %>%
  mutate(., VIP13v30 = case_when(is.na(VIP13v30) == TRUE ~ "N",
                                 is.na(VIP13v30) == FALSE ~ VIP13v30)) %>%
  mutate(., VIP13v5 = case_when(is.na(VIP13v5) == TRUE ~ "N",
                                is.na(VIP13v5) == FALSE ~ VIP13v5)) %>%
  left_join(x = .,
            y = significantVIP_13v30_annot %>%
              rbind(significantVIP_13v5_annot) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              dplyr::select(lipid, class:saturation) %>%
              unique(.) %>%
              dplyr::rename(lipidClass = class,
                            Compound = lipid),
            by = "Compound") %>%
  left_join(x = .,
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
              rownames_to_column(., var = "Compound"),
            by = "Compound") %>%
  left_join(x = ., 
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
              rownames_to_column(., var = "Compound")) %>%
  mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                     LION.0000003 != "x" ~ NA)) %>%
  mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                     LION.0000010 != "x" ~ NA)) %>% 
  mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                     LION.0000031 != "x" ~ NA)) %>% 
  mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                     LION.0000095 != "x" ~ NA)) %>%   
  mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                     LION.0000465 != "x" ~ NA)) %>%    
  mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                     LION.0012010 != "x" ~ NA)) %>%
  mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                     LION.0012080 != "x" ~ NA)) %>%
  mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                     LION.0000011 != "x" ~ NA)) %>%
  mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                     LION.0012081 != "x" ~ NA))
#Take module information and retain columns of interest. Subset for lipid information. Add annotation information for VIP for temperature treatments, class and saturation state for VIP, and enrichment for temperature treatment.
head(module6_allLipidAnnot)
```

```{r}
write_delim(module6_allLipidAnnot, "combined-WCNA/module6_lipid-annotations.tsv", delim = "\t", col_names = TRUE) #Save annotations
```

###### Module 13

```{r}
module13_allAnnot <- module_alldfs[[14]] %>%
  dplyr::select(Compound:KEGG, class) %>%
  filter(., class == "metabolite") %>%
  mutate(., respirationMetabolites = case_when(Compound %in% respirationMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                               Compound %in% respirationMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., calciumSignalingMetabolites = case_when(Compound %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                    Compound %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., coldProtectionMetabolites = case_when(Compound %in% coldProtectionMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                  Compound %in% coldProtectionMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  left_join(x = .,
            y = read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
              dplyr::select(metabolite, comparison) %>%
              mutate(metabolite = str_trim(metabolite, side = "both")) %>%
              pivot_wider(., id_cols = metabolite, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
              mutate(., VIP13v30_day22 = case_when(is.na(VIP13v30_day22) == FALSE ~ "Y",
                                                   is.na(VIP13v30_day22) == TRUE ~ "N")) %>%
              mutate(., VIP13v5_day22 = case_when(is.na(VIP13v5_day22) == FALSE ~ "Y",
                                                  is.na(VIP13v5_day22) == TRUE ~ "N")) %>%
              mutate(., VIP5_day3v22 = case_when(is.na(VIP5_day3v22) == FALSE ~ "Y",
                                                 is.na(VIP5_day3v22) == TRUE ~ "N")) %>%
              dplyr::rename(., Compound = metabolite),
            by = "Compound") %>%
  mutate(., VIP13v30_day22 = case_when(is.na(VIP13v30_day22) == TRUE ~ "N",
                                       is.na(VIP13v30_day22) == FALSE ~ VIP13v30_day22)) %>%
  mutate(., VIP13v5_day22 = case_when(is.na(VIP13v5_day22) == TRUE ~ "N",
                                      is.na(VIP13v5_day22) == FALSE ~ VIP13v5_day22)) %>%
  mutate(., VIP5_day3v22 = case_when(is.na(VIP5_day3v22) == TRUE ~ "N",
                                     is.na(VIP5_day3v22) == FALSE ~ VIP5_day3v22)) %>%
  mutate(., valineBiosynthesis = case_when(Compound %in% valineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                           Compound %in% valineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., arginineBiosynthesis = case_when(Compound %in% arginineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                             Compound %in% arginineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., glutathioneMetabolism = case_when(Compound %in% glutathioneMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                              Compound %in% glutathioneMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
  mutate(., alanineMetabolism = case_when(Compound %in% alanineMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                          Compound %in% alanineMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")) #Take module information and retain columns of interest. Subset for metabolite information. Add annotation information for a priori pathways, VIP for temperature treatments, and enrichment for temperature treatment.
head(module13_allAnnot)
```

```{r}
write_delim(module13_allAnnot, "combined-WCNA/module13_metabolite-annotations.tsv", delim = "\t", col_names = TRUE) #Save annotations
```

```{r}
module13_allAnnot
```

###### Module 11

```{r}
module11_allLipidAnnot <- module_alldfs[[12]] %>%
  dplyr::select(Compound, PubChem:KEGG, class) %>%
  filter(., class == "lipid") %>%
  left_join(x = .,
            y = read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
              dplyr::select(lipid, comparison) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              dplyr::rename(Compound = lipid) %>%
              unique(.) %>%
              pivot_wider(., id_cols = Compound, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
              mutate(., VIP13v30 = case_when(is.na(VIP13v30) == FALSE ~ "Y",
                                             is.na(VIP13v30) == TRUE ~ "N")) %>%
              mutate(., VIP13v5 = case_when(is.na(VIP13v5) == FALSE ~ "Y",
                                            is.na(VIP13v5) == TRUE ~ "N")) ,
            by = "Compound") %>%
  mutate(., VIP13v30 = case_when(is.na(VIP13v30) == TRUE ~ "N",
                                 is.na(VIP13v30) == FALSE ~ VIP13v30)) %>%
  mutate(., VIP13v5 = case_when(is.na(VIP13v5) == TRUE ~ "N",
                                is.na(VIP13v5) == FALSE ~ VIP13v5)) %>%
  left_join(x = .,
            y = significantVIP_13v30_annot %>%
              rbind(significantVIP_13v5_annot) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              dplyr::select(lipid, class:saturation) %>%
              unique(.) %>%
              dplyr::rename(lipidClass = class,
                            Compound = lipid),
            by = "Compound") %>%
  left_join(x = .,
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
              rownames_to_column(., var = "Compound"),
            by = "Compound") %>%
  left_join(x = ., 
            y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
              slice(-1) %>%
              mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
              rename(lipid = LION.term) %>%
              mutate(lipid = str_trim(lipid, side = "both")) %>%
              unique(.) %>%
              remove_rownames() %>%
              column_to_rownames(., var = "lipid") %>%
              dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
              rownames_to_column(., var = "Compound")) %>%
  mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                     LION.0000003 != "x" ~ NA)) %>%
  mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                     LION.0000010 != "x" ~ NA)) %>% 
  mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                     LION.0000031 != "x" ~ NA)) %>% 
  mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                     LION.0000095 != "x" ~ NA)) %>%   
  mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                     LION.0000465 != "x" ~ NA)) %>%    
  mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                     LION.0012010 != "x" ~ NA)) %>%
  mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                     LION.0012080 != "x" ~ NA)) %>%
  mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                     LION.0000011 != "x" ~ NA)) %>%
  mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                     LION.0012081 != "x" ~ NA))
#Take module information and retain columns of interest. Subset for lipid information. Add annotation information for VIP for temperature treatments, class and saturation state for VIP, and enrichment for temperature treatment.
head(module11_allLipidAnnot)
```

```{r}
module11_allLipidAnnot %>% 
  group_by(saturation, targetClass) %>% 
  summarise(., count = n())
module11_allLipidAnnot %>%
  filter(., VIP13v30 == "Y")
```

```{r}
write_delim(module11_allLipidAnnot, "combined-WCNA/module11_lipid-annotations.tsv", delim = "\t", col_names = TRUE) #Save annotations
```

##### Visualize results

###### Plot mean eigengene values for each module

```{r}
#Ensure metadata columns are factors
metabolomicsMetadata$crab.ID <- as.factor(metabolomicsMetadata$crab.ID)
metabolomicsMetadata$treatment <- as.factor(metabolomicsMetadata$treatment)
metabolomicsMetadata$day <- as.factor(metabolomicsMetadata$day)
metabolomicsMetadata$treatment_day <- as.factor(metabolomicsMetadata$treatment_day)
```

```{r}
mME_all <- merge(mME, metabolomicsMetadata, by = "crab.ID") %>%
  rename(Module = name) %>%
  dplyr::select(-treatment_day) %>%
  remove_rownames()
#Create new dataframe with metadata
head(mME_all) #Confirm dataframe creation
```

```{r}
write.csv(combined-WCNA/mME_all, "module-expression.csv", quote = FALSE, row.names = FALSE) #Save module expression dataframe
```

```{r, warning = FALSE, message = FALSE}
mME_all %>%
  ggplot(aes(x = treatment, y = value, colour = treatment)) +
  facet_wrap(~ Module) +
  ylab("Module Expression") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey")+
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  stat_summary(fun=mean, geom="line", aes(group = treatment, color = treatment), position = position_dodge(width = 0.5))  + 
  geom_point(pch = 21, position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Temperature (ºC)", 
                    values = c("#2171B5", "#525252", "#CB181D"),
                    labels = c("5ºC", "13ºC", "30ºC")) +
  scale_colour_manual(name = "Temperature (ºC)", 
                      values = c("#2171B5", "#525252", "#CB181D"),
                      labels = c("5ºC", "13ºC", "30ºC")) +
  xlab("") + #Axis titles
  theme_classic(base_size = 15) + theme(axis.text.x = element_text(color = "white"),
                                        axis.ticks.x = element_blank()) #Create a boxplot with data points for module expression on the y-axis and values for each treatment combination. Facet by module eigengene. Add a horizontal line at y = 0.
ggsave("combined-WCNA/figures/eigengene-expression-boxplot.pdf", height = 8.5, width = 11)
```

```{r}
module_facets <- c("1" = "ME 3",
                   "2" = "ME 6",
                   "3" = "ME 11",
                   "4" = "ME 13") #Assign labels for facets
```


```{r, warning = FALSE, message = FALSE}
mME_all %>%
  filter(., Module == "3" | Module == "6" | Module == "11" | Module == "13") %>%
  mutate(order = case_when(Module == "3" ~ "1",
                            Module == "6" ~ "2",
                            Module == "11" ~ "3",
                            Module == "13" ~ "4")) %>%
  ggplot(aes(x = treatment, y = value, colour = treatment)) +
  facet_wrap(~ order, labeller = labeller(order = module_facets)) +
  ylab("Module Expression") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey")+
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  stat_summary(fun=mean, geom="line", aes(group = treatment, color = treatment), position = position_dodge(width = 0.5))  + 
  geom_point(pch = 21, position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Temperature (ºC)", 
                    values = c("#2171B5", "#525252", "#CB181D"),
                    labels = c("5ºC", "13ºC", "30ºC")) +
  scale_colour_manual(name = "Temperature (ºC)", 
                      values = c("#2171B5", "#525252", "#CB181D"),
                      labels = c("5ºC", "13ºC", "30ºC")) +
  xlab("") + #Axis titles
  theme_classic(base_size = 15) + theme(axis.text.x = element_text(color = "white"),
                                        axis.ticks.x = element_blank()) #Create a boxplot with data points for module expression on the y-axis and values for each treatment combination. Facet by module eigengene. Add a horizontal line at y = 0.
ggsave("combined-WCNA/figures/sig-modules-expression-boxplot.pdf", height = 8.5, width = 11)
```

###### Plot abundance for compounds in each module

```{r}
rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% module_alldfs[[3+1]]$Compound) %>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  dplyr::select(-c(day:treatment_day)) %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:2), names_to = "compound", values_to = "value") %>%
  mutate(., compound = str_trim(compound, side = "both")) %>%
  group_by(crab.ID, treatment, compound) %>%
  summarise_if(is.numeric, ~sum(., na.rm = TRUE)) %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~compound, scales = "free_y") +
  ylab("ME 3 Compound Abundance") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Temperature (ºC)", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(name = "Temperature (ºC) ", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        legend.position = "bottom", 
                                        legend.title = element_text(size = 10),
                                        legend.text = element_text(color = "black", size = 8), 
                                        strip.text.x = element_text(size = 4.5, color = "black", face="bold"))
ggsave("combined-WCNA/figures/ME3-compound-abundance.pdf", height = 8.5, width = 11)
```

```{r}
rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% module_alldfs[[6+1]]$Compound) %>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  dplyr::select(-c(day:treatment_day)) %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:2), names_to = "compound", values_to = "value") %>%
  mutate(., compound = str_trim(compound, side = "both")) %>%
  group_by(crab.ID, treatment, compound) %>%
  summarise_if(is.numeric, ~sum(., na.rm = TRUE)) %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~compound, scales = "free_y") +
  ylab("ME 6 Compound Abundance") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Temperature (ºC)", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(name = "Temperature (ºC) ", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        legend.position = "bottom", 
                                        legend.title = element_text(size = 10),
                                        legend.text = element_text(color = "black", size = 8), 
                                        strip.text.x = element_text(size = 7, color = "black", face="bold"))
ggsave("combined-WCNA/figures/ME6-compound-abundance.pdf", height = 8.5, width = 11)
```

```{r}
rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% module_alldfs[[11+1]]$Compound) %>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  dplyr::select(-c(day:treatment_day)) %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:2), names_to = "compound", values_to = "value") %>%
  mutate(., compound = str_trim(compound, side = "both")) %>%
  group_by(crab.ID, treatment, compound) %>%
  summarise_if(is.numeric, ~sum(., na.rm = TRUE)) %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~compound, scales = "free_y") +
  ylab("ME 11 Compound Abundance") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Temperature (ºC)", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(name = "Temperature (ºC) ", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        legend.position = "bottom", 
                                        legend.title = element_text(size = 10),
                                        legend.text = element_text(color = "black", size = 8), 
                                        strip.text.x = element_text(size = 10, color = "black", face="bold"))
ggsave("combined-WCNA/figures/ME11-compound-abundance.pdf", height = 8.5, width = 11)
```

```{r}
rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% module_alldfs[[13+1]]$Compound) %>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  dplyr::select(-c(day:treatment_day)) %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:2), names_to = "compound", values_to = "value") %>%
  mutate(., compound = str_trim(compound, side = "both")) %>%
  group_by(crab.ID, treatment, compound) %>%
  summarise_if(is.numeric, ~sum(., na.rm = TRUE)) %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~compound, scales = "free_y") +
  ylab("ME 13 Compound Abundance") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Temperature (ºC)", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(name = "Temperature (ºC) ", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        legend.position = "bottom", 
                                        legend.title = element_text(size = 10),
                                        legend.text = element_text(color = "black", size = 8), 
                                        strip.text.x = element_text(size = 10, color = "black", face="bold"))
ggsave("combined-WCNA/figures/ME13-compound-abundance.pdf", height = 8.5, width = 11)
```

## Individual metabolite and lipid correlations with DIABLO

- [`mixOmics` vignette](https://mixomicsteam.github.io/mixOmics-Vignette/id_06.html)
- [DIABLO case study](https://mixomics.org/mixdiablo/diablo-tcga-case-study/)
- [Ariana's lab notebook](https://ahuffmyer.github.io/ASH_Putnam_Lab_Notebook/Multi-Omic-Integration-Analysis-Part-1/)

```{bash}
mkdir DIABLO
mkdir DIABLO/figures
```

### Run SPLS

The first step before running a DIABLO is to investigate correlations between the component variables. I've already done some of that with the WCNAs, but I will run an SPLS separately for the metabolomics and lipidomics data.

```{r}
list.keepX = c(25, 25) # select arbitrary values of features to keep
list.keepY = c(25, 25)
```

```{r}
X <- log(transMetabData[c(5:156)]) #Assign known metabolite data to the X dataframe after log transformation
Y <- log(knownTransLipidData[-c(1:4)])  %>%
  mutate_if(is.numeric, list(~na_if(., -Inf))) %>%
  replace(is.na(.), 0) #Assign known metabolite data to the X dataframe after log transformation
```

```{r}
pls1 <- spls(X, Y, 
             keepX = list.keepX, keepY = list.keepY) #Generate PLS model for metabolomics and lipidomics
```

```{r}
# plot features of first PLS
plotVar(pls1, cutoff = 0.5, title = "metabolomics vs. lipidomics", 
        legend = c("metabolomics", "lipidomics"), 
        var.names = FALSE, style = 'graphics', 
        pch = c(16, 17), cex = c(2,2), 
        col = c('darkorchid', 'lightgreen'))
```

Some of the features have very strong clustering while other do not, suggesting that some features of the metabolomics and lipidomics dataframes are highly correlated. This agrees with what I saw with WCNAs. Unclear if clustering is stronger across component 1 or 2 (everyone's just hanging out in that bottom left quadrant). I'm going to rerun the PLS with one component to get a better idea of the correlation.

```{r}
res1.pls.tcga <- pls(X, Y, ncomp = 1)
cor(res1.pls.tcga$variates$X, res1.pls.tcga$variates$Y) #Metabolites and lipids are highly correlated
```


### Run DIABLO

#### All known molecules

##### Tune parameters

```{r}
dataML <- list("Metabolites" = X, "Lipids" = Y) #Store metabolite and lipid data as a list
outcomeML <- transMetabData$treatment #Outcome information is what I want the DIABLO to classify, which in this case is temperature.
```

```{r}
designML <- matrix(cor(res1.pls.tcga$variates$X, res1.pls.tcga$variates$Y), 
                   ncol = length(dataML), nrow = length(dataML), 
                   dimnames = list(names(dataML), names(dataML))) #Create a matrix with the design of the DIABLO experiment. Lower weights increase predictive capability. I am using a correlation based on previous PLS
diag(designML) <- 0
designML 
```

```{r}
diablo.tcga.ML <- block.plsda(X = dataML, 
                              Y = outcomeML, 
                              ncomp = 5, 
                              design = designML) #Run a DIABLO analysis to identify the number of components that should be included

perf.diablo.tcga.ML = perf(diablo.tcga.ML, validation = 'Mfold', folds = 10, nrepeat = 10)

perf.diablo.tcga.ML$error.rate  # Lists the different types of error rates
```

```{r}
# Plot of the error rates based on weighted vote
plot(perf.diablo.tcga.ML) #Based on the plot, 4 components should be chosen for classification. Max distance and BER offer the lowest classification error rates
perf.diablo.tcga.ML$choice.ncomp$WeightedVote #Confirm that 4 components is the best decision based on the table
ncompML <- perf.diablo.tcga.ML$choice.ncomp$WeightedVote["Overall.BER", "mahalanobis.dist"] #The number of components that should be chosen
```

The analysis says to use 4 components. However, my variable of interest is temperature, which has 3 conditions maximum. Therefore, I will only use 3 components.

```{r}
# chunk takes about 2 min to run
set.seed(123) # for reproducibility
test.keep.ML <- list(metabolomics = c(5:9, seq(10, 100, 5)),
                     lipidomics = c(5:9, seq(10, 100, 5)))

tune.diablo.ML <- tune.block.splsda(X = dataML, Y = outcomeML, ncomp = 3, 
                                    test.keepX = test.keep.ML, design = designML,
                                    validation = 'Mfold', folds = 10, nrepeat = 1, 
                                    BPPARAM = BiocParallel::SnowParam(workers = 2),
                                    dist = "mahalanobis.dist")

list.keep.ML <- tune.diablo.ML$choice.keepX
```
##### Run analysis

```{r}
diablo.tcga.ML <- block.splsda(X = dataML, Y = outcomeML, 
                               ncomp = 3,
                               keepX = list.keep.ML,
                               design = designML) #Run DIABLO with all variables tested above
diablo.tcga.ML$design #Outcomes now included in the design so that the covariance between each block’s component and the outcome is maximised
```

##### Visualize output

```{r}
plotDiablo(diablo.tcga.ML, ncomp = 1)
plotDiablo(diablo.tcga.ML, ncomp = 2)
plotDiablo(diablo.tcga.ML, ncomp = 3)
```

```{r}
plotIndiv(diablo.tcga.ML, ind.names = FALSE, legend = TRUE, 
          title = 'DIABLO comp 1 - 2') #Easier to classify 30 group in both datasets, harder to discriminate between 5 and 13
```

```{r}
# pdf("DIABLO/figures/circos-metabolite-lipids.pdf")
circosPlot(diablo.tcga.ML, cutoff = 0.70, line = FALSE, 
           color.blocks = c('plum1', 'lightgreen'),
           color.cor = c("chocolate3","grey20"), 
           size.labels = 1,
           legend.title = "Temperature (ºC)", color.Y = rev(plotColors)) #Use circos plot to visualise correlations between individual metabolites and lipids
# dev.off()
```
- remove temperature lines
- increase font size (if possible)

The plot shows that there are very few correlations between compounds. When I messed around with the correlations, I could only get this plot when corr < 0.75, so these aren't very strong correlations to begin with. The current functionality (`cor_matML <- circosPlot(diablo.tcga.ML, cutoff = 0.70)`) pulls out correlations projected onto the components, which isn't helpful for understanding individual compounds that are correlated with eachother (see [this link](https://mixomics-users.discourse.group/t/diablo-circosplot-export-correlation-matrix/22).

```{r}
pdf("DIABLO/figures/circos-metabolite-lipids-intralink.pdf")
circosPlot(diablo.tcga.ML, cutoff = 0.70, line = TRUE, showIntraLinks = TRUE,
           color.blocks = c('plum1', 'lightgreen'),
           color.cor = c("chocolate3","grey20"), 
           size.labels = 1,
           legend.title = "Temperature (ºC)", color.Y = rev(plotColors)) #Use circos plot to visualise correlations between individual metabolites and lipids
dev.off()
```

It's interesting (and kind of obvious) that there are much stronger correlations within a block than between blocks!

#### Only VIP molecules

I'm going to run DIABLO again, but this time use just VIP molecules in the input list.

##### Format input data

```{r}
metaboliteVIP <- read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>% dplyr::select(metabolite) %>% unique(.) #Save list of unique VIP metabolites
```

```{r}
X.VIP <- X %>%
  dplyr::select(any_of(metaboliteVIP$metabolite)) #Metabolomics data but only VIP
head(X.VIP) #Confirm changes
```

```{r}
lipidVIP <- rbind(significantVIP_13v30_annot,
                  significantVIP_13v5_annot) %>%
  dplyr::select(lipid) %>%
  unique(.) #Save list of unique VIP lipids
```

```{r}
Y.VIP <- Y %>%
  dplyr::select(any_of(lipidVIP$lipid)) #Lipid data but only VIP
head(Y.VIP) #Confirm changes
```

##### Tune parameters

```{r}
dataML.VIP <- list("Metabolites" = X.VIP, "Lipids" = Y.VIP) #Store metabolite and lipid data VIPs as a list
```

```{r}
diablo.ML.VIP <- block.plsda(X = dataML.VIP, 
                             Y = outcomeML, 
                             ncomp = 5, 
                             design = designML) #Run a DIABLO analysis to identify the number of components that should be included

perf.diablo.ML.VIP = perf(diablo.ML.VIP, validation = 'Mfold', folds = 10, nrepeat = 10)

perf.diablo.ML.VIP$error.rate  # Lists the different types of error rates
```

```{r}
# Plot of the error rates based on weighted vote
plot(perf.diablo.ML.VIP) #Based on the plot, 3 components should be chosen for classification. Max distance and BER offer the lowest classification error rates
perf.diablo.ML.VIP$choice.ncomp$WeightedVote #Confirm that 3 components is the best decision based on the table
ncompML <- perf.diablo.ML.VIP$choice.ncomp$WeightedVote["Overall.BER", "mahalanobis.dist"] #The number of components that should be chosen
```

The analysis says to use 4 components. However, my variable of interest is temperature, which has 3 conditions maximum. Therefore, I will only use 3 components.

```{r}
# chunk takes about 2 min to run
set.seed(123) # for reproducibility
test.keep.ML <- list(metabolomics = c(5:9, seq(10, 100, 5)),
                     lipidomics = c(5:9, seq(10, 100, 5)))

tune.diablo.ML.VIP <- tune.block.splsda(X = dataML, Y = outcomeML, ncomp = 3, 
                                        test.keepX = test.keep.ML, design = designML,
                                        validation = 'Mfold', folds = 10, nrepeat = 1, 
                                        BPPARAM = BiocParallel::SnowParam(workers = 2),
                                        dist = "mahalanobis.dist")

list.keep.ML.VIP <- tune.diablo.ML.VIP$choice.keepX
```

##### Run analysis

```{r}
diablo.ML.VIP <- block.splsda(X = dataML.VIP, Y = outcomeML, 
                              ncomp = 3,
                              keepX = list.keep.ML.VIP,
                              design = designML) #Run DIABLO with all variables tested above
diablo.ML.VIP$design #Outcomes now included in the design so that the covariance between each block’s component and the outcome is maximised
```

##### Visualize output

```{r}
plotDiablo(diablo.ML.VIP, ncomp = 1)
plotDiablo(diablo.ML.VIP, ncomp = 2)
plotDiablo(diablo.ML.VIP, ncomp = 3)
```

```{r}
plotIndiv(diablo.ML.VIP, ind.names = FALSE, legend = TRUE, 
          title = 'DIABLO comp 1 - 2') #Easier to classify 30 group in both datasets, harder to discriminate between 5 and 13
```

```{r}
pdf("DIABLO/figures/circos-metabolite-lipids-VIP.pdf")
circosPlot(diablo.ML.VIP, cutoff = 0.70, line = FALSE, 
           color.blocks = c('plum1', 'lightgreen'),
           color.cor = c("chocolate3","grey20"), 
           size.labels = 0.001, size.variables = 0.35,
           legend.title = "Temperature (ºC)", color.Y = rev(plotColors)) #Use circos plot to visualise correlations between individual metabolites and lipids. Get rid of the temperature lines. Modify the size of the labels (metabolites vs. lipids) and the size of the variables (compound names)
dev.off()
```

The plot shows that there are very few correlations between compounds. This time there were a handful of compounds that had stronger correlations (> 0.8), but still not a huge difference in terms of correlation strength. The temperature lines aren't that much clearer, but I think focusing on VIP could make the discussion narrative a lot clearer.

```{r}
pdf("DIABLO/figures/circos-metabolite-lipids-intralink-VIP.pdf")
circosPlot(diablo.ML.VIP, cutoff = 0.70, line = TRUE, showIntraLinks = TRUE,
           color.blocks = c('plum1', 'lightgreen'),
           color.cor = c("chocolate3","grey20"), 
           size.labels = 1,
           legend.title = "Temperature (ºC)", color.Y = rev(plotColors)) #Use circos plot to visualise correlations between individual metabolites and lipids
dev.off()
```

I also want to create plots that show the abundance of each molecule in my three temperature conditions so I can understand how the abundances are correlated.

```{r}
metabolite_facets <- c("1" = "myo-inositol",
                       "2" = "hydroquinone",
                       "3" = "threonine") #Assign labels for facets
```

```{r}
diablo.metPlot <- rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% c(diablo.ML.VIP.group1[1], diablo.ML.VIP.group2[1], diablo.ML.VIP.group3[1]))%>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:4), names_to = "compound", values_to = "value") %>%
  mutate(., order = case_when(compound == "myo-inositol" ~ 1,
                              compound == "hydroquinone" ~ 2,
                              compound == "threonine" ~ 3)) %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~order, scales = "free_y", ncol = 1, labeller = labeller(order = metabolite_facets)) +
  ylab("Metabolite Abundance") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Temperature (ºC)", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(name = "Temperature (ºC) ", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        legend.justification = c(0,1), legend.position = c(0,1), 
                                        legend.title = element_text(size = 10),
                                        legend.text = element_text(color = "black", size = 8), 
                                        strip.text.x = element_text(size = 10, color = "black", face="bold"))
diablo.metPlot
```

```{r}
diabloLipid1 <- rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% diablo.ML.VIP.group1[-1]) %>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:4), names_to = "compound", values_to = "value") %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~compound, scales = "free_y") +
  ylab("") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(guide = "none", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(guide = "none",
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  ggtitle("Lipids Negatively Correlated with Myo-Inositol") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        strip.text.x = element_text(size = 7, color = "black", face="bold"))
diabloLipid1
```

```{r}
diabloLipid2 <- rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% diablo.ML.VIP.group2[-1]) %>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:4), names_to = "compound", values_to = "value") %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~compound, scales = "free_y") +
  ylab("Lipid Abundance") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(guide = "none", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(guide = "none",
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  ggtitle("Lipids Negatively Correlated with Hydroquinone") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        strip.text.x = element_text(size = 7, color = "black", face="bold"))
diabloLipid2
```

```{r}
diabloLipid3 <- rowwiseAllData %>%
  dplyr::select_if(colnames(.) %>% str_trim(., side = "both") %in% diablo.ML.VIP.group3[-1]) %>%
  rownames_to_column(., var = "crab.ID") %>%
  left_join(x = metabolomicsMetadata,
            y = .,
            by = "crab.ID") %>%
  mutate(., treatment = gsub(pattern = "5", replacement = "05", x = treatment)) %>%
  pivot_longer(., cols = -c(1:4), names_to = "compound", values_to = "value") %>%
  ggplot(., mapping = aes(x = treatment, y = value, color = treatment)) +
  facet_wrap(~compound, scales = "free_y") +
  ylab("") +
  geom_boxplot(width = 0.5, position = position_dodge(width = 0.5), alpha = 0.7) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_fill_manual(guide = "none", 
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  scale_colour_manual(guide = "none",
                    values = rev(plotColors),
                    labels = c("5", "13", "30")) +
  xlab("") +
  ggtitle("Lipids Positively Correlated with Threonine") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        strip.text.x = element_text(size = 7, color = "black", face="bold"))
diabloLipid3
```

```{r}
(diablo.metPlot | (diabloLipid1 / diabloLipid2 / diabloLipid3)) + plot_layout(widths = c(1,3)) #Assemble plot and change column widths
ggsave("DIABLO/figures/correlated-metabolties-lipids.pdf", height = 14, width = 11)
```

##### Annotate output

```{r}
#Create vectors of correlated molecules
diablo.ML.VIP.group1 <- c("myo-inositol", "PE 40:7|PE 18:1_22:6", "PC 18:2_20:5", "PC 33:2 Isomer A", "DG 38:6", "PC 32:1 Isomer A", "PC 40:8 Isomer A", "PC 39:6", "PE 40:6|PE 18:1_22:5", "SM 37:4;3O", "PC 44:12", "PC 40:7 Isomer A") #myo-inositol and correlated lipids
diablo.ML.VIP.group2 <- c("hydroquinone", "PE 40:7|PE 18:1_22:6", "PC 33:2 Isomer A", "PE 40:6|PE 18:1_22:5") #hydroquinone and correlated lipids
diablo.ML.VIP.group3 <- c("threonine", "PC 38:3 Isomer A", "Cer d37:1", "PC O-34:2", "Cer d36:1 Isomer B", "N-(eicosanoyl)sphingosine", "Cer d38:1", "PC 38:6 Isomer C", "Cer d38:2", "PC 36:3 Isomer A", "Cer d39:1", "Cer d40:1") #threonine and correlated lipids
```

```{r}
diablo.ML.VIP.metabAnnot <- rbind(
  rawMetabolomicsData %>%
    filter(., BinBase.name %in% diablo.ML.VIP.group1) %>%
    dplyr::rename(metabolite = BinBase.name) %>%
    dplyr::select(., metabolite) %>%
    mutate(., group = 1) %>%
    mutate(., respirationMetabolites = case_when(metabolite %in% respirationMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                 metabolite %in% respirationMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., calciumSignalingMetabolites = case_when(metabolite %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                      metabolite %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., coldProtectionMetabolites = case_when(metabolite %in% coldProtectionMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                    metabolite %in% coldProtectionMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    left_join(x = .,
              y = read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
                dplyr::select(metabolite, comparison) %>%
                mutate(metabolite = str_trim(metabolite, side = "both")) %>%
                pivot_wider(., id_cols = metabolite, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
                mutate(., VIP13v30_day22 = case_when(is.na(VIP13v30_day22) == FALSE ~ "Y",
                                                     is.na(VIP13v30_day22) == TRUE ~ "N")) %>%
                mutate(., VIP13v5_day22 = case_when(is.na(VIP13v5_day22) == FALSE ~ "Y",
                                                    is.na(VIP13v5_day22) == TRUE ~ "N")) %>%
                mutate(., VIP5_day3v22 = case_when(is.na(VIP5_day3v22) == FALSE ~ "Y",
                                                   is.na(VIP5_day3v22) == TRUE ~ "N")),
              by = "metabolite") %>%
    mutate(., valineBiosynthesis = case_when(metabolite %in% valineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                             metabolite %in% valineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., arginineBiosynthesis = case_when(metabolite %in% arginineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                               metabolite %in% arginineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., glutathioneMetabolism = case_when(metabolite %in% glutathioneMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                metabolite %in% glutathioneMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., alanineMetabolism = case_when(metabolite %in% alanineMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                            metabolite %in% alanineMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")),
  rawMetabolomicsData %>%
    filter(., BinBase.name %in% diablo.ML.VIP.group2) %>%
    dplyr::rename(metabolite = BinBase.name) %>%
    dplyr::select(., metabolite) %>%
    mutate(., group = 2) %>%
    mutate(., respirationMetabolites = case_when(metabolite %in% respirationMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                 metabolite %in% respirationMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., calciumSignalingMetabolites = case_when(metabolite %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                      metabolite %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., coldProtectionMetabolites = case_when(metabolite %in% coldProtectionMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                    metabolite %in% coldProtectionMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    left_join(x = .,
              y = read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
                dplyr::select(metabolite, comparison) %>%
                mutate(metabolite = str_trim(metabolite, side = "both")) %>%
                pivot_wider(., id_cols = metabolite, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
                mutate(., VIP13v30_day22 = case_when(is.na(VIP13v30_day22) == FALSE ~ "Y",
                                                     is.na(VIP13v30_day22) == TRUE ~ "N")) %>%
                mutate(., VIP13v5_day22 = case_when(is.na(VIP13v5_day22) == FALSE ~ "Y",
                                                    is.na(VIP13v5_day22) == TRUE ~ "N")) %>%
                mutate(., VIP5_day3v22 = case_when(is.na(VIP5_day3v22) == FALSE ~ "Y",
                                                   is.na(VIP5_day3v22) == TRUE ~ "N")),
              by = "metabolite") %>%
    mutate(., valineBiosynthesis = case_when(metabolite %in% valineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                             metabolite %in% valineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., arginineBiosynthesis = case_when(metabolite %in% arginineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                               metabolite %in% arginineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., glutathioneMetabolism = case_when(metabolite %in% glutathioneMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                metabolite %in% glutathioneMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., alanineMetabolism = case_when(metabolite %in% alanineMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                            metabolite %in% alanineMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")),
  rawMetabolomicsData %>%
    filter(., BinBase.name %in% diablo.ML.VIP.group3) %>%
    dplyr::rename(metabolite = BinBase.name) %>%
    dplyr::select(., metabolite) %>%
    mutate(., group = 3) %>%
    mutate(., respirationMetabolites = case_when(metabolite %in% respirationMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                 metabolite %in% respirationMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., calciumSignalingMetabolites = case_when(metabolite %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                      metabolite %in% calciumSignalingMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., coldProtectionMetabolites = case_when(metabolite %in% coldProtectionMetabolites %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                    metabolite %in% coldProtectionMetabolites %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    left_join(x = .,
              y = read.delim("../05-metabolomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
                dplyr::select(metabolite, comparison) %>%
                mutate(metabolite = str_trim(metabolite, side = "both")) %>%
                pivot_wider(., id_cols = metabolite, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
                mutate(., VIP13v30_day22 = case_when(is.na(VIP13v30_day22) == FALSE ~ "Y",
                                                     is.na(VIP13v30_day22) == TRUE ~ "N")) %>%
                mutate(., VIP13v5_day22 = case_when(is.na(VIP13v5_day22) == FALSE ~ "Y",
                                                    is.na(VIP13v5_day22) == TRUE ~ "N")) %>%
                mutate(., VIP5_day3v22 = case_when(is.na(VIP5_day3v22) == FALSE ~ "Y",
                                                   is.na(VIP5_day3v22) == TRUE ~ "N")),
              by = "metabolite") %>%
    mutate(., valineBiosynthesis = case_when(metabolite %in% valineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                             metabolite %in% valineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., arginineBiosynthesis = case_when(metabolite %in% arginineBiosynthesis %>% str_trim(., side = "both") == TRUE ~ "Y",
                                               metabolite %in% arginineBiosynthesis %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., glutathioneMetabolism = case_when(metabolite %in% glutathioneMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                                metabolite %in% glutathioneMetabolism %>% str_trim(., side = "both") == FALSE ~ "N")) %>%
    mutate(., alanineMetabolism = case_when(metabolite %in% alanineMetabolism %>% str_trim(., side = "both") == TRUE ~ "Y",
                                            metabolite %in% alanineMetabolism %>% str_trim(., side = "both") == FALSE ~ "N"))
) #Annotate metabolites with lipid correlations > 0.7
head(diablo.ML.VIP.metabAnnot) #Confirm dataframe creation
```

```{r}
write.csv(diablo.ML.VIP.metabAnnot, "DIABLO/ML-VIP-metabolite-annotations.csv", quote = FALSE, row.names = FALSE) #Save dataframe
```

```{r}
diablo.ML.VIP.lipidAnnot <- rbind(
  rawLipidomicsData %>%
    mutate(lipid = str_trim(lipid, side = "both")) %>%
    filter(., lipid %in% diablo.ML.VIP.group1) %>%
    dplyr::select(lipid) %>%
    unique(.) %>%
    mutate(group = 1) %>%
    left_join(x = .,
              y = read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
                dplyr::select(lipid, comparison) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                pivot_wider(., id_cols = lipid, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
                mutate(., VIP13v30 = case_when(is.na(VIP13v30) == FALSE ~ "Y",
                                               is.na(VIP13v30) == TRUE ~ "N")) %>%
                mutate(., VIP13v5 = case_when(is.na(VIP13v5) == FALSE ~ "Y",
                                              is.na(VIP13v5) == TRUE ~ "N")) ,
              by = "lipid") %>%
    left_join(x = .,
              y = significantVIP_13v30_annot %>%
                rbind(significantVIP_13v5_annot) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                dplyr::select(lipid, class:saturation) %>%
                unique(.),
              by = "lipid") %>%
    left_join(x = .,
              y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
                slice(-1) %>%
                mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
                rename(lipid = LION.term) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                remove_rownames() %>%
                column_to_rownames(., var = "lipid") %>%
                dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
                rownames_to_column(., var = "lipid"),
              by = "lipid") %>%
    left_join(x = ., 
              y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
                slice(-1) %>%
                mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
                rename(lipid = LION.term) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                remove_rownames() %>%
                column_to_rownames(., var = "lipid") %>%
                dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
                rownames_to_column(., var = "lipid")) %>%
    mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                       LION.0000003 != "x" ~ NA)) %>%
    mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                       LION.0000010 != "x" ~ NA)) %>% 
    mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                       LION.0000031 != "x" ~ NA)) %>% 
    mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                       LION.0000095 != "x" ~ NA)) %>%   
    mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                       LION.0000465 != "x" ~ NA)) %>%    
    mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                       LION.0012010 != "x" ~ NA)) %>%
    mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                       LION.0012080 != "x" ~ NA)) %>%
    mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                       LION.0000011 != "x" ~ NA)) %>%
    mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                       LION.0012081 != "x" ~ NA)),
  rawLipidomicsData %>%
    mutate(lipid = str_trim(lipid, side = "both")) %>%
    filter(., lipid %in% diablo.ML.VIP.group2) %>%
    dplyr::select(lipid) %>%
    unique(.) %>%
    mutate(group = 2) %>%
    left_join(x = .,
              y = read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
                dplyr::select(lipid, comparison) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                pivot_wider(., id_cols = lipid, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
                mutate(., VIP13v30 = case_when(is.na(VIP13v30) == FALSE ~ "Y",
                                               is.na(VIP13v30) == TRUE ~ "N")) %>%
                mutate(., VIP13v5 = case_when(is.na(VIP13v5) == FALSE ~ "Y",
                                              is.na(VIP13v5) == TRUE ~ "N")) ,
              by = "lipid") %>%
    left_join(x = .,
              y = significantVIP_13v30_annot %>%
                rbind(significantVIP_13v5_annot) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                dplyr::select(lipid, class:saturation) %>%
                unique(.),
              by = "lipid") %>%
    left_join(x = .,
              y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
                slice(-1) %>%
                mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
                rename(lipid = LION.term) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                remove_rownames() %>%
                column_to_rownames(., var = "lipid") %>%
                dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
                rownames_to_column(., var = "lipid"),
              by = "lipid") %>%
    left_join(x = ., 
              y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
                slice(-1) %>%
                mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
                rename(lipid = LION.term) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                remove_rownames() %>%
                column_to_rownames(., var = "lipid") %>%
                dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
                rownames_to_column(., var = "lipid")) %>%
    mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                       LION.0000003 != "x" ~ NA)) %>%
    mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                       LION.0000010 != "x" ~ NA)) %>% 
    mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                       LION.0000031 != "x" ~ NA)) %>% 
    mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                       LION.0000095 != "x" ~ NA)) %>%   
    mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                       LION.0000465 != "x" ~ NA)) %>%    
    mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                       LION.0012010 != "x" ~ NA)) %>%
    mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                       LION.0012080 != "x" ~ NA)) %>%
    mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                       LION.0000011 != "x" ~ NA)) %>%
    mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                       LION.0012081 != "x" ~ NA)),
  rawLipidomicsData %>%
    mutate(lipid = str_trim(lipid, side = "both")) %>%
    filter(., lipid %in% diablo.ML.VIP.group3) %>%
    dplyr::select(lipid) %>%
    unique(.) %>%
    mutate(group = 3) %>%
    left_join(x = .,
              y = read.delim("../06-lipidomics-analysis/metaboanalyst/all-module-VIP.txt", sep = "\t") %>%
                dplyr::select(lipid, comparison) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                pivot_wider(., id_cols = lipid, names_from = "comparison", names_prefix = "VIP", values_from = "comparison") %>%
                mutate(., VIP13v30 = case_when(is.na(VIP13v30) == FALSE ~ "Y",
                                               is.na(VIP13v30) == TRUE ~ "N")) %>%
                mutate(., VIP13v5 = case_when(is.na(VIP13v5) == FALSE ~ "Y",
                                              is.na(VIP13v5) == TRUE ~ "N")) ,
              by = "lipid") %>%
    left_join(x = .,
              y = significantVIP_13v30_annot %>%
                rbind(significantVIP_13v5_annot) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                dplyr::select(lipid, class:saturation) %>%
                unique(.),
              by = "lipid") %>%
    left_join(x = .,
              y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v30/LION-lipid-associations-13v30.csv", strip.white = TRUE) %>%
                slice(-1) %>%
                mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
                rename(lipid = LION.term) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                remove_rownames() %>%
                column_to_rownames(., var = "lipid") %>%
                dplyr::select_if(colnames(.) %in% LIONtoTerm13v30$LION.term) %>%
                rownames_to_column(., var = "lipid"),
              by = "lipid") %>%
    left_join(x = ., 
              y = read.csv("../06-lipidomics-analysis/metaboanalyst/LION-enrichment-report-13v5/LION-lipid-associations-13v5.csv", strip.white = TRUE) %>%
                slice(-1) %>%
                mutate(LION.term = substr(x = LION.term, start = 9, stop = 1000000L)) %>%
                rename(lipid = LION.term) %>%
                mutate(lipid = str_trim(lipid, side = "both")) %>%
                unique(.) %>%
                remove_rownames() %>%
                column_to_rownames(., var = "lipid") %>%
                dplyr::select_if(colnames(.) %in% LIONtoTerm13v5$LION.term) %>%
                rownames_to_column(., var = "lipid")) %>%
    mutate(., LION.0000003 = case_when(LION.0000003 == "x" ~ "both",
                                       LION.0000003 != "x" ~ NA)) %>%
    mutate(., LION.0000010 = case_when(LION.0000010 == "x" ~ "13v30",
                                       LION.0000010 != "x" ~ NA)) %>% 
    mutate(., LION.0000031 = case_when(LION.0000031 == "x" ~ "13v30",
                                       LION.0000031 != "x" ~ NA)) %>% 
    mutate(., LION.0000095 = case_when(LION.0000095 == "x" ~ "13v30",
                                       LION.0000095 != "x" ~ NA)) %>%   
    mutate(., LION.0000465 = case_when(LION.0000465 == "x" ~ "13v30",
                                       LION.0000465 != "x" ~ NA)) %>%    
    mutate(., LION.0012010 = case_when(LION.0012010 == "x" ~ "13v30",
                                       LION.0012010 != "x" ~ NA)) %>%
    mutate(., LION.0012080 = case_when(LION.0012080 == "x" ~ "both",
                                       LION.0012080 != "x" ~ NA)) %>%
    mutate(., LION.0000011 = case_when(LION.0000011 == "x" ~ "13v5",
                                       LION.0000011 != "x" ~ NA)) %>%
    mutate(., LION.0012081 = case_when(LION.0012081 == "x" ~ "13v5",
                                       LION.0012081 != "x" ~ NA))
) #Annotate lipids with metabolite correlations > 0.70
head(diablo.ML.VIP.lipidAnnot) #Confirm dataframe creation
```

```{r}
write_delim(diablo.ML.VIP.lipidAnnot, "DIABLO/ML-VIP-lipid-annotations.tsv", delim = "\t", col_names = TRUE) #Save dataframe
```
