---
title: "04-respirometry-analysis"
author: "Yaamini Venkataraman"
date: '2023-04-10'
output: html_document
---

I will analyze the respirometry data from the experiment. I want to compare *C. maenas* rate of oxygen consumption between treatments and over time. 

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../output/04-respirometry-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, include=FALSE}
#if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages("tidyverse")
#if ("RColorBrewer" %in% rownames(installed.packages()) == 'FALSE') install.packages("RColorBrewer")
#if ("lubridate" %in% rownames(installed.packages()) == 'FALSE') install.packages("lubridate")
#if ("respirometry" %in% rownames(installed.packages()) == 'FALSE') install.packages("respirometry")
#if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages("gridExtra")
#if ("patchwork" %in% rownames(installed.packages()) == 'FALSE') install.packages("broom")
# if ("patchwork" %in% rownames(installed.packages()) == 'FALSE') install.packages("patchwork")
# if ("grid" %in% rownames(installed.packages()) == 'FALSE') install.packages('grid')
require(tidyverse)
require(RColorBrewer)
require(lubridate)
require(respirometry)
require(gridExtra)
require(broom)
require(patchwork)
require(grid)
```

```{r}
sessionInfo()
```

# Import data

At each time point, I have data for six tanks (three treatments, two tanks/treatment). Each tank has data for four probes, but only probes 1-3 were used to collect data. I will import data for each day in one file using `readr`, then ensure I have the correct columns.

```{r}
test <- read_delim("../../data/respiration/2022-07-26-resp/2022-07-26_093345_Tank_3/2022-07-26_093345_Tank_3.txt", skip = 72, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:7, 12, 17, 21:25, 30, 35, 39:43, 48, 53, 57:61, 66, 71)) #Import data. Skip the first 72 rows
colnames(test) <- c("date", "time", 
                    "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                    "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                    "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3",
                    "dt_s_4", "perc_air_sat_4", "dphi_4", "signal_int_mV_4", "amb_light_mV_4", "temp_C_4", "pressure_mbar_4") #Rename columns
head(test) #Confirm import
```

### 2022-07-08

```{r}
files20220708 <- fs::dir_ls("../../data/respiration/2022-07-08-resp/", glob = "*tank?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in tank[NUMBER].txt. ? = single character wildcard
files20220708 #Confirm the list has the correct files
```

```{r}
dat20220708 <- read_delim(files20220708, id = "tank", delim = "\t", skip = 72, col_names = FALSE) %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220708) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220708)
```

```{r}
dat20220708 <- dat20220708 %>%
  mutate(., tank = str_sub(path, 82, 86)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "tank1" ~ "13C",
                                  tank == "tank2" ~ "5C",
                                  tank == "tank3" ~ "30C",
                                  tank == "tank4" ~ "13C",
                                  tank == "tank5" ~ "5C",
                                  tank == "tank6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220708) #Confirm tank and treatment information
```

### 2022-07-12

```{r}
files20220712 <- fs::dir_ls("../../data/respiration/2022-07-12-resp/", glob = "*tank?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in tank[NUMBER].txt. ? = single character wildcard
files20220712 #Confirm the list has the correct files
```

```{r}
dat20220712 <- read_delim(files20220712, id = "tank", delim = "\t", skip = 72, col_names = FALSE)  %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220712) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220712)
```

```{r}
dat20220712 <- dat20220712 %>%
  mutate(., tank = str_sub(path, 82, 86)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "tank1" ~ "13C",
                                  tank == "tank2" ~ "5C",
                                  tank == "tank3" ~ "30C",
                                  tank == "tank4" ~ "13C",
                                  tank == "tank5" ~ "5C",
                                  tank == "tank6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220712) #Confirm tank and treatment information
```

### 2022-07-19

```{r}
files20220719 <- fs::dir_ls("../../data/respiration/2022-07-19-resp/", glob = "*Tank_?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in Tank_[NUMBER].txt. ? = single character wildcard
files20220719 #Confirm the list has the correct files
```

```{r}
dat20220719 <- read_delim(files20220719, id = "tank", delim = "\t", skip = 72, col_names = FALSE)  %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220719) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220719)
```

```{r}
dat20220719 <- dat20220719 %>%
  mutate(., tank = str_sub(path, 83, 88)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "Tank_1" ~ "13C",
                                  tank == "Tank_2" ~ "5C",
                                  tank == "Tank_3" ~ "30C",
                                  tank == "Tank_4" ~ "13C",
                                  tank == "Tank_5" ~ "5C",
                                  tank == "Tank_6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220719) #Confirm tank and treatment information
```

### 2022-07-26

```{r}
files20220726 <- fs::dir_ls("../../data/respiration/2022-07-26-resp/", glob = "*Tank_?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in tank[NUMBER].txt. ? = single character wildcard
files20220726 #Confirm the list has the correct files
```

```{r}
dat20220726 <- read_delim(files20220726, id = "tank", delim = "\t", skip = 72, col_names = FALSE)  %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220726) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220726)
```

```{r}
dat20220726 <- dat20220726 %>%
  mutate(., tank = str_sub(path, 83, 88)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "Tank_1" ~ "13C",
                                  tank == "Tank_2" ~ "5C",
                                  tank == "Tank_3" ~ "30C",
                                  tank == "Tank_4" ~ "13C",
                                  tank == "Tank_5" ~ "5C",
                                  tank == "Tank_6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220726) #Confirm tank and treatment information
```

# Format data

I will create a datetime column and add salinity values. I'll also remove any extraneous columns that aren't needed for respirometry analysis and pivot the table longer.

## 2022-07-08

```{r}
colnames(dat20220708)
```

```{r}
dat20220708mod <- dat20220708 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ 34,
                                 tank == "tank2" ~ 37,
                                 tank == "tank3" ~ 34,
                                 tank == "tank4" ~ 34,
                                 tank == "tank5" ~ 37,
                                 tank == "tank6" ~ 34)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220708mod) #Confirm formatting
```

```{r}
dat20220708mod <- dat20220708mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220708mod)
```

## 2022-07-12

```{r}
dat20220712mod <- dat20220712 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ 35,
                                 tank == "tank2" ~ 36,
                                 tank == "tank3" ~ 34,
                                 tank == "tank4" ~ 35,
                                 tank == "tank5" ~ 36,
                                 tank == "tank6" ~ 34)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220712mod)
```

```{r}
dat20220712mod <- dat20220712mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220712mod)
```

## 2022-07-19

```{r}
dat20220719mod <- dat20220719 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "Tank_1" ~ 35,
                                 tank == "Tank_2" ~ 36,
                                 tank == "Tank_3" ~ 35,
                                 tank == "Tank_4" ~ 35,
                                 tank == "Tank_5" ~ 36,
                                 tank == "Tank_6" ~ 35)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220719mod)
```

```{r}
dat20220719mod <- dat20220719mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220719mod)
```

## 2022-07-26

```{r}
dat20220726mod <- dat20220726 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "Tank_1" ~ 35,
                                 tank == "Tank_2" ~ 34,
                                 tank == "Tank_3" ~ 35,
                                 tank == "Tank_4" ~ 35,
                                 tank == "Tank_5" ~ 34,
                                 tank == "Tank_6" ~ 35)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220726mod)
```

```{r}
dat20220726mod <- dat20220726mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220726mod)
```

# Initial figure

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Reds")[7],
                brewer.pal(9, "Greys")[7],
                brewer.pal(9, "Blues")[7]) #Create color scheme
```

## 2022-07-08

```{r}
dat20220708mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-08-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2022-07-12

```{r}
dat20220712mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-12-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2022-07-19

```{r}
dat20220719mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-19-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2022-07-26

```{r}
dat20220726mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-26-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

# Clean data

## 2022-07-08

```{r}
dat20220708mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
```

Tank 1 has some weird anomalies...

```{r}
dat20220708mod %>%
  filter(., tank == "tank1") %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (s)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

...and so does Tank 6

```{r}
dat20220708mod %>%
  filter(., tank == "tank3") %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (s)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

These are likely due to air bubbles or starting recording before the crabs were fully set up. I am going to remove these measurements.

```{r}
dat20220708clean <- dat20220708mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 1 & dt_s < 870)) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 1125)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 1216)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 35)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 1, dt_s - 870, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 1125, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 1216, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 35, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Check for values where tank == tank 1, probe_num == 1, and dt_s <= 870 Use the sub-conditions in parentheses and negate the condition with ! to retain all rows that don't meet this condition, but modify values for tank 1, probe 1. Do something similar such that tank 1, probe 2 starts at 1125 and tank 1, probe 3 starts at dt_s = 1216. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220708clean
ggsave("figures/2022-07-08-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20220708cleanDOumol <- dat20220708mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 1 & dt_s < 870)) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 1125)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 1216)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 35)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 1, dt_s - 870, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 1125, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 1216, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 35, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Check for values where tank == tank 1, probe_num == 1, and dt_s <= 870 Use the sub-conditions in parentheses and negate the condition with ! to retain all rows that don't meet this condition, but modify values for tank 1, probe 1. Do something similar such that tank 1, probe 2 starts at 1125 and tank 1, probe 3 starts at dt_s = 1216. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220708cleanDOumol
ggsave("figures/2022-07-08-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2022-07-12

```{r}
dat20220712mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

Once again removing any anomalies (i.e. time recorded prior to the addition of crabs) from all tanks/probes.

```{r}
dat20220712mod %>%
  filter(., perc_air_sat <= 100) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., tank == "tank6") %>%
  filter(., dt_s >= 271) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  #geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20220712clean <- dat20220712mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 1 & dt_s < 180)) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 180)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 257)) %>%
  filter(., !(tank == "tank2" & probe_num == 1 & dt_s < 267)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 411)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 842)) %>%
  filter(., !(tank == "tank3" & probe_num == 1 & dt_s < 305)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 246)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 240)) %>%
  filter(., !(tank == "tank4" & probe_num == 1 & dt_s < 278)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 132)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 347)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 577)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 219)) %>%
  filter(., !(tank == "tank6" & probe_num == 1 & dt_s < 271)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 268)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 248)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 1, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 257, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 1, dt_s - 267, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 411, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 842, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 1, dt_s - 305, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 246, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 240, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 1, dt_s - 278, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 132, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 347, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 577, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 219, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 1, dt_s - 271, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 268, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 248, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. Remove recording anomalies. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220712clean
ggsave("figures/2022-07-12-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20220712cleanDOumol <- dat20220712mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 1 & dt_s < 180)) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 180)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 257)) %>%
  filter(., !(tank == "tank2" & probe_num == 1 & dt_s < 267)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 411)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 842)) %>%
  filter(., !(tank == "tank3" & probe_num == 1 & dt_s < 305)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 246)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 240)) %>%
  filter(., !(tank == "tank4" & probe_num == 1 & dt_s < 278)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 132)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 347)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 577)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 219)) %>%
  filter(., !(tank == "tank6" & probe_num == 1 & dt_s < 271)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 268)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 248)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 1, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 257, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 1, dt_s - 267, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 411, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 842, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 1, dt_s - 305, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 246, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 240, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 1, dt_s - 278, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 132, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 347, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 577, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 219, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 1, dt_s - 271, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 268, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 248, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. Remove recording anomalies. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220712cleanDOumol
ggsave("figures/2022-07-12-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2022-07-19

```{r}
dat20220719mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20220719mod %>%
  filter(., perc_air_sat <= 100) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., tank == "Tank_4" & probe_num == 3) %>%
  filter(., dt_s >= 130) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  #geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20220719clean <- dat20220719mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "Tank_1" & probe_num == 1 & dt_s < 52)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 2 & dt_s < 181)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 3 & dt_s < 101)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 1 & dt_s < 203)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 2 & dt_s < 224)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 3 & dt_s < 394)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 1 & dt_s < 102)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 2 & dt_s < 18)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 3 & dt_s < 130)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 1 & dt_s < 149)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 2 & dt_s < 280)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 3 & dt_s < 281)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 1, dt_s - 52, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 2, dt_s - 181, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 3, dt_s - 101, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 1, dt_s - 203, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 2, dt_s - 224, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 3, dt_s - 394, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 1, dt_s - 102, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 2, dt_s - 18, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 3, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 1, dt_s - 149, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 2, dt_s - 280, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 3, dt_s - 281, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. Remove recording anomalies. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220719clean
ggsave("figures/2022-07-19-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20220719cleanDOumol <- dat20220719mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "Tank_1" & probe_num == 1 & dt_s < 52)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 2 & dt_s < 181)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 3 & dt_s < 101)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 1 & dt_s < 203)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 2 & dt_s < 224)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 3 & dt_s < 394)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 1 & dt_s < 102)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 2 & dt_s < 18)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 3 & dt_s < 130)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 1 & dt_s < 149)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 2 & dt_s < 280)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 3 & dt_s < 281)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 1, dt_s - 52, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 2, dt_s - 181, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 3, dt_s - 101, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 1, dt_s - 203, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 2, dt_s - 224, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 3, dt_s - 394, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 1, dt_s - 102, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 2, dt_s - 18, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 3, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 1, dt_s - 149, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 2, dt_s - 280, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 3, dt_s - 281, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. Remove recording anomalies. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220719cleanDOumol
ggsave("figures/2022-07-19-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

## 2022-07-26

```{r}
dat20220726mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20220726mod %>%
  filter(., perc_air_sat <= 100) %>%
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., tank == "Tank_4" & probe_num == 3) %>%
  filter(., dt_s >= 99) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  #geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

```{r}
dat20220726clean <- dat20220726mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "Tank_1" & probe_num == 1 & dt_s < 39)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 2 & dt_s < 89)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 3 & dt_s < 110)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 1 & dt_s < 319)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 2 & dt_s < 720)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 3 & dt_s < 404)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 1 & dt_s < 328)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 2 & dt_s < 403)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 3 & dt_s < 237)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 1 & dt_s < 32)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 2 & dt_s < 83)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 3 & dt_s < 99)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 1 & dt_s < 212)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 2 & dt_s < 141)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 3 & dt_s < 208)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 1 & dt_s < 234)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 2 & dt_s < 268)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 3 & dt_s < 222)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 1, dt_s - 39, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 2, dt_s - 89, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 3, dt_s - 110, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 1, dt_s - 319, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 2, dt_s - 720, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 3, dt_s - 404, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 1, dt_s - 328, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 2, dt_s - 403, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 3, dt_s - 237, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 1, dt_s - 32, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 2, dt_s - 83, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 3, dt_s - 99, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 1, dt_s - 212, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 2, dt_s - 141, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 3, dt_s - 208, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 1, dt_s - 234, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 2, dt_s - 268, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 3, dt_s - 222, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. Remove recording anomalies. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220726clean
ggsave("figures/2022-07-26-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

```{r}
dat20220726cleanDOumol <- dat20220726mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "Tank_1" & probe_num == 1 & dt_s < 39)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 2 & dt_s < 89)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 3 & dt_s < 110)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 1 & dt_s < 319)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 2 & dt_s < 720)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 3 & dt_s < 404)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 1 & dt_s < 328)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 2 & dt_s < 403)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 3 & dt_s < 237)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 1 & dt_s < 32)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 2 & dt_s < 83)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 3 & dt_s < 99)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 1 & dt_s < 212)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 2 & dt_s < 141)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 3 & dt_s < 208)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 1 & dt_s < 234)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 2 & dt_s < 268)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 3 & dt_s < 222)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 1, dt_s - 39, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 2, dt_s - 89, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 3, dt_s - 110, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 1, dt_s - 319, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 2, dt_s - 720, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 3, dt_s - 404, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 1, dt_s - 328, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 2, dt_s - 403, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 3, dt_s - 237, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 1, dt_s - 32, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 2, dt_s - 83, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 3, dt_s - 99, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 1, dt_s - 212, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 2, dt_s - 141, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 3, dt_s - 208, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 1, dt_s - 234, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 2, dt_s - 268, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 3, dt_s - 222, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = DO_umol_L, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Dissolved Oxygen (µmol)") +
  scale_y_continuous(breaks = seq(100, 350, 50), 
                     limits = c(150, 350)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. Remove recording anomalies. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220726cleanDOumol
ggsave("figures/2022-07-26-perc-air-sat-clean-DOumol.pdf", height = 8.5, width = 11)
```

# Extract slopes

Now that I have my data cleaned, I need to get the regression slopes for each line I plotted.

## 2022-07-08

```{r}
dat20220708data <- dat20220708mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 1 & dt_s < 870)) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 1125)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 1216)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 35)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 1, dt_s - 870, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 1125, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 1216, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 35, dt_s)) #Save cleaned data as a new object
head(dat20220708data) #Confirm object creation
```

```{r}
dat20220708_MO2_slopes <- dat20220708data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220708_MO2_slopes #Confirm dataframe creation
```
```{r}
dat20220708_MO2_glance <- dat20220708data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220708_MO2_glance #Confirm dataframe creation
```

```{r}
dat20220708_MO2_slope_results <- dat20220708_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220708_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220708_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20220708_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-08-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2022-07-12

```{r}
dat20220712data <- dat20220712mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 1 & dt_s < 180)) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 180)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 257)) %>%
  filter(., !(tank == "tank2" & probe_num == 1 & dt_s < 267)) %>%
  filter(., !(tank == "tank2" & probe_num == 2 & dt_s < 411)) %>%
  filter(., !(tank == "tank2" & probe_num == 3 & dt_s < 842)) %>%
  filter(., !(tank == "tank3" & probe_num == 1 & dt_s < 305)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 246)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 240)) %>%
  filter(., !(tank == "tank4" & probe_num == 1 & dt_s < 278)) %>%
  filter(., !(tank == "tank4" & probe_num == 2 & dt_s < 132)) %>%
  filter(., !(tank == "tank4" & probe_num == 3 & dt_s < 347)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 577)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 219)) %>%
  filter(., !(tank == "tank6" & probe_num == 1 & dt_s < 271)) %>%
  filter(., !(tank == "tank6" & probe_num == 2 & dt_s < 268)) %>%
  filter(., !(tank == "tank6" & probe_num == 3 & dt_s < 248)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 1, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 180, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 257, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 1, dt_s - 267, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 2, dt_s - 411, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2" & probe_num == 3, dt_s - 842, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 1, dt_s - 305, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 246, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 240, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 1, dt_s - 278, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 2, dt_s - 132, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4" & probe_num == 3, dt_s - 347, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 577, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 219, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 1, dt_s - 271, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 2, dt_s - 268, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6" & probe_num == 3, dt_s - 248, dt_s)) #Save cleaned data as a new object
head(dat20220712data) #Confirm object creation
```

```{r}
dat20220712_MO2_slopes <- dat20220712data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220712_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20220712_MO2_glance <- dat20220712data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220712_MO2_glance #Confirm dataframe creation
```

```{r}
dat20220712_MO2_slope_results <- dat20220712_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220712_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220712_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20220712_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-12-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour.
```

## 2022-07-19

```{r}
dat20220719data <- dat20220719mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "Tank_1" & probe_num == 1 & dt_s < 52)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 2 & dt_s < 181)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 3 & dt_s < 101)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 1 & dt_s < 203)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 2 & dt_s < 224)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 3 & dt_s < 394)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 1 & dt_s < 102)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 2 & dt_s < 18)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 3 & dt_s < 130)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 1 & dt_s < 149)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 2 & dt_s < 280)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 3 & dt_s < 281)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 1, dt_s - 52, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 2, dt_s - 181, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 3, dt_s - 101, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 1, dt_s - 203, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 2, dt_s - 224, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 3, dt_s - 394, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 1, dt_s - 102, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 2, dt_s - 18, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 3, dt_s - 130, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 1, dt_s - 149, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 2, dt_s - 280, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 3, dt_s - 281, dt_s)) #Save cleaned data as a new object
head(dat20220719data) #Confirm object creation
```

```{r}
dat20220719_MO2_slopes <- dat20220719data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220719_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20220719_MO2_glance <- dat20220719data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220719_MO2_glance #Confirm dataframe creation
```

```{r}
dat20220719_MO2_slope_results <- dat20220719_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220719_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220719_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20220719_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-19-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour.
```

## 2022-07-26

```{r}
dat20220726data <- dat20220726mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "Tank_1" & probe_num == 1 & dt_s < 39)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 2 & dt_s < 89)) %>%
  filter(., !(tank == "Tank_1" & probe_num == 3 & dt_s < 110)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 1 & dt_s < 319)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 2 & dt_s < 720)) %>%
  filter(., !(tank == "Tank_2" & probe_num == 3 & dt_s < 404)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 1 & dt_s < 328)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 2 & dt_s < 403)) %>%
  filter(., !(tank == "Tank_3" & probe_num == 3 & dt_s < 237)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 1 & dt_s < 32)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 2 & dt_s < 83)) %>%
  filter(., !(tank == "Tank_4" & probe_num == 3 & dt_s < 99)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 1 & dt_s < 212)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 2 & dt_s < 141)) %>%
  filter(., !(tank == "Tank_5" & probe_num == 3 & dt_s < 208)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 1 & dt_s < 234)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 2 & dt_s < 268)) %>%
  filter(., !(tank == "Tank_6" & probe_num == 3 & dt_s < 222)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 1, dt_s - 39, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 2, dt_s - 89, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1" & probe_num == 3, dt_s - 110, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 1, dt_s - 319, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 2, dt_s - 720, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2" & probe_num == 3, dt_s - 404, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 1, dt_s - 328, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 2, dt_s - 403, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3" & probe_num == 3, dt_s - 237, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 1, dt_s - 32, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 2, dt_s - 83, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4" & probe_num == 3, dt_s - 99, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 1, dt_s - 212, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 2, dt_s - 141, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5" & probe_num == 3, dt_s - 208, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 1, dt_s - 234, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 2, dt_s - 268, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6" & probe_num == 3, dt_s - 222, dt_s)) #Save cleaned data as a new object
head(dat20220726data) #Confirm object creation
```

```{r}
dat20220726_MO2_slopes <- dat20220726data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220726_MO2_slopes #Confirm dataframe creation
```

```{r}
dat20220726_MO2_glance <- dat20220726data %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220726_MO2_glance #Confirm dataframe creation
```

```{r}
dat20220726_MO2_slope_results <- dat20220726_MO2_slopes %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220726_MO2_glance$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220726_MO2_slope_results #Confirm dataframe creation
```

```{r}
dat20220726_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-26-oxygen-consumption-nmolhr.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## Create multipanel figure

Even though I haven't corrected for blanks yet, I'm going to create a multipanel figure that shows the boxplots side by side, as well as a smooth line between each boxplot midpoint to better visualize changes in the TPC over time.

```{r}
dat20220708_MO2_slope_results_reorder <- dat20220708_MO2_slope_results %>%
  mutate(., treatment = gsub(x = treatment, pattern = "5C", replacement = "05C"))
#Reorder temperature treatments for plotting by renaming 5C as 05C so it is the first alphanumerically
tail(dat20220708_MO2_slope_results_reorder)
```

```{r}
dat20220708_uncorr_fig <- dat20220708_MO2_slope_results_reorder %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("") + ylab("") +
  labs(title = "Day 4") +
  stat_summary(fun = median,
               geom = "line",
               aes(group = 1),
               col = "black", lty = 2) +
  scale_x_discrete(breaks = c("05C", "13C", "30C"),
                   labels = c("5", "13", "30")) +
  scale_y_continuous(limits = c(0, 30000),
                     breaks = seq(0, 30000, 5000),
                     labels = seq(0, 30000, 5000)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     guide = "none") +
  theme_classic(base_size = 15) + theme(plot.margin = margin(0, 0, 0, 3, "pt")) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. Add a line connecting each boxplot midpoint. 
dat20220708_uncorr_fig
```

```{r}
dat20220712_MO2_slope_results_reorder <- dat20220712_MO2_slope_results %>%
  mutate(., treatment = gsub(x = treatment, pattern = "5C", replacement = "05C"))
#Reorder temperature treatments for plotting by renaming 5C as 05C so it is the first alphanumerically
tail(dat20220712_MO2_slope_results_reorder)
```

```{r}
dat20220712_uncorr_fig <- dat20220712_MO2_slope_results_reorder %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("") + ylab("") +
  labs(title = "Day 8") +
  stat_summary(fun = median,
               geom = "line",
               aes(group = 1),
               col = "black", lty = 2) +
  scale_x_discrete(breaks = c("05C", "13C", "30C"),
                   labels = c("5", "13", "30")) +
  scale_y_continuous(limits = c(0, 30000),
                     breaks = seq(0, 30000, 5000),
                     labels = seq(0, 30000, 5000)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     guide = "none") +
  theme_classic(base_size = 15) + theme(plot.margin = margin(0, 0, 0, 3, "pt")) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. Add a line connecting each boxplot midpoint. 
dat20220712_uncorr_fig
```

```{r}
dat20220719_MO2_slope_results_reorder <- dat20220719_MO2_slope_results %>%
  mutate(., treatment = gsub(x = treatment, pattern = "5C", replacement = "05C"))
#Reorder temperature treatments for plotting by renaming 5C as 05C so it is the first alphanumerically
tail(dat20220719_MO2_slope_results_reorder)
```

```{r}
dat20220719_uncorr_fig <- dat20220719_MO2_slope_results_reorder %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("") + ylab("") +
  labs(title = "Day 15") +
  stat_summary(fun = median,
               geom = "line",
               aes(group = 1),
               col = "black", lty = 2) +
  scale_x_discrete(breaks = c("05C", "13C", "30C"),
                   labels = c("5", "13", "30")) +
  scale_y_continuous(limits = c(0, 30000),
                     breaks = seq(0, 30000, 5000),
                     labels = seq(0, 30000, 5000)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     guide = "none") +
  theme_classic(base_size = 15) + theme(plot.margin = margin(0, 0, 0, 3, "pt")) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. Add a line connecting each boxplot midpoint.
dat20220719_uncorr_fig
```

```{r}
dat20220726_MO2_slope_results_reorder <- dat20220726_MO2_slope_results %>%
  mutate(., treatment = gsub(x = treatment, pattern = "5C", replacement = "05C"))
#Reorder temperature treatments for plotting by renaming 5C as 05C so it is the first alphanumerically
tail(dat20220726_MO2_slope_results_reorder)
```

```{r}
dat20220726_uncorr_fig <- dat20220726_MO2_slope_results_reorder %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("") + ylab("") +
  labs(title = "Day 22") +
  stat_summary(fun = median,
               geom = "line",
               aes(group = 1),
               col = "black", lty = 2) +
  scale_x_discrete(breaks = c("05C", "13C", "30C"),
                   labels = c("5", "13", "30")) +
  scale_y_continuous(limits = c(0, 30000),
                     breaks = seq(0, 30000, 5000),
                     labels = seq(0, 30000, 5000)) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     guide = "none") +
  theme_classic(base_size = 15) + theme(plot.margin = margin(0, 0, 0, 3, "pt")) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. Add a line connecting each boxplot midpoint.
dat20220726_uncorr_fig
```

```{r}
#pdf("figures/multipanel-oxygen-consumption-uncorrected.pdf", height = 8.5, width = 11)

dat20220708_uncorr_fig | dat20220712_uncorr_fig | dat20220719_uncorr_fig | dat20220726_uncorr_fig
grid::grid.draw(grid::textGrob("Oxygen Consumption (nmol/hr)", x = 0.03, rot = 90, gp = gpar(fontsize = 17)))
grid::grid.draw(grid::textGrob("Temperature (ºC)", y = 0.04, gp = gpar(fontsize = 17)))

#dev.off()
```

# Blank-correct regression slopes

Next step: I need to extract data from the last 10-20 minutes of each chamber. This is my background 

## 2022-07-08

```{r}
dat20220708mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20220708mod %>%
  filter(., !(tank == "tank1" & dt_s < 3505)) %>%
  filter(., !(tank == "tank2" & dt_s < 4480)) %>%
  filter(., !(tank == "tank3" & probe_num == 1 & dt_s < 840)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 710)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s > 1310)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 840)) %>%
  filter(., !(tank == "tank4" & dt_s < 3105)) %>%
  filter(., !(tank == "tank5" & probe_num == 1 & dt_s < 7920)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 6585)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s > 7185)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 7920)) %>%
  filter(., !(tank == "tank6" & dt_s < 882)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3505, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 4480, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 1, dt_s - 840, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 710, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 840, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 3105, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 1, dt_s - 7920, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 6585, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 7920, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 882, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20220708blanks <- dat20220708mod %>%
  filter(., !(tank == "tank1" & dt_s < 3505)) %>%
  filter(., !(tank == "tank2" & dt_s < 4480)) %>%
  filter(., !(tank == "tank3" & probe_num == 1 & dt_s < 840)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s < 710)) %>%
  filter(., !(tank == "tank3" & probe_num == 2 & dt_s > 1310)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 840)) %>%
  filter(., !(tank == "tank4" & dt_s < 3105)) %>%
  filter(., !(tank == "tank5" & probe_num == 1 & dt_s < 7920)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s < 6585)) %>%
  filter(., !(tank == "tank5" & probe_num == 2 & dt_s > 7185)) %>%
  filter(., !(tank == "tank5" & probe_num == 3 & dt_s < 7920)) %>%
  filter(., !(tank == "tank6" & dt_s < 882)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 3505, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 4480, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 1, dt_s - 840, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 2, dt_s - 710, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3" & probe_num == 3, dt_s - 840, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 3105, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 1, dt_s - 7920, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 2, dt_s - 6585, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5" & probe_num == 3, dt_s - 7920, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 882, dt_s))
head(dat20220708blanks) #Confirm dataframe creation
```

```{r}
dat20220708_MO2_slopes_blanks <- dat20220708blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220708_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20220708_MO2_glance_blanks <- dat20220708blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220708_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20220708_MO2_slopes_blanks_results <- dat20220708_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220708_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220708_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20220708_MO2_slope_results <- dat20220708_MO2_slope_results %>%
  left_join(., dat20220708_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20220708_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20220708_MO2_slope_results
```

```{r}
dat20220708_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-08-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2022-07-12

```{r}
dat20220712mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20220712mod %>%
  filter(., !(tank == "tank1" & dt_s < 1686)) %>%
  filter(., !(tank == "tank2" & dt_s < 4710)) %>%
  filter(., !(tank == "tank3" & dt_s < 602)) %>%
  filter(., !(tank == "tank4" & dt_s < 3186)) %>%
  filter(., !(tank == "tank5" & dt_s < 5088)) %>%
  filter(., !(tank == "tank6" & dt_s < 1006)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 1686, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 4710, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 602, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 3186, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 5088, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1006, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20220712blanks <- dat20220712mod %>%
  filter(., !(tank == "tank1" & dt_s < 1686)) %>%
  filter(., !(tank == "tank2" & dt_s < 4710)) %>%
  filter(., !(tank == "tank3" & dt_s < 602)) %>%
  filter(., !(tank == "tank4" & dt_s < 3186)) %>%
  filter(., !(tank == "tank5" & dt_s < 5088)) %>%
  filter(., !(tank == "tank6" & dt_s < 1006)) %>%
  mutate(., dt_s = ifelse(tank == "tank1", dt_s - 1686, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank2", dt_s - 4710, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank3", dt_s - 602, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank4", dt_s - 3186, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank5", dt_s - 5088, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank6", dt_s - 1006, dt_s))
head(dat20220712blanks) #Confirm dataframe creation
```

```{r}
dat20220712_MO2_slopes_blanks <- dat20220712blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220712_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20220712_MO2_glance_blanks <- dat20220712blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220712_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20220712_MO2_slopes_blanks_results <- dat20220712_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220712_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220712_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20220712_MO2_slope_results <- dat20220712_MO2_slope_results %>%
  left_join(., dat20220712_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20220712_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20220712_MO2_slope_results
```

```{r}
dat20220712_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-12-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2022-07-19

```{r}
dat20220719mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20220719mod %>%
  filter(., !(tank == "Tank_1" & dt_s < 1347)) %>%
  filter(., !(tank == "Tank_2" & dt_s < 4453)) %>%
  filter(., !(tank == "Tank_3" & dt_s < 1089)) %>%
  filter(., !(tank == "Tank_4" & dt_s < 1624)) %>%
  filter(., !(tank == "Tank_5" & dt_s < 4445)) %>%
  filter(., !(tank == "Tank_6" & dt_s < 1367)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1", dt_s - 1347, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2", dt_s - 4453, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3", dt_s - 1089, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4", dt_s - 1624, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5", dt_s - 4445, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6", dt_s - 1367, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20220719blanks <- dat20220719mod %>%
  filter(., !(tank == "Tank_1" & dt_s < 1347)) %>%
  filter(., !(tank == "Tank_2" & dt_s < 4453)) %>%
  filter(., !(tank == "Tank_3" & dt_s < 1089)) %>%
  filter(., !(tank == "Tank_4" & dt_s < 1624)) %>%
  filter(., !(tank == "Tank_5" & dt_s < 4445)) %>%
  filter(., !(tank == "Tank_6" & dt_s < 1367)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1", dt_s - 1347, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2", dt_s - 4453, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3", dt_s - 1089, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4", dt_s - 1624, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5", dt_s - 4445, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6", dt_s - 1367, dt_s))
head(dat20220719blanks) #Confirm dataframe creation
```

```{r}
dat20220719_MO2_slopes_blanks <- dat20220719blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220719_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20220719_MO2_glance_blanks <- dat20220719blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220719_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20220719_MO2_slopes_blanks_results <- dat20220719_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220719_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220719_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20220719_MO2_slope_results <- dat20220719_MO2_slope_results %>%
  left_join(., dat20220719_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20220719_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20220719_MO2_slope_results
```

```{r}
dat20220719_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-19-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## 2022-07-26

```{r}
dat20220726mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
```

```{r}
dat20220726mod %>%
  filter(., tank == "Tank_5") %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  #geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_x_continuous(limits = c(2900, 3500)) +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```


```{r}
dat20220726mod %>%
  filter(., !(tank == "Tank_1" & dt_s < 1083)) %>%
  filter(., !(tank == "Tank_2" & dt_s < 3968)) %>%
  filter(., !(tank == "Tank_3" & dt_s < 2169)) %>%
  filter(., !(tank == "Tank_4" & dt_s < 1399)) %>%
  filter(., !(tank == "Tank_5" & dt_s < 2900)) %>%
  filter(., !(tank == "Tank_5" & dt_s > 3500)) %>%
  filter(., !(tank == "Tank_6" & dt_s < 1420)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1", dt_s - 1083, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2", dt_s - 3968, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3", dt_s - 2169, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4", dt_s - 1399, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5", dt_s - 2900, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6", dt_s - 1420, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Identify and plot ~10 min of background respiration data that will be used to calculate the background respiration slope
```

```{r}
dat20220726blanks <- dat20220726mod %>%
  filter(., !(tank == "Tank_1" & dt_s < 1083)) %>%
  filter(., !(tank == "Tank_2" & dt_s < 3968)) %>%
  filter(., !(tank == "Tank_3" & dt_s < 2169)) %>%
  filter(., !(tank == "Tank_4" & dt_s < 1399)) %>%
  filter(., !(tank == "Tank_5" & dt_s < 2900)) %>%
  filter(., !(tank == "Tank_5" & dt_s > 3500)) %>%
  filter(., !(tank == "Tank_6" & dt_s < 1420)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_1", dt_s - 1083, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_2", dt_s - 3968, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_3", dt_s - 2169, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_4", dt_s - 1399, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_5", dt_s - 2900, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "Tank_6", dt_s - 1420, dt_s))
head(dat20220726blanks) #Confirm dataframe creation
```

```{r}
dat20220726_MO2_slopes_blanks <- dat20220726blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(tidied = map(fit, tidy)) %>%
  unnest(tidied) #Create a list object that stores the regression results for each chamber. Nest data by treatment, tank, and probe number so the regression slopes are calculated appropriately. Use map to extract linear model fit information for DO_umol_L by time. Extract slopes using broom::tidy and unnest.
dat20220726_MO2_slopes_blanks #Confirm dataframe creation
```

```{r}
dat20220726_MO2_glance_blanks <- dat20220726blanks %>%
  nest(data = -c(treatment, tank, probe_num)) %>%
  mutate(fit = map(data, ~lm(DO_umol_L ~ dt_s, data = .))) %>%
  mutate(glanced = map(fit, glance)) %>%
  unnest(glanced) #Similar to above, but calculate the adjusted R-squared values by nesting treatment and probe information
dat20220726_MO2_glance_blanks #Confirm dataframe creation
```

```{r}
dat20220726_MO2_slopes_blanks_results <- dat20220726_MO2_slopes_blanks %>%
  filter(term == "dt_s") %>%
  mutate(slope_nmol_hr = estimate*1000*60) %>%
  dplyr::select(treatment, tank, probe_num, slope_nmol_hr, p.value) %>%
  mutate(r.squared = (dat20220726_MO2_glance_blanks$r.squared)) #Get the regression information for dt_s and not the intercept. Creates new a variable for respiration rate as nmol_per_hour (slope_nmol_hr). Select treatment, tank, probe number, slope over the hour, and p-value. Add the r-squared information from glance.
dat20220726_MO2_slopes_blanks_results #Confirm dataframe creation
```

```{r}
dat20220726_MO2_slope_results <- dat20220726_MO2_slope_results %>%
  left_join(., dat20220726_MO2_slopes_blanks_results, by = c("treatment", "tank", "probe_num"), suffix = c("", "_blank")) %>%
  mutate(., slope_nmol_hr_corrected = slope_nmol_hr - dat20220726_MO2_slopes_blanks_results$slope_nmol_hr) %>%
  mutate(., blank_ratio = abs(slope_nmol_hr_blank / slope_nmol_hr)) #Join dataframes by treatment, tank, and probe_num. Create a new column for the the corrected slope (uncorrected slope - blank slope) and the blank ratio (blank / uncorrected slope)
dat20220726_MO2_slope_results
```

```{r}
dat20220726_MO2_slope_results %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(size = 2) +
  xlab("Temperature (ºC)") + ylab("Oxygen Consumption (nmol/hr)") +
  scale_x_discrete(breaks = c("13C", "3OC", "5C"),
                   labels = c("13", "3O", "5")) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     guide = "none") +
  theme_classic(base_size = 15)
ggsave("figures/2022-07-26-oxygen-consumption-nmolhr-corrected.pdf", width = 11, height = 8.5) #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. 
```

## Create multipanel figure

```{r}
all_MO2_slope_results <- bind_rows("04" = dat20220708_MO2_slope_results,
                                   "08" = dat20220712_MO2_slope_results,
                                   "15" = dat20220719_MO2_slope_results,
                                   "22" = dat20220726_MO2_slope_results, 
                                   .id = "day") #Create a new dataframe with all uncorrected slope results, including a day
head(all_MO2_slope_results) #Confirm dataframe creation
```

```{r}
all_MO2_slope_results_reorder <- all_MO2_slope_results %>%
  mutate(., treatment = gsub(x = treatment, pattern = "5C", replacement = "05C"))
#Reorder temperature treatments for plotting by renaming 5C as 05C so it is the first alphanumerically
tail(all_MO2_slope_results_reorder)
```

```{r}
facet_labels <- c("04" = "Day 4",
                  "08" = "Day 8",
                  "15" = "Day 15",
                  "22" = "Day 22") #Assign labels for facets
```

```{r}
all_MO2_slope_results_reorder %>%
  ggplot(., aes(x = treatment, y = -slope_nmol_hr_corrected, color = treatment)) + 
  geom_boxplot() + geom_point(aes(shape = treatment), size = 2) +
  xlab("") + ylab("Oxygen Consumption (nmol/hr)") +
  stat_summary(fun = median,
               geom = "line",
               aes(group = 1),
               col = "black", lty = 2) +
  facet_wrap(. ~ day, ncol = 4, labeller = labeller (day = facet_labels)) +
  scale_x_discrete(breaks = c("05C", "13C", "30C"),
                   labels = c("", "", "")) +
  scale_color_manual(values = c(plotColors[3], plotColors[2], plotColors[1]), 
                     name = "Temperature (ºC)",
                     breaks = c("05C", "13C", "30C"),
                     labels = c("5", "13", "30")) +
  scale_shape_manual(values = c(15, 19, 17),
                     name = "Temperature (ºC)",
                     breaks = c("05C", "13C", "30C"),
                     labels = c("5", "13", "30")) +
  theme_classic(base_size = 15) + theme(axis.title = element_blank(), 
                                        axis.ticks.x = element_blank(),
                                        strip.text.x = element_text(size = 15),
                                        strip.background = element_rect(colour = "white")) +
  ggsave("figures/multipanel-oxygen-consumption-corrected.pdf", height = 8.5, width = 11)
  #Create a boxplot for oxygen consumption (µmol/hr). Use -slope_nmol_hr so the larger the slope, the faster the oxygen consumption over the hour. Add a line connecting each boxplot midpoint. Facet wrap and use the labeller to relabel facets. Add consistent
```

# Compare blank-corrected oxygen consumption

## Between treatments within a timepoint

```{r}
lm20220708 <- lm(-slope_nmol_hr_corrected ~ treatment, data = dat20220708_MO2_slope_results)
summary(lm20220708)
```

```{r}
write.csv(broom::tidy(lm20220708), "20220708-model-output.csv", quote = FALSE, row.names = FALSE)
```

```{r}
lm20220712 <- lm(-slope_nmol_hr_corrected ~ treatment, data = dat20220712_MO2_slope_results)
summary(lm20220712)
```

```{r}
write.csv(broom::tidy(lm20220712), "20220712-model-output.csv", quote = FALSE, row.names = FALSE)
```

```{r}
lm20220719 <- lm(-slope_nmol_hr_corrected ~ treatment, data = dat20220719_MO2_slope_results)
summary(lm20220719)
```

```{r}
write.csv(broom::tidy(lm20220719), "20220719-model-output.csv", quote = FALSE, row.names = FALSE)
```

```{r}
lm20220726 <- lm(-slope_nmol_hr_corrected ~ treatment, data = dat20220726_MO2_slope_results)
summary(lm20220726)
```

```{r}
write.csv(broom::tidy(lm20220726), "20220726-model-output.csv", quote = FALSE, row.names = FALSE)
```

## Across time and treatment

```{r}
lmAllSlopeResults <- lm(-slope_nmol_hr_corrected ~ treatment*as.numeric(day), data = all_MO2_slope_results)
summary(lmAllSlopeResults) #No significant impact of treatment or day on respiration
```

```{r}
write.csv(broom::tidy(lmAllSlopeResults), "all-slope-results-model-output.csv", quote = FALSE, row.names = FALSE)
```

TO DO:

- add sex + size + integument color to the model
- find a way to quantify variability in respiration by treatment? "plasticity" score?
