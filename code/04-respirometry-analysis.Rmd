---
title: "04-respirometry-analysis"
author: "Yaamini Venkataraman"
date: '2023-04-10'
output: html_document
---

I will analyze the respirometry data from the experiment. I want to compare *C. maenas* rate of oxygen consumption between treatments and over time. 

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../output/04-respirometry-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, include=FALSE}
#install.packages("tidyverse")
#install.packages("RColorBrewer")
#install.packages("lubridate")
#install.packages("respirometry")
#install.packages("gridExtra")
require(tidyverse)
require(RColorBrewer)
require(lubridate)
require(respirometry)
require(gridExtra)
```

```{r}
sessionInfo()
```

# Import data

At each time point, I have data for six tanks (three treatments, two tanks/treatment). Each tank has data for four probes, but only probes 1-3 were used to collect data. I will import data for each day in one file using `readr`, then ensure I have the correct columns.

```{r}
test <- read_delim("../../data/respiration/2022-07-26-resp/2022-07-26_093345_Tank_3/2022-07-26_093345_Tank_3.txt", skip = 72, delim = "\t", col_names = FALSE) %>% 
  select(., c(1:7, 12, 17, 21:25, 30, 35, 39:43, 48, 53, 57:61, 66, 71)) #Import data. Skip the first 72 rows
colnames(test) <- c("date", "time", 
                    "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                    "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                    "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3",
                    "dt_s_4", "perc_air_sat_4", "dphi_4", "signal_int_mV_4", "amb_light_mV_4", "temp_C_4", "pressure_mbar_4") #Rename columns
head(test) #Confirm import
```

### 2022-07-08

```{r}
files20220708 <- fs::dir_ls("../../data/respiration/2022-07-08-resp/", glob = "*tank?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in tank[NUMBER].txt. ? = single character wildcard
files20220708 #Confirm the list has the correct files
```

```{r}
dat20220708 <- read_delim(files20220708, id = "tank", delim = "\t", skip = 72, col_names = FALSE) %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220708) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220708)
```

```{r}
dat20220708 <- dat20220708 %>%
  mutate(., tank = str_sub(path, 82, 86)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "tank1" ~ "13C",
                                  tank == "tank2" ~ "5C",
                                  tank == "tank3" ~ "30C",
                                  tank == "tank4" ~ "13C",
                                  tank == "tank5" ~ "5C",
                                  tank == "tank6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220708) #Confirm tank and treatment information
```

### 2022-07-12

```{r}
files20220712 <- fs::dir_ls("../../data/respiration/2022-07-12-resp/", glob = "*tank?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in tank[NUMBER].txt. ? = single character wildcard
files20220712 #Confirm the list has the correct files
```

```{r}
dat20220712 <- read_delim(files20220712, id = "tank", delim = "\t", skip = 72, col_names = FALSE)  %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220712) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220712)
```

```{r}
dat20220712 <- dat20220712 %>%
  mutate(., tank = str_sub(path, 82, 86)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "tank1" ~ "13C",
                                  tank == "tank2" ~ "5C",
                                  tank == "tank3" ~ "30C",
                                  tank == "tank4" ~ "13C",
                                  tank == "tank5" ~ "5C",
                                  tank == "tank6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220712) #Confirm tank and treatment information
```

### 2022-07-19

```{r}
files20220719 <- fs::dir_ls("../../data/respiration/2022-07-19-resp/", glob = "*Tank_?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in Tank_[NUMBER].txt. ? = single character wildcard
files20220719 #Confirm the list has the correct files
```

```{r}
dat20220719 <- read_delim(files20220719, id = "tank", delim = "\t", skip = 72, col_names = FALSE)  %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220719) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220719)
```

```{r}
dat20220719 <- dat20220719 %>%
  mutate(., tank = str_sub(path, 83, 88)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "Tank_1" ~ "13C",
                                  tank == "Tank_2" ~ "5C",
                                  tank == "Tank_3" ~ "30C",
                                  tank == "Tank_4" ~ "13C",
                                  tank == "Tank_5" ~ "5C",
                                  tank == "Tank_6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220719) #Confirm tank and treatment information
```

### 2022-07-26

```{r}
files20220726 <- fs::dir_ls("../../data/respiration/2022-07-26-resp/", glob = "*Tank_?.txt", recurse = TRUE) #Create a list of respirometry files from specified date. Use recurse = TRUE to prompt search through child directories. Only select files that end in tank[NUMBER].txt. ? = single character wildcard
files20220726 #Confirm the list has the correct files
```

```{r}
dat20220726 <- read_delim(files20220726, id = "tank", delim = "\t", skip = 72, col_names = FALSE)  %>% 
  select(., c(1:8, 13, 18, 20:26, 31, 36, 38:44, 49, 54)) #Import data from all files in the designated list. Specify tab-delimited files and skip the first 72 lines. There are no column names. Select data from probes 1-3 (probe 4 was never used). Use all date/time columns since some probes ran for longer than others.
colnames(dat20220726) <- c("path", 
                           "date_1", "time_1", "dt_s_1", "perc_air_sat_1", "dphi_1", "signal_int_mV_1", "amb_light_mV_1", "temp_C_1", "pressure_mbar_1",
                           "date_2", "time_2", "dt_s_2", "perc_air_sat_2", "dphi_2", "signal_int_mV_2", "amb_light_mV_2", "temp_C_2", "pressure_mbar_2",
                           "date_3", "time_3", "dt_s_3", "perc_air_sat_3", "dphi_3", "signal_int_mV_3", "amb_light_mV_3", "temp_C_3", "pressure_mbar_3") #Rename columns
head(dat20220726)
```

```{r}
dat20220726 <- dat20220726 %>%
  mutate(., tank = str_sub(path, 83, 88)) %>%
  select(-path) %>% 
  mutate(., treatment = case_when(tank == "Tank_1" ~ "13C",
                                  tank == "Tank_2" ~ "5C",
                                  tank == "Tank_3" ~ "30C",
                                  tank == "Tank_4" ~ "13C",
                                  tank == "Tank_5" ~ "5C",
                                  tank == "Tank_6" ~ "30C")) #Isolate tank ID from the file path. Remove file path column. Add treatment information
tail(dat20220726) #Confirm tank and treatment information
```

# Format data

I will create a datetime column and add salinity values. I'll also remove any extraneous columns that aren't needed for respirometry analysis and pivot the table longer.

## 2022-07-08

```{r}
colnames(dat20220708)
```

```{r}
dat20220708mod <- dat20220708 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ 34,
                                 tank == "tank2" ~ 37,
                                 tank == "tank3" ~ 34,
                                 tank == "tank4" ~ 34,
                                 tank == "tank5" ~ 37,
                                 tank == "tank6" ~ 34)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220708mod) #Confirm formatting
```

```{r}
dat20220708mod <- dat20220708mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220708mod)
```

## 2022-07-12

```{r}
dat20220712mod <- dat20220712 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "tank1" ~ 35,
                                 tank == "tank2" ~ 36,
                                 tank == "tank3" ~ 34,
                                 tank == "tank4" ~ 35,
                                 tank == "tank5" ~ 36,
                                 tank == "tank6" ~ 34)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220712mod)
```

```{r}
dat20220712mod <- dat20220712mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220712mod)
```

## 2022-07-19

```{r}
dat20220719mod <- dat20220719 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "Tank_1" ~ 35,
                                 tank == "Tank_2" ~ 36,
                                 tank == "Tank_3" ~ 35,
                                 tank == "Tank_4" ~ 35,
                                 tank == "Tank_5" ~ 36,
                                 tank == "Tank_6" ~ 35)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220719mod)
```

```{r}
dat20220719mod <- dat20220719mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220719mod)
```

## 2022-07-26

```{r}
dat20220726mod <- dat20220726 %>%
  select(., -c(5:7, 14:16, 23:25)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_2)) %>%
  mutate(., date = case_when(is.na(date_1) == FALSE ~ date_1,
                             is.na(date_1) == TRUE ~ date_3)) %>%
  filter(., is.na(date_1) == FALSE) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_2)) %>%
  mutate(., time = case_when(is.na(time_1) == FALSE ~ time_1,
                             is.na(time_1) == TRUE ~ time_3)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_2)) %>%
  mutate(., dt_s = case_when(is.na(dt_s_1) == FALSE ~ dt_s_1,
                             is.na(dt_s_1) == TRUE ~ dt_s_3)) %>%
  select(., -c(date_1, date_2, date_3, 
               time_1, time_2, time_3, 
               dt_s_1, dt_s_2, dt_s_3)) %>%
  mutate(., datetime = dmy_hms(paste(date, time))) %>%
  mutate(., salinity = case_when(tank == "Tank_1" ~ 35,
                                 tank == "Tank_2" ~ 34,
                                 tank == "Tank_3" ~ 35,
                                 tank == "Tank_4" ~ 35,
                                 tank == "Tank_5" ~ 34,
                                 tank == "Tank_6" ~ 35)) %>%
  group_by(., treatment, tank) %>% arrange(., .by_group = TRUE) %>% ungroup(.) %>%
  pivot_longer(., cols = c(perc_air_sat_1, perc_air_sat_2, perc_air_sat_3), names_to = "og_perc", values_to = "perc_air_sat") %>%
  pivot_longer(., cols = c(temp_C_1, temp_C_2, temp_C_3), names_to = "og_temp", values_to = "temp_C") %>%
  pivot_longer(., cols = c(pressure_mbar_1, pressure_mbar_2, pressure_mbar_3), names_to = "og_pressure", values_to = "pressure_mbar") %>%
  mutate(., og_perc = gsub("perc_air_sat_", replacement = "", x = og_perc)) %>%
  mutate(., og_temp = gsub("temp_C_", replacement = "", x = og_temp)) %>%
  mutate(., og_pressure = gsub("pressure_mbar_", replacement = "", x = og_pressure)) %>%
  filter(., og_perc == og_temp) %>% filter(og_temp == og_pressure) %>%
  dplyr::rename(., probe_num = og_perc) %>%
  select(., -c(og_temp, og_pressure))
#Remove extraneous columns. Use case_when to combine date information across the different probes. Remove any rows without date. Repeat case_when series for time and delta time. Remove extraneous columns. Create a new datetime column for easy plotting. Add salinity information for all tanks based on lab notebook posts. Arrange by treatment and tank. Pivot all air saturation, temperature, and pressure columns, keeping the original column name as a new columm. Remove text before numbers and match based on probe numbers. Rename one column as the probe number and remove the other temperature and pressure columns.
head(dat20220726mod)
```

```{r}
dat20220726mod <- dat20220726mod %>%
  mutate(., DO_umol_L = conv_o2(o2 = perc_air_sat, from = "percent_a.s.",
                                to = "umol_per_l",
                                temp = temp_C,
                                sal = salinity,
                                atm_pres = pressure_mbar)) #Create a new DO variable in units umol/L from %saturation using the function conv_o2() in the respirometry package
head(dat20220726mod)
```

# Initial figure

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Reds")[7],
                brewer.pal(9, "Greys")[7],
                brewer.pal(9, "Blues")[7]) #Create color scheme
```

## 2022-07-08

```{r}
dat20220708mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-08-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2022-07-12

```{r}
dat20220712mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-12-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2022-07-19

```{r}
dat20220719mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-19-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

## 2022-07-26

```{r}
dat20220726mod %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_line(y = 80, lty = 1, color = "grey50") +
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(60, 110, 10), 
                     limits = c(60, 110)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Plot raw air saturation values and add a line for 80% saturation. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. This provides two columns per treatment.
ggsave("figures/2022-07-26-perc-air-sat-raw.pdf", height = 8.5, width = 11)
```

# Clean data

## 2022-07-08

```{r}
dat20220708mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
```

Tank 1 has some weird anomalies...

```{r}
dat20220708mod %>%
  filter(., tank == "tank1") %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (s)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

...and so does Tank 6

```{r}
dat20220708mod %>%
  filter(., tank == "tank6") %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  ggplot(., mapping = aes(x = (dt_s), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scales = "free_x") +
  xlab("Time (s)") + ylab("Oxygen Air Saturation (%)") +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line())
```

These are likely due to air bubbles or starting recording before the crabs were fully set up. I am going to remove these measurements.

```{r}
dat20220708clean <- dat20220708mod %>%
  filter(., perc_air_sat <= 100) %>% 
  group_by(tank, probe_num) %>%
  filter(., cumsum(perc_air_sat <= 80) == 0) %>%
  ungroup(.) %>%
  filter(., !(tank == "tank1" & probe_num == 1 & dt_s < 870)) %>%
  filter(., !(tank == "tank1" & probe_num == 2 & dt_s < 1125)) %>%
  filter(., !(tank == "tank1" & probe_num == 3 & dt_s < 1216)) %>%
  filter(., !(tank == "tank3" & probe_num == 3 & dt_s < 35)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 1, dt_s - 870, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 2, dt_s - 1125, dt_s)) %>%
  mutate(., dt_s = ifelse(tank == "tank1" & probe_num == 3, dt_s - 1216, dt_s)) %>%
  ggplot(., mapping = aes(x = (dt_s/60), y = perc_air_sat, color = treatment)) +
  geom_point(size = 0.5) +
  geom_smooth(method = lm, se = FALSE, lty = 1, color = "grey50")+
  facet_grid(cols = vars(treatment, tank), rows = vars(probe_num), scale = "free_x") +
  xlab("Time (min)") + ylab("Oxygen Air Saturation (%)") +
 scale_x_continuous(breaks = c(0, 5, 10, 15, 20, 30, 60, 90)) +
  scale_y_continuous(breaks = seq(80, 100, 10), 
                     limits = c(80, 100)) +
  scale_color_manual(values = c(plotColors[2], plotColors[1], plotColors[3]), 
                     name = "Temperature (ºC)",
                     breaks = c("13C", "30C", "5C"),
                     labels = c("13", "30", "5")) +
  theme_classic(base_size = 15) + theme(strip.text = element_blank(),
                                        axis.line = element_line()) #Filter all air saturation values above 100. Group by tank and probe. Create a conditional to remove all rows after perc_air_sat reaches 80 for the first time. perc_air_sat <= 80 is a logical vector, where TRUE = 0 and FALSE = 80. cumsum calculates the cumulative sum of the logical vector. Once perc_air_sat <= 80 is FALSE, a 1 gets recorded for the cumsum. This effectively removes all rows after 80 is hit for the first time. Check for values where tank == tank 1, probe_num == 1, and dt_s <= 870 Use the sub-conditions in parentheses and negate the condition with ! to retain all rows that don't meet this condition, but modify values for tank 1, probe 1. Do something similar such that tank 1, probe 2 starts at 1125 and tank 1, probe 3 starts at dt_s = 1216. Use an ifelse statement within mutate to change dt_s for tank 1 based on the actual dt_s start time. Modify x and y axis labels, y axis breaks. Facet such that each column is a treatment/tank, and each row is a probe. Use scales = free_x to have x-axes that vary across tanks. This provides two columns per treatment.
dat20220708clean
ggsave("figures/2022-07-08-perc-air-sat-clean.pdf", height = 8.5, width = 11)
```

